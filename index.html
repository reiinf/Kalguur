<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü v0.008</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root{--gold:#c8a96e;--gold-b:#f0d080;--gold-d:#8a6a2e;--blood:#8b1a1a;--blood-b:#c0392b;--bg0:#0a0806;--bg1:#110e09;--bg2:#1a1510;--bg3:#1f1912;--bg4:#241d14;--brd:#3a2e1e;--brd-g:#5a4a2a;--txt:#d4c4a0;--txt-d:#8a7a60;--txt-b:#f0e0b0;--mag:#8888ff;--rare:#f0d060;--uniq:#cc6820;--norm:#b0b0b0;--grn:#4a9a4a;--cyn:#4ab0b0;--red:#c03030;--org:#cc7700;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg0);color:var(--txt);font-family:'Crimson Pro',Georgia,serif;font-size:16px;font-weight:400;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(100,60,10,.15) 0%,transparent 70%);}
#app{position:relative;z-index:1;max-width:1440px;margin:0 auto;padding:8px;}
header{text-align:center;padding:12px 0 8px;border-bottom:1px solid var(--brd-g);margin-bottom:10px;position:relative;}
header::after{content:'‚öô –ú–ê–®–ò–ù–ê –ö–ê–õ–¨–ì–£–†–ê ‚öô';position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);background:var(--bg0);padding:0 10px;font-family:'Cinzel',serif;font-size:9px;color:var(--gold-d);letter-spacing:3px;}
h1{font-family:'Cinzel',serif;font-size:22px;font-weight:900;color:var(--gold);text-shadow:0 0 25px rgba(200,169,110,.4);letter-spacing:4px;display:flex;align-items:center;justify-content:center;gap:10px;}
.ver{font-size:10px;color:var(--gold-d);border:1px solid var(--gold-d);padding:2px 6px;letter-spacing:2px;font-weight:400;}
.sub{font-size:10px;color:var(--txt-d);letter-spacing:2px;margin-top:2px;font-style:italic;}
#res-bar{display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap;}
.ri{background:var(--bg3);border:1px solid var(--brd);padding:4px 10px;display:flex;align-items:center;gap:6px;font-family:'Cinzel',serif;font-size:13px;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);}
.ri-ico{font-size:17px;}.ri-lbl{color:var(--txt-d);font-size:11px;letter-spacing:1px;display:block;}.ri-val{color:var(--gold);font-weight:600;}
#atlas-bar{background:var(--bg3);border:1px solid var(--brd-g);padding:5px 12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:11px;flex-wrap:wrap;}
.pt-lbl{font-family:'Cinzel',serif;color:var(--gold-d);letter-spacing:1px;font-size:11px;white-space:nowrap;}
.pt-tiers{display:flex;gap:2px;flex-wrap:wrap;}
.pt-t{width:16px;height:10px;background:var(--bg2);border:1px solid var(--brd);font-size:7px;display:flex;align-items:center;justify-content:center;color:var(--txt-d);}
.pt-t.done{background:var(--gold-d);border-color:var(--gold);color:var(--bg0);}
#layout{display:grid;grid-template-columns:310px 1fr 285px;gap:8px;align-items:start;}
.panel{background:var(--bg3);border:1px solid var(--brd);padding:10px;position:relative;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-d),transparent);}
.ptitle{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;gap:6px;}
.tabs{display:flex;gap:1px;margin-bottom:8px;border-bottom:1px solid var(--brd);flex-wrap:wrap;}
.tab-btn{background:transparent;border:none;color:var(--txt-d);font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;padding:5px 9px;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-1px;}
.tab-btn:hover{color:var(--txt);}.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}
.tabpanel{display:none;}.tabpanel.active{display:block;}
.mcard{background:var(--bg4);border:1px solid var(--brd);padding:6px 9px;margin-bottom:4px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.mcard:hover{border-color:var(--gold-d);}.mcard.sel{border-color:var(--gold);box-shadow:0 0 7px rgba(200,169,110,.2);}.mcard.cursed{border-color:#9944cc;}
.mtier{font-family:'Cinzel',serif;font-size:9px;font-weight:900;width:22px;text-align:center;}.mname{flex:1;font-size:13px;color:var(--txt-b);}.mcnt{background:var(--bg2);border:1px solid var(--brd);padding:1px 5px;font-size:10px;font-family:'Cinzel',serif;}
.mch-wrap{display:flex;align-items:center;gap:3px;margin-top:2px;}.mch-bg{flex:1;height:2px;background:var(--bg2);}.mch-fill{height:100%;}.mch-pct{font-size:11px;font-family:'Cinzel',serif;min-width:26px;text-align:right;}
.run-vis{background:var(--bg4);border:1px solid var(--brd);min-height:140px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.run-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 80%,rgba(80,20,0,.3) 0%,transparent 70%);}
.run-con{position:relative;z-index:1;text-align:center;padding:8px;}.run-nm{font-family:'Cinzel',serif;font-size:17px;color:var(--gold);margin-bottom:4px;}
.prog-wrap{margin:4px 0;}.prog-lbl{font-size:9px;color:var(--txt-d);margin-bottom:2px;display:flex;justify-content:space-between;}
.prog-bar{height:6px;background:var(--bg2);border:1px solid var(--brd);overflow:hidden;position:relative;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));transition:width .1s linear;}
.prog-fill.red{background:linear-gradient(90deg,#882200,#ff4400);}.prog-fill.grn{background:linear-gradient(90deg,#1a5a1a,#4a9a4a);}.prog-fill.purple{background:linear-gradient(90deg,#330066,#9900ff);}
.btn{background:linear-gradient(180deg,rgba(200,169,110,.15),rgba(200,169,110,.05));border:1px solid var(--gold-d);color:var(--gold);font-family:'Cinzel',serif;font-size:12px;letter-spacing:1px;padding:8px 14px;cursor:pointer;transition:all .2s;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%);}
.btn:hover:not(:disabled){background:linear-gradient(180deg,rgba(200,169,110,.3),rgba(200,169,110,.1));border-color:var(--gold);box-shadow:0 0 10px rgba(200,169,110,.2);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-r{border-color:var(--blood);color:#ff6666;background:linear-gradient(180deg,rgba(139,26,26,.2),rgba(139,26,26,.05));}.btn-r:hover:not(:disabled){border-color:var(--blood-b);}
.btn-g{border-color:#2a6a2a;color:#6acf6a;background:linear-gradient(180deg,rgba(26,80,26,.2),rgba(26,80,26,.05));}.btn-g:hover:not(:disabled){border-color:#4a9a4a;}
.btn-p{border-color:#553388;color:#bb66ff;background:linear-gradient(180deg,rgba(85,51,136,.2),rgba(85,51,136,.05));}.btn-p:hover:not(:disabled){border-color:#aa66ff;}
.btn-sm{padding:4px 11px;font-size:11px;}
.wslot{background:var(--bg4);border:1px solid var(--brd);padding:8px 9px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.wavat{width:32px;height:32px;border-radius:50%;border:2px solid var(--brd);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.winfo{flex:1;min-width:0;}.wname{font-size:14px;color:var(--txt-b);}.wcls{font-size:10px;color:var(--txt-d);letter-spacing:1px;}
.wst{font-size:10px;padding:1px 5px;border:1px solid;letter-spacing:1px;font-family:'Cinzel',serif;}
.st-idle{color:var(--txt-d);border-color:var(--brd);}.st-run{color:var(--grn);border-color:var(--grn);animation:pg 2s infinite;}.st-cap{color:var(--red);border-color:var(--red);animation:pr 1.5s infinite;}.st-inj{color:var(--org);border-color:var(--org);}.st-exp{color:#bb66ff;border-color:#553388;animation:pg 2s infinite;}
@keyframes pg{0%,100%{opacity:1}50%{opacity:.6}}@keyframes pr{0%,100%{opacity:1;box-shadow:0 0 4px rgba(200,50,50,.3)}50%{opacity:.7;box-shadow:none}}
.wxp{height:2px;background:var(--bg2);margin-top:3px;}.wxp-f{height:100%;background:linear-gradient(90deg,#553388,#aa66ff);}
.lvl-b{display:inline-block;background:rgba(170,100,255,.15);border:1px solid #553388;color:#aa66ff;font-family:'Cinzel',serif;font-size:11px;padding:1px 4px;margin-left:3px;}
#loot-log{background:var(--bg4);border:1px solid var(--brd);height:150px;overflow-y:auto;padding:4px 8px;font-size:13px;display:flex;flex-direction:column-reverse;gap:1px;}
#loot-log::-webkit-scrollbar{width:3px;}#loot-log::-webkit-scrollbar-thumb{background:var(--gold-d);}
.le{padding:1px 0;border-bottom:1px solid rgba(255,255,255,.03);}
.ge{color:var(--gold);}.i-n{color:var(--norm);}.i-m{color:var(--mag);}.i-r{color:var(--rare);}.i-u{color:var(--uniq);}.ev{color:#ff8844;font-style:italic;}.info{color:var(--cyn);}.lt{color:var(--txt-d);margin-right:3px;font-size:8px;}
.igrid{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;max-height:300px;overflow-y:auto;}
.igrid::-webkit-scrollbar{width:3px;}
.iico{background:var(--bg4);border:1px solid var(--brd);aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;transition:all .15s;position:relative;}
.iico:hover{transform:scale(1.08);}
.iico.n{border-color:#444;}.iico.m{border-color:#5555aa;}.iico.r{border-color:#aaaa00;}.iico.u{border-color:#803000;}
.isp{position:absolute;bottom:1px;right:2px;font-size:8px;color:var(--gold-d);font-family:'Cinzel',serif;}
#tt{position:fixed;background:var(--bg1);border:1px solid var(--gold-d);padding:8px 12px;max-width:260px;pointer-events:none;z-index:9999;display:none;font-size:11px;box-shadow:0 0 18px rgba(0,0,0,.9);}
.tt-nm{font-family:'Cinzel',serif;font-size:16px;margin-bottom:4px;}.tt-ty{font-size:8px;color:var(--txt-d);margin-bottom:4px;letter-spacing:1px;border-bottom:1px solid var(--brd);padding-bottom:3px;}
.tt-st{color:var(--mag);padding:2px 0;font-size:14px;}.tt-dv{border:none;border-top:1px solid var(--brd);margin:4px 0;}.tt-sm{font-size:11px;color:var(--txt-d);line-height:1.7;}.tt-sv{color:var(--gold-d);font-size:9px;margin-top:2px;}
.srow{background:var(--bg4);border:1px solid var(--brd);padding:7px 9px;margin-bottom:3px;display:flex;align-items:center;gap:7px;}
.si{flex:1;}.snm{font-size:14px;color:var(--txt-b);}.sds{font-size:11px;color:var(--txt-d);margin-top:1px;}.spr{color:var(--gold);font-family:'Cinzel',serif;font-size:12px;white-space:nowrap;}
#notif-area{position:fixed;top:70px;right:14px;z-index:9500;display:flex;flex-direction:column;gap:4px;max-width:270px;}
.notif{background:var(--bg1);border:1px solid var(--gold-d);padding:7px 11px;font-size:10px;animation:sli .3s ease,fao .5s ease 2.5s forwards;}
.notif.red{border-color:var(--blood-b);color:#ff8888;}.notif.grn{border-color:var(--grn);color:#88ff88;}.notif.pur{border-color:#aa66ff;color:#cc99ff;}
@keyframes sli{from{transform:translateX(100%);opacity:0}to{transform:none;opacity:1}}@keyframes fao{to{opacity:0;transform:translateX(18px)}}
.eqsl{background:var(--bg2);border:1px dashed var(--brd);padding:4px 6px;font-size:8px;color:var(--txt-d);min-height:30px;cursor:pointer;display:flex;flex-direction:column;gap:2px;transition:all .15s;}
.eqsl:hover{border-color:var(--gold-d);}.eqsl.filled{border-style:solid;border-color:var(--brd);color:var(--txt);}
.eqlbl{font-size:7px;color:var(--txt-d);letter-spacing:1px;}
#moverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:none;align-items:center;justify-content:center;}
#moverlay.on{display:flex;}
#mbox{background:var(--bg3);border:1px solid var(--gold-d);padding:16px;max-width:480px;width:92%;max-height:85vh;overflow-y:auto;box-shadow:0 0 35px rgba(0,0,0,.9);}
#mbox::-webkit-scrollbar{width:3px;}#mbox::-webkit-scrollbar-thumb{background:var(--gold-d);}
.mtl{font-family:'Cinzel',serif;font-size:14px;color:var(--gold);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--brd);}
@keyframes fup{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-50px);opacity:0}}
.fl{position:fixed;pointer-events:none;font-family:'Cinzel',serif;font-size:12px;z-index:9999;animation:fup 1.2s ease forwards;}
.sep{border:none;border-top:1px solid var(--brd);margin:6px 0;}.dim{color:var(--txt-d);}.gt{color:var(--gold);}.rt{color:var(--red);}.grnt{color:var(--grn);}.tiny{font-size:11px;color:var(--txt-d);}.dp{color:var(--mag);}.dn{color:var(--red);}
#self-sec{background:var(--bg4);border:1px solid var(--brd-g);padding:8px;margin-bottom:8px;}
.act-card{background:var(--bg4);border:1px solid var(--brd);padding:8px 9px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.act-pg{height:3px;background:var(--bg2);margin-top:3px;}.act-pgf{height:100%;background:var(--grn);transition:width .1s;}
#atlas-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.at-cell{background:var(--bg4);border:1px solid var(--brd);padding:6px 4px;text-align:center;}
.at-cell.done{border-color:var(--gold-d);background:rgba(200,169,110,.08);}.at-cell.locked{opacity:.4;}
.ach-row{background:var(--bg4);border:1px solid var(--brd);padding:7px 9px;margin-bottom:3px;display:flex;align-items:center;gap:8px;}
.ach-row.done{border-color:var(--gold-d);background:rgba(200,169,110,.06);}
.ach-ico{font-size:20px;width:28px;text-align:center;flex-shrink:0;}
.ach-nm{font-size:13px;color:var(--txt-b);}.ach-ds{font-size:11px;color:var(--txt-d);}.ach-rw{font-size:11px;color:var(--gold-d);}
#dbg-out{background:var(--bg0);border:1px solid #333;padding:8px;font-family:monospace;font-size:9px;color:#88ff88;max-height:400px;overflow-y:auto;line-height:1.6;}
</style>
</head>
<body>
<div id="app">
<header>
  <h1>–ö–ê–†–¢–û–•–û–î–ï–¶ <span class="ver">v0.008</span></h1>
</header>
<div id="res-bar">
  <div class="ri"><span class="ri-ico">üí∞</span><div><span class="ri-lbl">–ó–û–õ–û–¢–û</span><span class="ri-val" id="r-gold">0</span></div></div>
  <div class="ri"><span class="ri-ico">üó∫</span><div><span class="ri-lbl">–ö–ê–†–¢–´</span><span class="ri-val" id="r-maps">0</span></div></div>
  <div class="ri"><span class="ri-ico">‚öîÔ∏è</span><div><span class="ri-lbl">–ü–†–ï–î–ú–ï–¢–´</span><span class="ri-val" id="r-items">0</span></div></div>
  <div class="ri"><span class="ri-ico">üë•</span><div><span class="ri-lbl">–†–ê–ë–û–¢–ù–ò–ö–ò</span><span class="ri-val" id="r-workers">0</span></div></div>
  <div class="ri"><span class="ri-ico">üîÑ</span><div><span class="ri-lbl">–ü–†–û–ô–î–ï–ù–û</span><span class="ri-val" id="r-runs">0</span></div></div>
  <div class="ri" id="ri-pres" style="display:none"><span class="ri-ico">‚ú®</span><div><span class="ri-lbl">–ü–†–ï–°–¢–ò–ñ</span><span class="ri-val" id="r-pres">0</span></div></div>
</div>
<div id="atlas-bar">
  <span class="pt-lbl">–ê–¢–õ–ê–°:</span>
  <div class="pt-tiers" id="pt-tiers"></div>
  <span id="pt-hint" class="dim" style="font-size:9px;margin-left:4px"></span>
</div>
<div id="layout">
<!-- LEFT -->
<div>
  <div class="panel">
    <div class="tabs">
      <button class="tab-btn active" data-tab="maps">üó∫ –ö–ê–†–¢–´</button>
      <button class="tab-btn" data-tab="shop">üè™ –õ–ê–í–ö–ê</button>
      <button class="tab-btn" data-tab="inv">üéí –°–ö–õ–ê–î</button>
      <button class="tab-btn" data-tab="acts">üèï –ê–ö–¢–´</button>
      <button class="tab-btn" data-tab="atlas">üåê –ê–¢–õ–ê–°</button>
      <button class="tab-btn" data-tab="ach">üèÜ –ê–†–•–ò–í</button>
    </div>
    <div id="tab-maps" class="tabpanel active"></div>
    <div id="tab-shop" class="tabpanel"></div>
    <div id="tab-inv" class="tabpanel"></div>
    <div id="tab-acts" class="tabpanel"></div>
    <div id="tab-atlas" class="tabpanel"></div>
    <div id="tab-ach" class="tabpanel"></div>
  </div>
</div>
<!-- CENTER -->
<div>
  <div id="self-sec">
    <div class="ptitle">üßô –í–´ ‚Äî –ò–ó–ì–ù–ê–ù–ù–ò–ö <span id="self-cls-badge" style="font-size:10px;color:var(--txt-d)"></span></div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
      <div><div class="tiny">–ö–õ–ê–°–°</div><div style="display:flex;gap:4px;margin-top:2px" id="cls-btns">
        <button class="btn btn-sm" data-cls="warrior" id="cls-warrior">‚öîÔ∏è –í–æ–∏–Ω</button>
        <button class="btn btn-sm" data-cls="mage" id="cls-mage">üîÆ –ú–∞–≥</button>
        <button class="btn btn-sm" data-cls="ranger" id="cls-ranger">üèπ –°–ª–µ–¥–æ–ø—ã—Ç</button>
      </div></div>
      <div style="margin-left:auto"><button class="btn btn-sm" id="btn-self-eq">üéí –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</button></div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div><div class="tiny">‚öîÔ∏è –£–†–û–ù</div><div class="gt" style="font-family:'Cinzel',serif;font-size:16px" id="s-dmg">5</div></div>
      <div><div class="tiny">üõ° –í–´–ñ–ò–í–ê–ï–ú–û–°–¢–¨</div><div class="grnt" style="font-family:'Cinzel',serif;font-size:16px" id="s-surv">10</div></div>
      <div><div class="tiny">‚úÖ –®–ê–ù–°</div><div style="font-family:'Cinzel',serif;font-size:13px" id="s-ch">‚Äî</div></div>
      <div><div class="tiny">‚≠ê –£–†–û–í–ï–ù–¨</div><div style="display:flex;align-items:center;gap:4px"><span class="gt" style="font-family:'Cinzel',serif;font-size:16px" id="s-lvl">0</span><button class="btn btn-sm btn-p" id="btn-self-lvlup" style="display:none;padding:1px 6px;font-size:11px">+</button></div></div>
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">üåÄ –ü–û–†–¢–ê–õ –ö–ê–†–¢–´</div>
    <div class="run-vis"><div class="run-bg"></div><div class="run-con" id="run-con"><div class="dim" style="font-style:italic">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Å–ª–µ–≤–∞</div></div></div>
    <div class="prog-wrap" id="rpw" style="display:none">
      <div class="prog-lbl"><span id="rpl">–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="rpp">0%</span></div>
      <div class="prog-bar"><div class="prog-fill" id="rpf" style="width:0%"></div></div>
    </div>
    <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:6px">
      <button class="btn" id="btn-self-run">‚öî –ü—Ä–æ–π—Ç–∏ —Å–∞–º–æ–º—É</button>
      <button class="btn btn-r" id="btn-cancel-run" style="display:none">‚úñ –û—Ç—Å—Ç—É–ø–∏—Ç—å</button>
    </div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üë• –†–ê–ë–û–¢–ù–ò–ö–ò <button class="btn btn-sm btn-p" id="btn-expedition">üó∫ –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è</button></div>
    <div id="workers-list"></div>
    <div style="margin-top:7px"><button class="btn" id="btn-hire">+ –ù–∞–Ω—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</button></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üìú –ñ–£–†–ù–ê–õ</div>
    <div id="loot-log"></div>
  </div>
</div>
<!-- RIGHT -->
<div>
  <div class="panel">
    <div class="ptitle">‚öô –ú–ê–®–ò–ù–ê –ö–ê–õ–¨–ì–£–†–ê</div>
    <div id="upgrades"></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê <button class="btn btn-sm" id="btn-debug" style="font-size:7px">üîß –î–ï–ë–ê–ì</button></div>
    <div id="stats-p" style="font-size:10px;line-height:2.1"></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">‚ö†Ô∏è –û–ü–ê–°–ù–û</div>
    <button class="btn btn-r" style="width:100%" id="btn-reset">üíÄ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  </div>
</div>
</div>
</div>
<div id="tt"></div>
<div id="moverlay"><div id="mbox"><div class="mtl" id="mtl"></div><div id="mbd"></div></div></div>
<div id="notif-area"></div>
<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAP_TIERS=[
  {t:1,nm:'–†–∞–≤–Ω–∏–Ω—ã –ö–∞–ª—å–≥—É—Ä–∞',    em:'üåæ',time:8, g:[12,28],  drop:.28,md:.08,mx:2, dgr:22},
  {t:2,nm:'–¢—É–º–∞–Ω–Ω—ã–π –±–µ—Ä–µ–≥',      em:'üåä',time:9, g:[18,38],  drop:.30,md:.09,mx:3, dgr:35},
  {t:3,nm:'–ì–Ω–∏–ª—ã–µ –±–æ–ª–æ—Ç–∞',       em:'üåø',time:10,g:[25,55],  drop:.32,md:.10,mx:4, dgr:52},
  {t:4,nm:'–ö–∞–º–µ–Ω–Ω—ã–µ —à–∞—Ö—Ç—ã',      em:'‚õèÔ∏è',time:12,g:[34,72],  drop:.34,md:.11,mx:5, dgr:73},
  {t:5,nm:'–ü—Ä–æ–∫–ª—è—Ç—ã–π –ª–µ—Å',       em:'üå≤',time:13,g:[46,92],  drop:.36,md:.12,mx:6, dgr:98},
  {t:6,nm:'–†—É–∏–Ω—ã –°–∞—Ä–Ω–∞—Ç',        em:'üèõÔ∏è',time:15,g:[60,120], drop:.38,md:.13,mx:7, dgr:128},
  {t:7,nm:'–¶–∏—Ç–∞–¥–µ–ª—å —Ç–µ–Ω–µ–π',      em:'üè∞',time:17,g:[78,150], drop:.40,md:.14,mx:8, dgr:163},
  {t:8,nm:'–õ–µ–¥—è–Ω—ã–µ –ø—É—Å—Ç–æ—à–∏',     em:'‚ùÑÔ∏è',time:18,g:[100,190],drop:.42,md:.15,mx:9, dgr:203},
  {t:9,nm:'–í—É–ª–∫–∞–Ω –ö–∞–ª—å–≥—É—Ä–∞',     em:'üåã',time:20,g:[130,240],drop:.44,md:.16,mx:10,dgr:248},
  {t:10,nm:'–ù–µ–∫—Ä–æ–ø–æ–ª—å –í–∞–∞—Å–∞',    em:'üíÄ',time:22,g:[165,290],drop:.46,md:.16,mx:11,dgr:298},
  {t:11,nm:'–•—Ä–∞–º –õ—É–Ω—ã',          em:'üåô',time:25,g:[210,360],drop:.48,md:.17,mx:12,dgr:354},
  {t:12,nm:'–ê—Å—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å',em:'‚ú®',time:28,g:[265,440],drop:.50,md:.18,mx:13,dgr:416},
  {t:13,nm:'–õ–∞–±–∏—Ä–∏–Ω—Ç –ó–∞–±–≤–µ–Ω–∏—è',  em:'üåÄ',time:30,g:[330,540],drop:.52,md:.19,mx:14,dgr:484},
  {t:14,nm:'–ë–µ–∑–¥–Ω–∞ –•–∞–æ—Å–∞',       em:'üî•',time:33,g:[405,660],drop:.55,md:.20,mx:15,dgr:558},
  {t:15,nm:'–°–µ—Ä–¥—Ü–µ –ö–∞—Ç–∞–∫–ª–∏–∑–º–∞',  em:'‚ö°',time:36,g:[500,810],drop:.58,md:.22,mx:16,dgr:638},
  {t:16,nm:'–®–ï–ô–ü–ï–†–ó REALM',      em:'üí´',time:40,g:[630,1000],drop:.62,md:.25,mx:16,dgr:725},
];
const WCLS={
  warrior:{nm:'–í–æ–∏–Ω',    em:'‚öîÔ∏è',col:'#cc4444',desc:'–í—ã—Å–æ–∫–æ–µ –•–ü –∏ –±—Ä–æ–Ω—è.'},
  mage:   {nm:'–ú–∞–≥',     em:'üîÆ',col:'#8888ff',desc:'–í—ã—Å–æ–∫–∏–π —É—Ä–æ–Ω –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è–º–∏.'},
  ranger: {nm:'–°–ª–µ–¥–æ–ø—ã—Ç',em:'üèπ',col:'#44cc88',desc:'–ë—ã—Å—Ç—Ä—ã–π, —É–∫–ª–æ–Ω—è–µ—Ç—Å—è.'},
};
const WNAMES=['–•–∞—Ä–∞–ª—å–¥','–°–∏–≥—Ä–∏–¥','–¢–æ—Ä–≤–∞–ª—å–¥','–ê—Å—Ç—Ä–∏–¥','–†–∞–≥–Ω–∞—Ä','–•–∏–ª—å–¥–∞','–≠–π–Ω–∞—Ä','–§—Ä–µ–π—è','–ë—å—ë—Ä–Ω','–ò–Ω–≥—Ä–∏–¥','–ì—É–Ω–Ω–∞—Ä','–ë—Ä—É–Ω—Ö–∏–ª—å–¥','–°–≤–µ–π–Ω','–û–ª–∞—Ñ','–ú–∞–≥–Ω—É—Å','–õ–µ–π—Ñ','–•–µ–ª—å–≥–∞','–ò–≤–∞—Ä'];
const ACTS=[
  {id:'a1',nm:'–ê–∫—Ç 1: –ó–æ–Ω–∞ –Ω–æ–≤–∏—á–∫–æ–≤',em:'üèï',time:20,g:[3,8]},
  {id:'a2',nm:'–ê–∫—Ç 2: –õ–∞–≥–µ—Ä—å –±—Ä–æ–¥—è–≥',em:'üåÑ',time:30,g:[6,14]},
  {id:'a3',nm:'–ê–∫—Ç 3: –ü–æ–ª—è —Å—Ä–∞–∂–µ–Ω–∏–π',em:'üó°Ô∏è',time:45,g:[10,22]},
];
const WLVLS=[0,50,150,350,750,1500,3000,5500,9000,14000,21000];
const SLOTS=['weapon','armor','helmet','ring'];
const SLOTNM={weapon:'‚öîÔ∏è –û—Ä—É–∂–∏–µ',armor:'üõ°Ô∏è –ë—Ä–æ–Ω—è',helmet:'‚õëÔ∏è –®–ª–µ–º',ring:'üíç –ö–æ–ª—å—Ü–æ'};
const STATNM={dmgPhys:'–§–∏–∑. —É—Ä–æ–Ω',dmgSpell:'–£—Ä–æ–Ω –∑–∞–∫–ª–∏–Ω.',dmgArea:'–£—Ä–æ–Ω –ø–æ –æ–±–ª–∞—Å—Ç–∏',minionDmg:'–£—Ä–æ–Ω –ø—Ä–∏–∑—ã–≤–æ–≤',critChance:'–®–∞–Ω—Å –∫—Ä–∏—Ç–∞',critMult:'–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫—Ä–∏—Ç–∞',critSpell:'–ö—Ä–∏—Ç –∑–∞–∫–ª–∏–Ω.',castSpd:'–°–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Å—Ç–∞',atkSpd:'–°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏',str:'–°–∏–ª–∞',int:'–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',dex:'–õ–æ–≤–∫–æ—Å—Ç—å',hp:'–û—á–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è',energyShield:'–≠–Ω–µ—Ä–≥–æ—â–∏—Ç',armor:'–ë—Ä–æ–Ω—è',evasion:'–£–∫–ª–æ–Ω–µ–Ω–∏–µ',blockChance:'–®–∞–Ω—Å –±–ª–æ–∫–∞',allRes:'–í—Å–µ —Å–æ–ø—Ä.',fireRes:'–û–≥–Ω. —Å–æ–ø—Ä.',coldRes:'–•–æ–ª. —Å–æ–ø—Ä.',moveSpd:'–°–∫–æ—Ä. –¥–≤–∏–∂–µ–Ω–∏—è'};
const CDMG={warrior:['dmgPhys','dmgArea','critChance','critMult','atkSpd','str'],mage:['dmgSpell','minionDmg','critSpell','castSpd','int'],ranger:['dmgPhys','critChance','critMult','atkSpd','dex']};
const CSURV={warrior:['armor','hp','blockChance','str','allRes','fireRes'],mage:['energyShield','int','allRes'],ranger:['evasion','hp','dex','allRes','coldRes']};
const IBASES=[
  {nm:'–î–ª–∏–Ω–Ω—ã–π –º–µ—á',     em:'üó°Ô∏è',cls:'warrior',slot:'weapon',mods:['dmgPhys','critChance','atkSpd','str']},
  {nm:'–ë–æ–µ–≤–æ–π —Ç–æ–ø–æ—Ä',    em:'ü™ì',cls:'warrior',slot:'weapon',mods:['dmgPhys','dmgArea','str','atkSpd']},
  {nm:'–î–≤—É—Ä—É—á–Ω—ã–π –º–æ–ª–æ—Ç', em:'üî®',cls:'warrior',slot:'weapon',mods:['dmgPhys','dmgArea','str','critMult']},
  {nm:'–°—Ç–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫',em:'üõ°',cls:'warrior',slot:'armor',mods:['armor','hp','str','allRes']},
  {nm:'–õ–∞—Ç–Ω—ã–µ –ø–æ–Ω–æ–∂–∏',   em:'ü•æ',cls:'warrior',slot:'armor',mods:['armor','hp','str','fireRes']},
  {nm:'–®–ª–µ–º –ø–∞–ª–∞–¥–∏–Ω–∞',   em:'‚õëÔ∏è',cls:'warrior',slot:'helmet',mods:['armor','hp','str','fireRes']},
  {nm:'–ö–æ–ª—å—Ü–æ –≤–æ–∏–Ω–∞',    em:'üî¥',cls:'warrior',slot:'ring',mods:['hp','str','allRes','armor']},
  {nm:'–ñ–µ–∑–ª —Å–∏–ª—ã',       em:'ü™Ñ',cls:'mage',slot:'weapon',mods:['dmgSpell','castSpd','critSpell','int']},
  {nm:'–ü–æ—Å–æ—Ö –º–∞–≥–∞',      em:'ü¶Ø',cls:'mage',slot:'weapon',mods:['dmgSpell','castSpd','int','energyShield']},
  {nm:'–°–≤–∏—Ç–æ–∫ –ø—Ä–∏–∑—ã–≤–∞',  em:'üìú',cls:'mage',slot:'weapon',mods:['minionDmg','dmgSpell','int','castSpd']},
  {nm:'–ú–∞–Ω—Ç–∏—è –∞—Ä—Ö–∏–º–∞–≥–∞', em:'üß•',cls:'mage',slot:'armor',mods:['energyShield','int','allRes','castSpd']},
  {nm:'–î–∏–∞–¥–µ–º–∞ –º–∞–≥–∞',    em:'üëë',cls:'mage',slot:'helmet',mods:['energyShield','int','critSpell','dmgSpell']},
  {nm:'–ö–æ–ª—å—Ü–æ –∑–Ω–∞–Ω–∏—è',   em:'üîµ',cls:'mage',slot:'ring',mods:['int','dmgSpell','critSpell','allRes']},
  {nm:'–û—Ö–æ—Ç–Ω–∏—á–∏–π –ª—É–∫',   em:'üèπ',cls:'ranger',slot:'weapon',mods:['dmgPhys','atkSpd','dex','critChance']},
  {nm:'–ö–∏–Ω–∂–∞–ª –∞—Å—Å–∞—Å–∏–Ω–∞', em:'üî™',cls:'ranger',slot:'weapon',mods:['dmgPhys','critChance','critMult','dex']},
  {nm:'–î–≤–æ–π–Ω—ã–µ –∫–ª–∏–Ω–∫–∏',  em:'‚ö°',cls:'ranger',slot:'weapon',mods:['dmgPhys','atkSpd','dex','critMult']},
  {nm:'–ö–æ–∂–∞–Ω—ã–π –¥–æ—Å–ø–µ—Ö',  em:'ü•ã',cls:'ranger',slot:'armor',mods:['evasion','dex','hp','allRes']},
  {nm:'–°–∞–ø–æ–≥–∏ –ª–æ–≤–∫–∞—á–∞',  em:'üëü',cls:'ranger',slot:'armor',mods:['evasion','dex','moveSpd','hp']},
  {nm:'–ö–æ–ª—å—Ü–æ –ª–æ–≤–∫–æ—Å—Ç–∏', em:'üü¢',cls:'ranger',slot:'ring',mods:['hp','dex','evasion','coldRes']},
];
const NPFX={warrior:['–ö—Ä–æ–≤–∞–≤—ã–π','–°—Ç–∞–ª—å–Ω–æ–π','–ñ–µ–ª–µ–∑–Ω—ã–π','–Ø—Ä–æ—Å—Ç–Ω—ã–π','–ë–æ–µ–≤–æ–π','–ö–∞–º–µ–Ω–Ω—ã–π'],mage:['–¢—ë–º–Ω—ã–π','–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π','–í–µ—á–Ω—ã–π','–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π','–°—É–º–µ—Ä–µ—á–Ω—ã–π','–ó–≤—ë–∑–¥–Ω—ã–π'],ranger:['–¢–æ—á–Ω—ã–π','–ë—ã—Å—Ç—Ä—ã–π','–õ–µ—Å–Ω–æ–π','–¢–µ–Ω–µ–≤–æ–π','–í–µ—Ç—Ä–µ–Ω—ã–π','–°–∫—Ä—ã—Ç—ã–π'],generic:['–î—Ä–µ–≤–Ω–∏–π','–ü—Ä–æ–∫–ª—è—Ç—ã–π','–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π','–í–µ–ª–∏–∫–∏–π','–ú–æ–≥—É—á–∏–π','–ó–ª–æ–≤–µ—â–∏–π']};
const NSFX={warrior:['–ë–µ—Ä—Å–µ—Ä–∫–µ—Ä–∞','–ü–∞–ª–∞–¥–∏–Ω–∞','–ó–∞—â–∏—Ç–Ω–∏–∫–∞','–í–æ–∏—Ç–µ–ª—è','–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞'],mage:['–ê—Ä—Ö–∏–º–∞–≥–∞','–ß–∞—Ä–æ–¥–µ—è','–ù–µ–∫—Ä–æ–º–∞–Ω—Ç–∞','–ü—Ä–æ–≤–∏–¥—Ü–∞','–ü–æ–≤–µ–ª–∏—Ç–µ–ª—è'],ranger:['–ê—Å—Å–∞—Å–∏–Ω–∞','–°–ª–µ–¥–æ–ø—ã—Ç–∞','–û—Ö–æ—Ç–Ω–∏–∫–∞','–†–∞–∑–≤–µ–¥—á–∏–∫–∞','–°—Ç—Ä–µ–ª–∫–∞'],generic:['–†–æ–∫–∞','–ì–∏–±–µ–ª–∏','–°—É–¥—å–±—ã','–í–µ—á–Ω–æ—Å—Ç–∏','–ó–∞–±–≤–µ–Ω–∏—è']};
const ACHDEFS=[
  {id:'first_run', ico:'üó∫',nm:'–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏',      ds:'–ü—Ä–æ–π—Ç–∏ –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç—É',            rw:'+30üí∞'},
  {id:'t5_clear',  ico:'üå≤',nm:'–ü—Ä–æ–∫–ª—è—Ç—ã–π –ª–µ—Å',    ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T5',                rw:'+50üí∞'},
  {id:'t10_clear', ico:'üíÄ',nm:'–ù–µ–∫—Ä–æ–º–∞–Ω—Ç',         ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T10',               rw:'+150üí∞'},
  {id:'t16_clear', ico:'üí´',nm:'–ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü',        ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T16',               rw:'+500üí∞'},
  {id:'hire3',     ico:'üë•',nm:'–ö–æ–º–∞–Ω–¥–∞',           ds:'–ù–∞–Ω—è—Ç—å 3 —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤',            rw:'+100üí∞'},
  {id:'runs50',    ico:'üîÑ',nm:'–í–µ—Ç–µ—Ä–∞–Ω',           ds:'–ü—Ä–æ–π—Ç–∏ 50 –∫–∞—Ä—Ç',                 rw:'+200üí∞'},
  {id:'runs200',   ico:'‚öîÔ∏è',nm:'–ú–∞—Å—Ç–µ—Ä',           ds:'–ü—Ä–æ–π—Ç–∏ 200 –∫–∞—Ä—Ç',                rw:'+1000üí∞'},
  {id:'items20',   ico:'üéí',nm:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',     ds:'–ù–∞–π—Ç–∏ 20 –ø—Ä–µ–¥–º–µ—Ç–æ–≤',             rw:'+80üí∞'},
  {id:'rare_item', ico:'üåü',nm:'–ü–µ—Ä–≤–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å',  ds:'–ù–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç',           rw:'+60üí∞'},
  {id:'uniq_item', ico:'üíé',nm:'–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å',     ds:'–ù–∞–π—Ç–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç',       rw:'+250üí∞'},
  {id:'sell500',   ico:'üí∞',nm:'–¢–æ—Ä–≥–æ–≤–µ—Ü',          ds:'–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞ 500üí∞',     rw:'+100üí∞'},
  {id:'all16',     ico:'üåê',nm:'–ê—Ç–ª–∞—Å –∑–∞–≤–µ—Ä—à—ë–Ω',   ds:'–ü—Ä–æ–π—Ç–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤',            rw:'–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ü—Ä–µ—Å—Ç–∏–∂'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshG(){
  return {gold:50,totalRuns:0,maps:{1:5,2:2},inv:[],workers:[],
    ups:{slots:0,rescue:0,heal:0},selfEq:{weapon:null,armor:null,helmet:null,ring:null},
    selfRun:null,actRun:null,selMap:null,maxTier:2,
    cleared:{},achs:{},prestige:0,prestigeBonus:0,
    selfCls:null,selfXp:0,selfLevel:0,selfLevelUp:false,clsLocked:false,
    stats:{ge:0,fi:0,mr:0,ar:0,sold:0,sg:0,cap:0,inj:0},
    gt:0,iid:0,wid:0};
}
let G=freshG();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const fN=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':Math.floor(n)+'';
const qcol=q=>({normal:'#b0b0b0',magic:'#8888ff',rare:'#f0d060',unique:'#cc6820'}[q]||'#fff');
const qlbl=q=>({normal:'–û–±—ã—á–Ω—ã–π',magic:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π',rare:'–†–µ–¥–∫–∏–π',unique:'–£–Ω–∏–∫–∞–ª—å–Ω—ã–π'}[q]||q);
const tcol=t=>t<=3?'#aaa':t<=6?'#5599ff':t<=10?'#bb55ff':t<=14?'#ff8844':'#ff4422';
const calcCh=(power,tier)=>{const d=MAP_TIERS[tier-1].dgr;return Math.max(0.03,Math.min(0.97,(power/d-0.2)/0.7));};
const chcol=ch=>ch>=0.8?'#4acf4a':ch>=0.5?'#cfcf4a':ch>=0.25?'#cf8040':'#cf4040';
const iDmg=(it,cls)=>{const r=CDMG[cls]||[];return Math.floor(it.mods.reduce((s,m)=>s+(r.includes(m.stat)?m.value:m.value*.08),0));};
const iSurv=(it,cls)=>{const r=CSURV[cls]||[];return Math.floor(it.mods.reduce((s,m)=>s+(r.includes(m.stat)?m.value:m.value*.08),0));};
const sDmg=()=>{let v=5+G.selfLevel*3;SLOTS.forEach(s=>{if(G.selfEq[s])v+=iDmg(G.selfEq[s],G.selfCls||'warrior');});return v;};
const sSurv=()=>{let v=10+G.selfLevel*3;SLOTS.forEach(s=>{if(G.selfEq[s])v+=iSurv(G.selfEq[s],G.selfCls||'warrior');});return v;};
function recalcW(w){let d=5+w.level*3,s=5+w.level*3;SLOTS.forEach(sl=>{if(w.eq[sl]){d+=iDmg(w.eq[sl],w.cls);s+=iSurv(w.eq[sl],w.cls);}});w.dmg=d;w.surv=s;}
function addXP(w,amt){w.xp+=amt;const mx=WLVLS.length-1;while(w.level<mx&&w.xp>=WLVLS[w.level+1]){w.level++;recalcW(w);log('‚≠ê '+w.name+' ‚Äî –£—Ä.'+w.level+'!','info');showN(w.name+' ‚Äî –£—Ä.'+w.level+'!','pur');}}
const xpAmt=tier=>tier*8+12;
const goldReward=(md,power,mapCost=0)=>{
  const base=Math.max(mapCost, ri(md.g[0],md.g[1]));
  return Math.floor(base*(1+(power*.007)*(1+G.prestigeBonus*.01)));
};
const canPrestige=()=>[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].every(t=>G.cleared[t]);

function genItem(tier,workerCls){
  let pool=IBASES;
  if(workerCls)pool=Math.random()<.72?IBASES.filter(b=>b.cls===workerCls):IBASES;
  if(!pool.length)pool=IBASES;
  const base=pool[Math.floor(Math.random()*pool.length)];
  const r=Math.random();
  const quality=tier>=14&&r<.07?'unique':tier>=5&&r<.24?'rare':r<.58?'magic':'normal';
  const cnt={normal:1,magic:ri(1,2),rare:ri(3,5),unique:4}[quality];
  const qm={normal:1,magic:1.25,rare:1.6,unique:2.2}[quality];
  const mods=[...base.mods].sort(()=>Math.random()-.5).slice(0,cnt).map(stat=>({stat,value:Math.floor((tier*2+ri(3,12))*qm)}));
  const sp=Math.floor({normal:3,magic:8,rare:22,unique:65}[quality]*(1+tier*.35));
  const pfx=NPFX[base.cls]||NPFX.generic,sfx=NSFX[base.cls]||NSFX.generic;
  const name=quality==='normal'?base.nm:quality==='magic'?pfx[ri(0,pfx.length-1)]+' '+base.nm:pfx[ri(0,pfx.length-1)]+' '+base.nm+' '+sfx[ri(0,sfx.length-1)];
  return {id:++G.iid,name,em:base.em,cls:base.cls,slot:base.slot,quality,mods,tier,sellPrice:sp};
}
function tryItem(md,cls,mult=1){if(Math.random()>md.drop*mult)return;const it=genItem(md.t,cls);G.inv.push(it);G.stats.fi++;log(it.em+' <span style="color:'+qcol(it.quality)+'">'+it.name+'</span> ['+qlbl(it.quality)+']','i-'+it.quality[0]);checkAchs();}
function tryMap(md){if(Math.random()>md.md)return;const dt=Math.max(1,Math.min(16,md.t+ri(0,Math.min(3,md.mx-md.t))));if(Math.random()<.12){G.maps['c'+dt]=(G.maps['c'+dt]||0)+1;log('üó∫üíú –ó–∞—Ä–∞–∂—ë–Ω–Ω–∞—è T'+dt+'!','ev');}else{G.maps[dt]=(G.maps[dt]||0)+1;log('üó∫ –ö–∞—Ä—Ç–∞ T'+dt+' —É–ø–∞–ª–∞','info');}renderMaps();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RUNS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selfRun(){
  if(!G.selMap){showN('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É!');return;}
  if(G.selfRun){showN('–£–∂–µ –≤ –ø–æ—Ö–æ–¥–µ!');return;}
  if(G.actRun){showN('–£–∂–µ –≤ –∞–∫—Ç–µ!');return;}
  const cursed=String(G.selMap).startsWith('c');
  const tier=cursed?parseInt(String(G.selMap).slice(1)):parseInt(G.selMap);
  const key=cursed?'c'+tier:tier;
  if(!(G.maps[key]>0)){showN('–ù–µ—Ç –∫–∞—Ä—Ç!');return;}
  G.maps[key]--;
  const md=MAP_TIERS[tier-1];
  const mapCostTbl={1:15,2:35,3:65,4:100,5:140,6:185,7:240,8:310,9:400,10:510,11:640,12:800,13:990,14:1220,15:1500,16:1850};
  G.clsLocked=true;if(!G.selfCls)G.selfCls='warrior';
  G.selfRun={md,tier,cursed,elapsed:0,cost:mapCostTbl[tier]||0};
  document.getElementById('rpw').style.display='block';
  document.getElementById('btn-cancel-run').style.display='inline-block';
  document.getElementById('btn-self-run').disabled=true;
  document.getElementById('rpl').textContent=(cursed?'üíú ':'')+md.em+' '+md.nm+' [T'+tier+']';
  updateRunVis(md);renderMaps();
  log('‚ö° –ü–æ—Ä—Ç–∞–ª: '+(cursed?'üíú –ó–ê–†–ê–ñ–Å–ù–ù–ê–Ø ':'')+'T'+tier+' '+md.nm,'info');
}
function cancelRun(){if(!G.selfRun)return;G.selfRun=null;resetRunUI();log('‚ö† –û—Ç—Å—Ç—É–ø–∏–ª–∏.','ev');}
function resetRunUI(){
  document.getElementById('rpw').style.display='none';
  document.getElementById('btn-cancel-run').style.display='none';
  document.getElementById('btn-self-run').disabled=false;
  const f=document.getElementById('rpf');if(f)f.style.width='0%';
  const p=document.getElementById('rpp');if(p)p.textContent='0%';
}
function completeSelfRun(){
  const {md,tier,cursed}=G.selfRun;
  const power=sDmg()+sSurv();
  const ch=Math.max(.03,calcCh(power,tier)-(cursed?.2:0));
  const ok=Math.random()<ch;
  G.stats.mr++;G.totalRuns++;G.selfRun=null;resetRunUI();
  if(ok){
    const lm=cursed?3:1;
    const g=goldReward(md,power);G.gold+=g;G.stats.ge+=g;
    G.cleared[tier]=true;if(tier>G.maxTier)G.maxTier=tier;
    log('üí∞ –ü—Ä–æ–π–¥–µ–Ω–æ!+'+(g)+'üí∞'+(cursed?' (x3 –ª—É—Ç!)':''),'ge');floatT('+'+g+'üí∞','#f0d080');
    for(let i=0;i<lm;i++)tryItem(md,null,1);tryMap(md);
    checkAchs();renderAtlasBar();renderShop();
  }else{log('üíÄ –í—ã –ø–∞–ª–∏ –≤ T'+tier+(cursed?' [–ó–ê–†–ê–ñ–Å–ù–ù–ê–Ø]':'')+'!','ev');showN('–í—ã –ø–æ–≥–∏–±–ª–∏!','red');}
  if(G.selMap)updateRunVis(MAP_TIERS[tier-1],true);else updateRunVis(null);
  renderMaps();renderInv();updateRes();
}
function updateRunVis(md,idle){
  const el=document.getElementById('run-con');if(!el)return;
  if(!md){el.innerHTML='<div class="dim" style="font-style:italic">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Å–ª–µ–≤–∞</div>';return;}
  const col=tcol(md.t);
  let ch='';if(idle){const c=calcCh(sDmg()+sSurv(),md.t);ch='<div style="margin-top:4px;font-size:10px;color:'+chcol(c)+'">–í–∞—à —à–∞–Ω—Å: '+Math.round(c*100)+'%</div>';}
  el.innerHTML='<div class="run-nm" style="color:'+col+'">'+md.em+' '+md.nm+'</div>'+
    '<div class="dim" style="font-size:9px;letter-spacing:2px;margin-bottom:4px">–ö–ê–†–¢–ê –¢–ò–†–ê '+md.t+'</div>'+
    '<div style="font-size:10px;color:var(--txt-d)">‚è± ~'+md.time+'—Å &nbsp; üí∞ '+md.g[0]+'‚Äì'+md.g[1]+'+–ø—Ä–µ–¥–º–µ—Ç—ã</div>'+ch;
}
function startAct(id){
  if(G.actRun){showN('–£–∂–µ –≤ –∞–∫—Ç–µ!');return;}if(G.selfRun){showN('–£–∂–µ –≤ –ø–æ—Ö–æ–¥–µ!');return;}
  const act=ACTS.find(a=>a.id===id);if(!act)return;
  G.actRun={act,elapsed:0};const btn=document.getElementById('abtn-'+id);if(btn)btn.disabled=true;
  log('üèï –û—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å: '+act.nm,'info');
}
function completeAct(){
  const act=G.actRun.act;const g=ri(act.g[0],act.g[1]);G.gold+=g;G.stats.ge+=g;G.stats.ar++;G.actRun=null;
  log('üèï '+act.nm+' –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî +'+g+'üí∞','ge');floatT('+'+g+'üí∞','#c8a96e');
  const btn=document.getElementById('abtn-'+act.id);if(btn)btn.disabled=false;
  const fill=document.getElementById('apf-'+act.id);if(fill)fill.style.width='0%';
  updateRes();
}
function sendWorker(id){
  if(!G.selMap){showN('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É!');return;}
  const w=G.workers.find(x=>x.id===id);if(!w||w.status!=='idle')return;
  const running=G.workers.filter(x=>x.status==='running'||x.status==='exp').length;
  const maxS=2+G.ups.slots;if(running>=maxS){showN('–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã! ('+maxS+')');return;}
  const cursed=String(G.selMap).startsWith('c');
  const tier=cursed?parseInt(String(G.selMap).slice(1)):parseInt(G.selMap);
  const key=cursed?'c'+tier:tier;
  if(!(G.maps[key]>0)){showN('–ù–µ—Ç –∫–∞—Ä—Ç!');return;}
  G.maps[key]--;
  w.status='running';w.curMap=tier;w.cursed=!!cursed;w.elapsed=0;w.prog=0;
  log('üöÄ '+w.name+' ‚Üí '+(cursed?'üíú':'')+'T'+tier,'info');renderWorkers();renderMaps();
}
function resolveWorker(w,md){
  const power=w.dmg+w.surv;const ch=Math.max(.03,calcCh(power,md.t)-(w.cursed?.2:0));
  const ok=Math.random()<ch;G.stats.mr++;G.totalRuns++;w.runsCompleted=(w.runsCompleted||0)+1;
  if(!ok){
    if(Math.random()<.45){w.status='captured';w.capturedAt=G.gt;G.stats.cap++;log('‚õìÔ∏è '+w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω –Ω–∞ T'+w.curMap+'!','ev');showN(w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω!','red');return;}
    else{w.status='injured';w.injuredAt=G.gt;G.stats.inj++;log('üíî '+w.name+' —Ä–∞–Ω–µ–Ω –Ω–∞ T'+w.curMap+'!','ev');}
  }else w.status='idle';
  const mapCostTbl2={1:15,2:35,3:65,4:100,5:140,6:185,7:240,8:310,9:400,10:510,11:640,12:800,13:990,14:1220,15:1500,16:1850};
  const lm=w.cursed?3:1;const g=goldReward(md,power,mapCostTbl2[md.t]||0);G.gold+=g;G.stats.ge+=g;
  G.cleared[md.t]=true;if(md.t>G.maxTier)G.maxTier=md.t;
  log('üí∞ '+w.name+' T'+md.t+(w.cursed?' üíú':'')+(lm>1?' x'+lm:'')+' +'+g+'üí∞','ge');floatT('+'+g+'üí∞','#f0d080');
  for(let i=0;i<lm;i++)tryItem(md,w.cls,1);tryMap(md);addXP(w,xpAmt(md.t));
  w.prog=0;w.elapsed=0;checkAchs();renderAtlasBar();renderShop();renderWorkers();renderInv();updateRes();
}
function resolveExpStep(w){
  const tier=w.expTiers[w.expIdx];const md=MAP_TIERS[tier-1];const power=w.dmg+w.surv;
  // Risk = based on hardest tier's fail chance * 1.5 (not flat -10% per step)
  const hardestTier=Math.max(...w.expTiers);
  const failChHardest=1-calcCh(power,hardestTier);
  const expFailCh=Math.min(0.6, failChHardest*1.5);
  const ch=Math.max(.03, 1-expFailCh);const ok=Math.random()<ch;
  G.stats.mr++;G.totalRuns++;
  if(!ok){
    if(Math.random()<.5){w.status='captured';w.capturedAt=G.gt;G.stats.cap++;log('‚õìÔ∏è '+w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω –≤ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ T'+tier+'!','ev');showN(w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω!','red');}
    else{w.status='injured';w.injuredAt=G.gt;G.stats.inj++;log('üíî '+w.name+' —Ä–∞–Ω–µ–Ω –≤ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ T'+tier+'!','ev');}
    w.expTiers=[];w.expIdx=0;renderWorkers();renderInv();updateRes();return;
  }
  const g=goldReward(md,power);G.gold+=g;G.stats.ge+=g;
  G.cleared[tier]=true;if(tier>G.maxTier)G.maxTier=tier;
  log('üí∞ '+w.name+' —ç–∫—Å–ø–µ–¥. T'+tier+' +'+g+'üí∞','ge');tryItem(md,w.cls,1.5);tryMap(md);addXP(w,xpAmt(tier));
  checkAchs();renderAtlasBar();renderShop();
  w.expIdx++;w.elapsed=0;w.prog=0;
  if(w.expIdx>=w.expTiers.length){w.status='idle';w.expTiers=[];w.expIdx=0;log('üéâ '+w.name+' –∑–∞–≤–µ—Ä—à–∏–ª —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é!','info');showN(w.name+' –∑–∞–≤–µ—Ä—à–∏–ª —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é!','pur');}
  renderWorkers();renderInv();updateRes();
}
function rescueW(id){
  const w=G.workers.find(x=>x.id===id);if(!w||w.status!=='captured')return;
  const cost=Math.floor((30+(w.curMap||1)*12)*(1-G.ups.rescue*.15));
  if(G.gold<cost){showN('–ù—É–∂–Ω–æ '+cost+'üí∞!');return;}
  G.gold-=cost;w.status='idle';log('üîì '+w.name+' –≤—ã–∫—É–ø–ª–µ–Ω –∑–∞ '+cost+'üí∞','info');showN(w.name+' –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω!','grn');renderWorkers();updateRes();
}
function sellItem(id){
  const it=G.inv.find(x=>x.id===id);if(!it)return;
  G.gold+=it.sellPrice;G.stats.sg+=it.sellPrice;G.stats.sold++;G.inv=G.inv.filter(x=>x.id!==id);
  log('üí∞ '+it.em+' '+it.name+' +'+it.sellPrice+'üí∞','ge');floatT('+'+it.sellPrice+'üí∞','#c8a96e');
  checkAchs();closeM();renderInv();updateRes();
}
function sellAllNormal(){
  const ns=G.inv.filter(x=>x.quality==='normal');if(!ns.length){showN('–ù–µ—Ç –æ–±—ã—á–Ω—ã—Ö!');return;}
  const tot=ns.reduce((s,x)=>s+x.sellPrice,0);G.inv=G.inv.filter(x=>x.quality!=='normal');
  G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=ns.length;
  log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+ns.length+'x –æ–±—ã—á–Ω—ã—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#c8a96e');checkAchs();renderInv();updateRes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkAchs(){
  function grant(id,reward){
    if(G.achs[id])return;G.achs[id]=true;G.gold+=reward;
    const a=ACHDEFS.find(x=>x.id===id);
    if(a){log('üèÜ '+a.nm+' '+a.rw,'info');showN('üèÜ '+a.nm,'pur');}
    renderAchs();updateRes();
  }
  if(G.stats.mr>=1)grant('first_run',30);if(G.cleared[5])grant('t5_clear',50);
  if(G.cleared[10])grant('t10_clear',150);if(G.cleared[16])grant('t16_clear',500);
  if(G.workers.length>=3)grant('hire3',100);if(G.totalRuns>=50)grant('runs50',200);
  if(G.totalRuns>=200)grant('runs200',1000);if(G.stats.fi>=20)grant('items20',80);
  const allEq=[...G.inv,...Object.values(G.selfEq),...G.workers.flatMap(w=>Object.values(w.eq))].filter(Boolean);
  if(allEq.some(x=>x.quality==='rare'))grant('rare_item',60);
  if(allEq.some(x=>x.quality==='unique'))grant('uniq_item',250);
  if(G.stats.sg>=500)grant('sell500',100);
  if(canPrestige())grant('all16',0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRESTIGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doPrestige(){
  if(!canPrestige()){showN('–ù—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤!');return;}
  const np=G.prestige+1,nb=np*15,kg=Math.floor(G.gold*.2);
  G=freshG();G.prestige=np;G.prestigeBonus=nb;G.gold=kg+100;G.maps={1:5,2:3,3:1};
  closeM();log('‚ú® –ü–†–ï–°–¢–ò–ñ '+np+'! +'+nb+'% –∑–æ–ª–æ—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞!','info');showN('‚ú® –ü—Ä–µ—Å—Ç–∏–∂ '+np+'!','pur');
  renderAll();save();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPEDITION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openExpedition(){
  if(!G.workers.length){showN('–ù–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!');return;}
  const keys=Object.keys(G.maps).filter(k=>G.maps[k]>0&&!String(k).startsWith('c')).map(Number).sort((a,b)=>b-a);
  if(keys.length<3){showN('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ä—Ç—ã!');return;}
  const idle=G.workers.filter(w=>w.status==='idle');
  if(!idle.length){showN('–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!');return;}
  const top3=keys.slice(0,3);
  let html='<div class="dim" style="margin-bottom:8px;font-size:10px">–†–∞–±–æ—Ç–Ω–∏–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç 3 –∫–∞—Ä—Ç—ã –ø–æ–¥—Ä—è–¥ (T'+top3.join(', T')+').<br>–®–∞–Ω—Å ‚àí10%, –ª—É—Ç √ó1.5. –ü—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ ‚Äî –ø–ª–µ–Ω –∏–ª–∏ —Ä–∞–Ω–µ–Ω–∏–µ.</div>'+
    idle.map(w=>'<div class="srow" style="margin-bottom:4px"><div class="wavat" style="border-color:'+WCLS[w.cls].col+'">'+WCLS[w.cls].em+'</div>'+
      '<div class="si"><div class="snm">'+w.name+' <span class="lvl-b">–£—Ä.'+w.level+'</span></div>'+
      '<div class="sds">‚öîÔ∏è'+w.dmg+' üõ°'+w.surv+'</div></div>'+
      '<button class="btn btn-sm btn-p" data-exp-w="'+w.id+'">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>').join('')+
    '<button class="btn btn-r btn-sm" id="btn-close-m" style="margin-top:6px">–û—Ç–º–µ–Ω–∞</button>';
  openM('üó∫ –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è',html);
}
function startExpedition(wid){
  const w=G.workers.find(x=>x.id===wid);if(!w||w.status!=='idle')return;
  const keys=Object.keys(G.maps).filter(k=>G.maps[k]>0&&!String(k).startsWith('c')).map(Number).sort((a,b)=>b-a);
  if(keys.length<3){showN('–ù—É–∂–Ω–æ 3 –∫–∞—Ä—Ç—ã!');closeM();return;}
  const chosen=keys.slice(0,3);chosen.forEach(t=>{G.maps[t]=Math.max(0,(G.maps[t]||0)-1);});
  w.status='exp';w.expTiers=[...chosen];w.expIdx=0;w.elapsed=0;w.prog=0;w.curMap=chosen[0];
  log('üó∫ '+w.name+' ‚Äî —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è: T'+chosen.join(', T'),'info');closeM();renderWorkers();renderMaps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TICK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tick(){
  G.gt+=200;
  if(G.selfRun){
    G.selfRun.elapsed+=200;const pct=Math.min(1,G.selfRun.elapsed/(G.selfRun.md.time*1000));
    const f=document.getElementById('rpf');if(f)f.style.width=(pct*100)+'%';
    const p=document.getElementById('rpp');if(p)p.textContent=Math.floor(pct*100)+'%';
    if(pct>=1)completeSelfRun();
  }
  if(G.actRun){
    G.actRun.elapsed+=200;const pct=Math.min(1,G.actRun.elapsed/(G.actRun.act.time*1000));
    const f=document.getElementById('apf-'+G.actRun.act.id);if(f)f.style.width=(pct*100)+'%';
    const l=document.getElementById('apct-'+G.actRun.act.id);if(l)l.textContent=Math.floor(pct*100)+'%';
    if(pct>=1)completeAct();
  }
  let wch=false;
  G.workers.forEach(w=>{
    if(w.status==='running'||w.status==='exp'){
      w.elapsed+=200;
      const tier=w.status==='exp'?w.expTiers[w.expIdx]:w.curMap;
      const md=MAP_TIERS[tier-1];
      const spd=w.cls==='ranger'?1.25:1;
      w.prog=Math.min(1,w.elapsed/(md.time*1000/spd));
      if(w.prog>=1){if(w.status==='running')resolveWorker(w,md);else resolveExpStep(w);wch=true;}
    }else if(w.status==='injured'){
      const hd=Math.max(5000,(10+(w.curMap||1)*2)*1000*(1-G.ups.heal*.2));
      if(G.gt-w.injuredAt>=hd){w.status='idle';log('üíä '+w.name+' –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è!','info');wch=true;}
    }
    const wp=document.getElementById('wp-'+w.id);if(wp)wp.style.width=(w.prog*100)+'%';
    if(w.status==='injured'){const hp=document.getElementById('hp-'+w.id);if(hp){const hd=Math.max(5000,(10+(w.curMap||1)*2)*1000*(1-G.ups.heal*.2));hp.style.width=(Math.min(1,(G.gt-w.injuredAt)/hd)*100)+'%';}}
  });
  if(wch)renderWorkers();
  updateRes();updateStats();updateSelfStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderMaps();renderShop();renderInv();renderActs();renderWorkers();renderUpgrades();renderAtlasBar();renderAtlasTab();renderAchs();updateRes();updateStats();updateSelfStats();}

function renderMaps(){
  const el=document.getElementById('tab-maps');if(!el)return;
  const keys=Object.keys(G.maps).filter(k=>G.maps[k]>0);
  if(!keys.length){el.innerHTML='<div class="dim" style="text-align:center;padding:14px;font-style:italic">–ù–µ—Ç –∫–∞—Ä—Ç.<br>–ö—É–ø–∏—Ç–µ –≤ –ª–∞–≤–∫–µ –∏–ª–∏ –ø—Ä–æ–π–¥–∏—Ç–µ –∞–∫—Ç—ã!</div>';return;}
  const power=sDmg()+sSurv();
  const normal=keys.filter(k=>!isNaN(k)).map(Number).sort((a,b)=>a-b);
  const cursed=keys.filter(k=>String(k).startsWith('c')).map(k=>parseInt(String(k).slice(1))).sort((a,b)=>a-b);
  let html='';
  const items=[...normal.map(t=>({t,k:t,cursed:false})),...cursed.map(t=>({t,k:'c'+t,cursed:true}))];
  items.forEach(({t,k,cursed})=>{
    if(!(G.maps[k]>0))return;
    const md=MAP_TIERS[t-1];const ch=calcCh(power,t)*(cursed?.8:1);const cc=chcol(ch);
    const sel=String(G.selMap)===String(k)?'sel':'';
    html+='<div class="mcard '+sel+(cursed?' cursed':'')+'" data-mapkey="'+k+'">'+
      '<div class="mtier" style="color:'+tcol(t)+'">'+(cursed?'üíú':'')+'T'+t+'</div>'+
      '<div style="flex:1"><div class="mname">'+md.em+' '+md.nm+(cursed?' <span style="color:#9944cc;font-size:8px">[–ó–ê–†–ê–ñ.]</span>':'')+'</div>'+
      '<div class="mch-wrap"><div class="mch-bg"><div class="mch-fill" style="width:'+(Math.min(1,ch)*100)+'%;background:'+cc+'"></div></div>'+
      '<div class="mch-pct" style="color:'+cc+'">'+Math.round(Math.min(1,ch)*100)+'%</div></div></div>'+
      '<div class="mcnt">'+G.maps[k]+'x</div></div>';
  });
  el.innerHTML=html;
}
function selectMap(key){
  G.selMap=String(key);renderMaps();
  const cursed=String(key).startsWith('c');const tier=cursed?parseInt(String(key).slice(1)):parseInt(key);
  if(!G.selfRun)updateRunVis(MAP_TIERS[tier-1]);updateSelfStats();renderWorkers();
}

function renderShop(){
  const all=[
    {id:'s1', nm:'–ö–∞—Ä—Ç–∞ T1 √ó3',cost:15,  mt:0, fn:()=>{G.maps[1]=(G.maps[1]||0)+3;}},
    {id:'s2', nm:'–ö–∞—Ä—Ç–∞ T2 √ó2',cost:35,  mt:0, fn:()=>{G.maps[2]=(G.maps[2]||0)+2;}},
    {id:'s3', nm:'–ö–∞—Ä—Ç–∞ T3 √ó2',cost:65,  mt:1, fn:()=>{G.maps[3]=(G.maps[3]||0)+2;}},
    {id:'s4', nm:'–ö–∞—Ä—Ç–∞ T4',   cost:100, mt:2, fn:()=>{G.maps[4]=(G.maps[4]||0)+1;}},
    {id:'s5', nm:'–ö–∞—Ä—Ç–∞ T5',   cost:140, mt:3, fn:()=>{G.maps[5]=(G.maps[5]||0)+1;}},
    {id:'s6', nm:'–ö–∞—Ä—Ç–∞ T6',   cost:185, mt:4, fn:()=>{G.maps[6]=(G.maps[6]||0)+1;}},
    {id:'s7', nm:'–ö–∞—Ä—Ç–∞ T7',   cost:240, mt:5, fn:()=>{G.maps[7]=(G.maps[7]||0)+1;}},
    {id:'s8', nm:'–ö–∞—Ä—Ç–∞ T8',   cost:310, mt:6, fn:()=>{G.maps[8]=(G.maps[8]||0)+1;}},
    {id:'s9', nm:'–ö–∞—Ä—Ç–∞ T9',   cost:400, mt:7, fn:()=>{G.maps[9]=(G.maps[9]||0)+1;}},
    {id:'s10',nm:'–ö–∞—Ä—Ç–∞ T10',  cost:510, mt:8, fn:()=>{G.maps[10]=(G.maps[10]||0)+1;}},
    {id:'s11',nm:'–ö–∞—Ä—Ç–∞ T11',  cost:640, mt:9, fn:()=>{G.maps[11]=(G.maps[11]||0)+1;}},
    {id:'s12',nm:'–ö–∞—Ä—Ç–∞ T12',  cost:800, mt:10,fn:()=>{G.maps[12]=(G.maps[12]||0)+1;}},
    {id:'s13',nm:'–ö–∞—Ä—Ç–∞ T13',  cost:990, mt:11,fn:()=>{G.maps[13]=(G.maps[13]||0)+1;}},
    {id:'s14',nm:'–ö–∞—Ä—Ç–∞ T14',  cost:1220,mt:12,fn:()=>{G.maps[14]=(G.maps[14]||0)+1;}},
    {id:'s15',nm:'–ö–∞—Ä—Ç–∞ T15',  cost:1500,mt:13,fn:()=>{G.maps[15]=(G.maps[15]||0)+1;}},
    {id:'s16',nm:'–ö–∞—Ä—Ç–∞ T16',  cost:1850,mt:14,fn:()=>{G.maps[16]=(G.maps[16]||0)+1;}},
  ];
  window._shopItems=all;
  if(G.clsLocked){all.push({id:'respec',nm:'–°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞',cost:200,mt:-1,fn:()=>{G.clsLocked=false;log('–°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞ –¥–æ—Å—Ç—É–ø–Ω–∞!','info');showN('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å!','pur');updateSelfStats();}});}
  const unlocked=all.filter(it=>G.maxTier>=it.mt);const locked=all.filter(it=>G.maxTier<it.mt);
  const t=id=>{const n=parseInt(id.slice(1));const md=MAP_TIERS[n-1];return md?' ¬∑ üí∞'+md.g[0]+'‚Äì'+md.g[1]+'+–ø—Ä–µ–¥–º–µ—Ç—ã':'';};
  let html=unlocked.map(it=>'<div class="srow"><span style="font-size:16px">üó∫</span>'+
    '<div class="si"><div class="snm">'+it.nm+'</div><div class="sds">'+t(it.id)+'</div></div>'+
    '<div style="text-align:right"><div class="spr">üí∞'+it.cost+'</div>'+
    '<button class="btn btn-sm" style="margin-top:2px" data-shop="'+it.id+'">–ö—É–ø–∏—Ç—å</button></div></div>').join('');
  if(locked.length){const nx=locked[0];html+='<div class="srow" style="opacity:.4;pointer-events:none"><span>üîí</span><div class="si"><div class="snm">'+nx.nm+'</div><div class="sds">–ü–æ—Å–ª–µ T'+(nx.mt+1)+'</div></div><div class="spr">üí∞'+nx.cost+'</div></div>';}
  document.getElementById('tab-shop').innerHTML=html;
}
function buyShop(id){
  const it=window._shopItems.find(x=>x.id===id);if(!it)return;
  if(G.gold<it.cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!');return;}
  G.gold-=it.cost;it.fn();log('üó∫ –ö—É–ø–ª–µ–Ω–æ: '+it.nm,'info');updateRes();renderMaps();
}

function renderInv(){
  const el=document.getElementById('tab-inv');if(!el)return;
  if(!G.inv.length){el.innerHTML='<div class="dim" style="text-align:center;padding:14px;font-style:italic">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>';return;}
  const ns=G.inv.filter(x=>x.quality==='normal');
  let html=ns.length?'<button class="btn btn-sm" style="margin-bottom:6px;width:100%" id="btn-sell-all">üí∞ –ü—Ä–æ–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–µ ('+ns.length+'—à—Ç = '+ns.reduce((s,x)=>s+x.sellPrice,0)+'üí∞)</button>':'';
  html+='<div class="igrid">'+G.inv.map(it=>'<div class="iico '+it.quality[0]+'" style="border-color:'+qcol(it.quality)+'55" data-iid="'+it.id+'" data-tip="'+it.id+'">'+it.em+'<span class="isp">'+it.sellPrice+'üí∞</span></div>').join('')+'</div>';
  el.innerHTML=html;updateRes();
}

function renderActs(){
  document.getElementById('tab-acts').innerHTML='<div class="dim" style="font-size:10px;margin-bottom:7px;font-style:italic">‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ—Ç –∫–∞—Ä—Ç –∏ –∑–æ–ª–æ—Ç–∞.</div>'+
    ACTS.map(a=>'<div class="act-card"><span style="font-size:17px">'+a.em+'</span>'+
      '<div style="flex:1"><div style="font-size:11px;color:var(--txt-b)">'+a.nm+'</div>'+
      '<div class="tiny">üí∞'+a.g[0]+'‚Äì'+a.g[1]+'üí∞ ¬∑ ‚è±'+a.time+'—Å</div>'+
      '<div class="act-pg"><div class="act-pgf" id="apf-'+a.id+'" style="width:0%"></div></div>'+
      '<div class="tiny" id="apct-'+a.id+'"></div></div>'+
      '<button class="btn btn-sm btn-g" id="abtn-'+a.id+'" data-act="'+a.id+'">‚ñ∂ –ò–¥—Ç–∏</button></div>').join('');
}

function renderWorkers(){
  const el=document.getElementById('workers-list');if(!el)return;
  if(!G.workers.length){el.innerHTML='<div class="dim" style="text-align:center;padding:8px;font-style:italic">–ù–∞–π–º–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞!</div>';return;}
  const maxS=2+G.ups.slots;const running=G.workers.filter(x=>x.status==='running'||x.status==='exp').length;
  el.innerHTML=G.workers.map(w=>{
    const cls=WCLS[w.cls];
    const xpp=w.level>=WLVLS.length-1?1:Math.min(1,Math.max(0,w.xp-WLVLS[w.level])/(WLVLS[w.level+1]-WLVLS[w.level]));
    const tier=G.selMap?(String(G.selMap).startsWith('c')?parseInt(String(G.selMap).slice(1)):parseInt(G.selMap)):null;
    const ch=tier?calcCh(w.dmg+w.surv,tier):null;const cc=ch?chcol(ch):'';
    let sEl='',aEl='';
    if(w.status==='idle'){
      sEl='<span class="wst st-idle">–û–ñ–ò–î–ê–ï–¢</span>';
      const hasM=!!(G.selMap&&G.maps[String(G.selMap)]>0);const hasS=running<maxS;
      aEl='<button class="btn btn-sm" data-send="'+w.id+'"'+(hasM&&hasS?'':' disabled')+'>‚ñ∂</button>';
    }else if(w.status==='running'){
      sEl='<span class="wst st-run">'+(w.cursed?'üíú':'')+'T'+w.curMap+'</span>';
      aEl='<div class="prog-bar" style="width:60px;height:3px"><div class="prog-fill" id="wp-'+w.id+'" style="width:'+(w.prog*100)+'%"></div></div>';
    }else if(w.status==='exp'){
      sEl='<span class="wst st-exp">–≠–ö–° T'+(w.expTiers&&w.expTiers[w.expIdx]||'?')+'</span>';
      aEl='<div class="prog-bar" style="width:60px;height:3px"><div class="prog-fill purple" id="wp-'+w.id+'" style="width:'+(w.prog*100)+'%"></div></div>';
    }else if(w.status==='captured'){
      const cost=Math.floor((30+(w.curMap||1)*12)*(1-G.ups.rescue*.15));
      sEl='<span class="wst st-cap">‚õì –ü–õ–ï–ù</span>';
      aEl='<button class="btn btn-sm btn-r" data-rescue="'+w.id+'">üîì'+cost+'üí∞</button>';
    }else if(w.status==='injured'){
      sEl='<span class="wst st-inj">üíî –õ–ï–ß–ò–¢–°–Ø</span>';
      aEl='<div class="prog-bar" style="width:60px;height:3px"><div class="prog-fill red" id="hp-'+w.id+'" style="width:0%"></div></div>';
    }
    return '<div class="wslot">'+
      '<div class="wavat" style="border-color:'+cls.col+'">'+cls.em+'</div>'+
      '<div class="winfo">'+
        '<div class="wname">'+w.name+'<span class="lvl-b">–£—Ä.'+w.level+'</span></div>'+
        '<div class="wcls">'+cls.nm.toUpperCase()+'</div>'+
        '<div class="tiny">‚öîÔ∏è'+w.dmg+' üõ°'+w.surv+(ch?' ¬∑ <span style="color:'+cc+'">'+Math.round(ch*100)+'%</span>':'')+'</div>'+
        '<div class="wxp"><div class="wxp-f" style="width:'+(xpp*100)+'%"></div></div>'+
      '</div>'+
      '<div style="display:flex;flex-direction:column;gap:2px;align-items:flex-end">'+sEl+
        '<div style="display:flex;gap:2px">'+aEl+'<button class="btn btn-sm" data-weq="'+w.id+'">üéí</button></div>'+
      '</div></div>';
  }).join('');
}

function renderUpgrades(){
  const defs=[
    {id:'slots', nm:'‚öô –°–ª–æ—Ç –º–∞—à–∏–Ω—ã',  max:5,desc:()=>'–†–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: '+(2+G.ups.slots),   cost:()=>Math.floor(200*Math.pow(2.2,G.ups.slots))},
    {id:'rescue',nm:'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—â–∏–∫',max:3,desc:()=>'–°–∫–∏–¥–∫–∞ –≤—ã–∫—É–ø–∞: '+(G.ups.rescue*15)+'%',cost:()=>Math.floor(250*Math.pow(2,G.ups.rescue))},
    {id:'heal',  nm:'üíä –õ–∞–∑–∞—Ä–µ—Ç',     max:3,desc:()=>'–õ–µ—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ: '+(G.ups.heal*20)+'%', cost:()=>Math.floor(220*Math.pow(2,G.ups.heal))},
  ];
  window._upsDefs=defs;
  let html=defs.map(u=>{
    const lvl=G.ups[u.id],maxed=lvl>=u.max,cost=u.cost();
    return '<div class="srow"><div style="flex:1"><div class="snm">'+u.nm+'</div><div class="sds">'+u.desc()+'</div>'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:3px">'+
      (maxed?'<span class="gt" style="font-size:9px">‚úì MAX</span>':
       '<span class="spr">üí∞'+cost+'</span><button class="btn btn-sm" data-up="'+u.id+'">–£–ª—É—á—à–∏—Ç—å</button>')+
      '</div></div></div>';
  }).join('');
  if(canPrestige())html+='<div style="margin-top:8px;padding:8px;border:1px solid #553388;background:rgba(85,51,136,.15);text-align:center"><div style="font-family:Cinzel,serif;color:#ffaa00;font-size:11px;margin-bottom:6px">‚ú® –í–´ –ü–†–û–®–õ–ò –í–°–ï 16 –¢–ò–†–û–í!</div><button class="btn btn-p" id="btn-prestige">‚ú® –ü—Ä–µ—Å—Ç–∏–∂ ‚Äî —Å–±—Ä–æ—Å —Å –±–æ–Ω—É—Å–æ–º</button></div>';
  document.getElementById('upgrades').innerHTML=html;
}

function renderAtlasBar(){
  const ct=document.getElementById('pt-tiers');if(!ct)return;
  ct.innerHTML=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].map(t=>'<div class="pt-t '+(G.cleared[t]?'done':'')+'" title="T'+t+'">'+t+'</div>').join('');
  const hint=document.getElementById('pt-hint');if(!hint)return;
  const cl=Object.keys(G.cleared).length;
  if(G.prestige>0)hint.textContent='–ü—Ä–µ—Å—Ç–∏–∂ '+G.prestige+' ¬∑ +'+G.prestigeBonus+'% –∑–æ–ª–æ—Ç–∞';
  else if(canPrestige())hint.innerHTML='<span style="color:#ffaa00;font-weight:bold">‚ú® –î–æ—Å—Ç—É–ø–µ–Ω –ü—Ä–µ—Å—Ç–∏–∂! (–≤–∫–ª–∞–¥–∫–∞ –ê–ø–≥—Ä–µ–π–¥—ã)</span>';
  else hint.textContent='–¢–∏—Ä–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: '+cl+'/16';
  const rip=document.getElementById('ri-pres');if(rip)rip.style.display=G.prestige>0?'flex':'none';
  const rpp=document.getElementById('r-pres');if(rpp)rpp.textContent=G.prestige;
}
function renderAtlasTab(){
  const el=document.getElementById('tab-atlas');if(!el)return;
  let html='<div style="font-size:10px;color:var(--txt-d);margin-bottom:8px">–ó–µ–ª—ë–Ω—ã–π = –ø—Ä–æ–π–¥–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 16 –¥–ª—è –ü—Ä–µ—Å—Ç–∏–∂–∞.</div><div id="atlas-grid">';
  for(let t=1;t<=16;t++){
    const md=MAP_TIERS[t-1];const done=!!G.cleared[t];
    html+='<div class="at-cell '+(done?'done':'locked')+'">'+
      '<div style="font-size:18px">'+md.em+'</div>'+
      '<div style="font-family:Cinzel,serif;font-size:8px;margin-top:2px">T'+t+'</div>'+
      '<div style="font-size:7px;color:var(--txt-d)">'+md.nm.slice(0,10)+'</div>'+
      (done?'<div style="color:var(--grn);font-size:10px">‚úì</div>':'<div style="font-size:9px">‚Äî</div>')+
    '</div>';
  }
  html+='</div>';el.innerHTML=html;
}
function renderAchs(){
  const el=document.getElementById('tab-ach');if(!el)return;
  el.innerHTML=ACHDEFS.map(a=>{
    const done=!!G.achs[a.id];
    return '<div class="ach-row '+(done?'done':'')+'">'+
      '<div class="ach-ico">'+(done?a.ico:'üîí')+'</div>'+
      '<div style="flex:1"><div class="ach-nm">'+a.nm+'</div><div class="ach-ds">'+a.ds+'</div><div class="ach-rw">'+a.rw+'</div></div>'+
      (done?'<span class="gt">‚úì</span>':'')+'</div>';
  }).join('');
}

function updateRes(){
  const tm=Object.keys(G.maps).reduce((s,k)=>s+(G.maps[k]||0),0);
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('r-gold',fN(G.gold));set('r-maps',tm);set('r-items',G.inv.length);set('r-workers',G.workers.length);set('r-runs',G.totalRuns);
}
function updateStats(){
  const el=document.getElementById('stats-p');if(!el)return;
  el.innerHTML='<div>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span class="gt">'+fN(G.stats.ge)+'</span></div>'+
    '<div>üíé –ü—Ä–æ–¥–∞–Ω–æ: <span class="gt">'+G.stats.sold+'—à—Ç ('+fN(G.stats.sg)+'üí∞)</span></div>'+
    '<div>üó∫ –ö–∞—Ä—Ç –ø—Ä–æ–π–¥–µ–Ω–æ: <span class="gt">'+G.stats.mr+'</span></div>'+
    '<div>üèï –ê–∫—Ç–æ–≤: <span class="gt">'+G.stats.ar+'</span></div>'+
    '<div>‚öîÔ∏è –ü—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: <span class="gt">'+G.stats.fi+'</span></div>'+
    '<div>‚õì –ó–∞—Ö–≤–∞—á–µ–Ω–æ: <span style="color:var(--red)">'+G.stats.cap+'</span></div>'+
    '<div>üíî –†–∞–Ω–µ–Ω–∏–π: <span style="color:var(--org)">'+G.stats.inj+'</span></div>'+
    (G.prestige?'<div>‚ú® –ü—Ä–µ—Å—Ç–∏–∂: <span style="color:#ffaa00">'+G.prestige+'x (+'+G.prestigeBonus+'%üí∞)</span></div>':'');
}
function updateSelfStats(){
  const d=sDmg(),s=sSurv();
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('s-dmg',d);set('s-surv',s);set('s-lvl',G.selfLevel);
  // Level up button
  const lvlBtn=document.getElementById('btn-self-lvlup');
  if(lvlBtn)lvlBtn.style.display=G.selfLevelUp?'inline-block':'none';
  // Class buttons highlight
  ['warrior','mage','ranger'].forEach(c=>{
    const b=document.getElementById('cls-'+c);
    if(b)b.style.borderColor=c===(G.selfCls||'warrior')?'var(--gold)':'var(--gold-d)';
  });
  const ec=document.getElementById('s-ch');
  if(ec){
    if(G.selMap){const t=parseInt(String(G.selMap).startsWith('c')?String(G.selMap).slice(1):G.selMap);const ch=calcCh(d+s,t);ec.innerHTML='<span style="color:'+chcol(ch)+'">'+Math.round(ch*100)+'% T'+t+'</span>';}
    else ec.textContent='‚Äî (–Ω–µ—Ç –∫–∞—Ä—Ç—ã)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openM(title,html){document.getElementById('mtl').textContent=title;document.getElementById('mbd').innerHTML=html;document.getElementById('moverlay').classList.add('on');}
function closeM(){document.getElementById('moverlay').classList.remove('on');}

function openHire(){
  const cost=80+G.workers.length*60;
  let html='<div class="dim" style="margin-bottom:8px;font-size:10px">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="gt">'+cost+'üí∞</span></div>';
  Object.entries(WCLS).forEach(([cls,c])=>{
    html+='<div class="srow" style="margin-bottom:4px"><div class="wavat" style="border-color:'+c.col+'">'+c.em+'</div>'+
      '<div class="si"><div class="snm">'+c.nm+'</div><div class="sds">'+c.desc+'</div></div>'+
      '<button class="btn btn-sm" data-hire="'+cls+'">–ù–∞–Ω—è—Ç—å</button></div>';
  });
  html+='<button class="btn btn-r btn-sm" id="btn-close-m" style="margin-top:6px">–û—Ç–º–µ–Ω–∞</button>';
  openM('–ù–∞–Ω—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞',html);
}
function hireWorker(cls){
  const cost=80+G.workers.length*60;if(G.gold<cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ '+cost+'üí∞');return;}
  G.gold-=cost;
  const name=WNAMES[Math.floor(Math.random()*WNAMES.length)];
  const w={id:++G.wid,name,cls,status:'idle',curMap:1,cursed:false,elapsed:0,prog:0,runsCompleted:0,
    capturedAt:0,injuredAt:0,xp:0,level:0,expTiers:[],expIdx:0,eq:{weapon:null,armor:null,helmet:null,ring:null},dmg:5,surv:5};
  recalcW(w);G.workers.push(w);log('üë§ –ù–∞–Ω—è—Ç: '+name+' ('+WCLS[cls].nm+')','info');checkAchs();closeM();renderWorkers();updateRes();
}

function openWorkerEq(id){
  const w=G.workers.find(x=>x.id===id);if(!w)return;
  const xpnm=w.level<WLVLS.length-1?((WLVLS[w.level+1]-w.xp)+' XP –¥–æ –£—Ä.'+(w.level+1)):'–ú–∞–∫—Å.';
  const tier=G.selMap?(String(G.selMap).startsWith('c')?parseInt(String(G.selMap).slice(1)):parseInt(G.selMap)):null;
  const ch=tier?calcCh(w.dmg+w.surv,tier):null;
  let html='<div style="display:flex;gap:10px;margin-bottom:8px;flex-wrap:wrap;font-size:11px">'+
    '<div>‚öîÔ∏è<span class="gt">'+w.dmg+'</span></div><div>üõ°<span style="color:var(--grn)">'+w.surv+'</span></div>'+
    '<div>‚≠ê–£—Ä.'+w.level+': <span style="color:var(--mag)">'+xpnm+'</span></div>'+
    (ch?'<div>–®–∞–Ω—Å: <span style="color:'+chcol(ch)+'">'+Math.round(ch*100)+'%</span></div>':'')+
    '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px">';
  SLOTS.forEach(sl=>{
    const eq=w.eq[sl];
    html+='<div class="eqsl '+(eq?'filled':'')+'" data-pick-w="'+id+'" data-pick-sl="'+sl+'">'+
      '<span class="eqlbl">'+SLOTNM[sl]+'</span>'+
      (eq?'<span style="color:'+qcol(eq.quality)+';font-size:9px">'+eq.em+' '+eq.name+'</span>'+
          '<span class="tiny">‚öîÔ∏è+'+iDmg(eq,w.cls)+' üõ°+'+iSurv(eq,w.cls)+'</span>':
       '<span class="dim" style="font-size:9px">–ü—É—Å—Ç–æ</span>')+
    '</div>';
  });
  html+='</div><button class="btn btn-r btn-sm" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button>';
  openM(WCLS[w.cls].em+' '+w.name,html);
}
function openSelfEq(){
  const cls=G.selfCls||'warrior';const d=sDmg(),s=sSurv();
  let html='<div style="display:flex;gap:10px;margin-bottom:8px;font-size:11px">'+
    '<div>‚öîÔ∏è<span class="gt">'+d+'</span></div><div>üõ°<span style="color:var(--grn)">'+s+'</span></div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px">';
  SLOTS.forEach(sl=>{
    const eq=G.selfEq[sl];
    html+='<div class="eqsl '+(eq?'filled':'')+'" data-pick-w="0" data-pick-sl="'+sl+'">'+
      '<span class="eqlbl">'+SLOTNM[sl]+'</span>'+
      (eq?'<span style="color:'+qcol(eq.quality)+';font-size:9px">'+eq.em+' '+eq.name+'</span>'+
          '<span class="tiny">‚öîÔ∏è+'+iDmg(eq,cls)+' üõ°+'+iSurv(eq,cls)+'</span>':
       '<span class="dim" style="font-size:9px">–ü—É—Å—Ç–æ</span>')+
    '</div>';
  });
  html+='</div><button class="btn btn-r btn-sm" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button>';
  openM('üßô –í–∞—à–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ',html);
}
function openSlotPick(ownerId,slot,isWorker){
  const cls=isWorker?(G.workers.find(x=>x.id===ownerId)||{cls:'warrior'}).cls:(G.selfCls||'warrior');
  const owner=isWorker?G.workers.find(x=>x.id===ownerId):null;
  const cur=isWorker?(owner?owner.eq[slot]:null):G.selfEq[slot];
  const compat=G.inv.filter(it=>it.slot===slot);
  let html='';
  if(cur){
    html+='<div class="srow" style="border-color:'+qcol(cur.quality)+'44;margin-bottom:6px"><span style="font-size:17px">'+cur.em+'</span>'+
      '<div class="si"><div style="color:'+qcol(cur.quality)+';font-size:11px">'+cur.name+'</div>'+
      '<div class="tiny">‚öîÔ∏è'+iDmg(cur,cls)+' üõ°'+iSurv(cur,cls)+' ¬∑ '+cur.sellPrice+'üí∞</div></div>'+
      '<button class="btn btn-sm btn-r" data-uneq-slot="'+slot+'" data-uneq-owner="'+ownerId+'" data-uneq-isw="'+(isWorker?1:0)+'">–°–Ω—è—Ç—å</button></div>';
  }
  if(!compat.length){html+='<div class="dim" style="padding:8px;font-style:italic">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';}
  else{
    html+=compat.map(it=>{
      const d=iDmg(it,cls),s=iSurv(it,cls),cd=cur?iDmg(cur,cls):0,cs=cur?iSurv(cur,cls):0;
      const dd=d-cd,ds=s-cs;
      const dds=dd>0?'<span class="dp">+'+dd+'</span>':dd<0?'<span class="dn">'+dd+'</span>':'<span class="dim">¬±0</span>';
      const dss=ds>0?'<span class="dp">+'+ds+'</span>':ds<0?'<span class="dn">'+ds+'</span>':'<span class="dim">¬±0</span>';
      const c=qcol(it.quality);
      return '<div class="srow" style="cursor:pointer;border-color:'+c+'33" data-equip-item="'+it.id+'" data-equip-slot="'+slot+'" data-equip-owner="'+ownerId+'" data-equip-isw="'+(isWorker?1:0)+'" data-tip="'+it.id+'">'+
        '<span style="font-size:17px">'+it.em+'</span><div class="si"><div style="color:'+c+';font-size:11px">'+it.name+'</div>'+
        '<div class="tiny">‚öîÔ∏è'+d+'('+dds+') üõ°'+s+'('+dss+') ¬∑ '+it.sellPrice+'üí∞</div></div>'+
        '<button class="btn btn-sm">–ù–∞–¥–µ—Ç—å</button></div>';
    }).join('');
  }
  html+='<div style="margin-top:7px"><button class="btn btn-sm btn-r" data-back-eq="'+ownerId+'" data-back-isw="'+(isWorker?1:0)+'">‚Üê –ù–∞–∑–∞–¥</button></div>';
  openM('–í—ã–±—Ä–∞—Ç—å: '+SLOTNM[slot],html);
}
function doEquip(ownerId,slot,itemId,isWorker){
  const item=G.inv.find(x=>x.id===itemId);if(!item)return;
  if(isWorker){
    const w=G.workers.find(x=>x.id===ownerId);if(!w)return;
    if(w.eq[slot])G.inv.push(w.eq[slot]);w.eq[slot]=item;G.inv=G.inv.filter(x=>x.id!==itemId);
    recalcW(w);log('‚úÖ '+w.name+' –Ω–∞–¥–µ–ª '+item.em+' '+item.name,'info');openWorkerEq(ownerId);
  }else{
    if(G.selfEq[slot])G.inv.push(G.selfEq[slot]);G.selfEq[slot]=item;G.inv=G.inv.filter(x=>x.id!==itemId);
    log('‚úÖ –í—ã –Ω–∞–¥–µ–ª–∏ '+item.em+' '+item.name,'info');openSelfEq();
  }
  renderInv();renderWorkers();renderMaps();updateSelfStats();checkAchs();
}
function doUnequip(ownerId,slot,isWorker){
  if(isWorker){
    const w=G.workers.find(x=>x.id===ownerId);if(!w||!w.eq[slot])return;
    G.inv.push(w.eq[slot]);w.eq[slot]=null;recalcW(w);openWorkerEq(ownerId);
  }else{
    if(!G.selfEq[slot])return;G.inv.push(G.selfEq[slot]);G.selfEq[slot]=null;openSelfEq();
  }
  renderInv();renderWorkers();renderMaps();updateSelfStats();
}
function openItemM(id){
  const it=G.inv.find(x=>x.id===id);if(!it)return;
  openM(it.em+' '+it.name,
    '<div class="tiny" style="margin-bottom:6px">'+qlbl(it.quality).toUpperCase()+' ¬∑ –¢–∏—Ä–∞ '+it.tier+' ¬∑ '+SLOTNM[it.slot]+'</div>'+
    it.mods.map(m=>'<div style="color:var(--mag);padding:2px 0;font-size:13px">+ '+m.value+' '+STATNM[m.stat]+'</div>').join('')+
    '<hr class="sep"><div style="font-size:11px;margin-bottom:6px">–ü—Ä–æ–¥–∞–∂–∞: <span class="gt">'+it.sellPrice+'üí∞</span></div>'+
    '<div style="display:flex;gap:4px"><button class="btn btn-sm btn-g" data-sell-id="'+id+'">üí∞ –ü—Ä–æ–¥–∞—Ç—å</button>'+
    '<button class="btn btn-sm btn-r" data-discard-id="'+id+'">üóë –í—ã–±—Ä–æ—Å–∏—Ç—å</button>'+
    '<button class="btn btn-sm btn-r" id="btn-close-m">‚úï</button></div>');
}
function discardItem(id){G.inv=G.inv.filter(x=>x.id!==id);closeM();renderInv();updateRes();}

function openDebug(){
  const sp=sDmg()+sSurv();
  const rows=[['version','v0.008'],['gold',G.gold],['totalRuns',G.totalRuns],['prestige',G.prestige],['bonus',G.prestigeBonus+'%'],
    ['selfPower',sp],['chances',[1,3,5,8,10,12,16].map(t=>'T'+t+':'+Math.round(calcCh(sp,t)*100)+'%').join(' ')],
    ['cleared',Object.keys(G.cleared).sort((a,b)=>a-b).join(',')],
    ['maps',Object.keys(G.maps).filter(k=>G.maps[k]>0).map(k=>k+':'+G.maps[k]).join(',')],
    ['workers',G.workers.map(w=>w.name+'('+w.cls+',lvl'+w.level+',‚öî'+w.dmg+',üõ°'+w.surv+','+w.status+')').join('|')],
    ['inv',G.inv.length],['stats',JSON.stringify(G.stats)],['ups',JSON.stringify(G.ups)],
    ['dgr',MAP_TIERS.map(m=>'T'+m.t+':'+m.dgr).join(' ')],
    ['achs',Object.keys(G.achs).join(',')]];
  const dataStr=JSON.stringify(Object.fromEntries(rows),null,2);
  openM('üîß –î–ï–ë–ê–ì',
    '<div id="dbg-out">'+rows.map(([k,v])=>'<div><span style="color:#ffaa44">'+k+':</span> '+JSON.stringify(v)+'</div>').join('')+'</div>'+
    '<div style="margin-top:7px;display:flex;gap:5px"><button class="btn btn-sm" id="btn-copy-debug">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>'+
    '<button class="btn btn-sm btn-r" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button></div>');
  window._debugStr=dataStr;
}

function confirmReset(){
  openM('‚ö†Ô∏è –°–ë–†–û–°',
    '<div style="color:var(--red);margin-bottom:10px;font-size:12px">–í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω.</div>'+
    '<div style="display:flex;gap:6px"><button class="btn btn-r" id="btn-do-reset">üíÄ –£–º–µ—Ä–µ—Ç—å –≤ –Ω–∏—â–µ—Ç–µ</button>'+
    '<button class="btn btn-sm" id="btn-close-m">–ù–µ—Ç</button></div>');
}
function doReset(){
  if(window._tickId){clearInterval(window._tickId);window._tickId=null;}
  if(window._saveId){clearInterval(window._saveId);window._saveId=null;}
  try{localStorage.removeItem('kartahodec_save');}catch(e){}
  G=freshG();
  const ov=document.getElementById('moverlay');
  if(ov)ov.style.display='none';
  const app=document.getElementById('app');
  if(app)app.innerHTML=
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center;gap:14px">'+
    '<div style="font-size:60px">üíÄ</div>'+
    '<div style="font-family:Cinzel,serif;font-size:24px;color:var(--red);text-shadow:0 0 25px rgba(200,50,50,.6)">–°–ú–ï–†–¢–¨ –í –ù–ò–©–ï–¢–ï</div>'+
    '<div style="color:var(--txt-d);font-style:italic">–ò–∑–≥–Ω–∞–Ω–Ω–∏–∫ –ø–∞–ª, –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É–≤ –≤–µ–ª–∏—á–∏—è...</div>'+
    '<button class="btn" id="btn-restart">‚öî –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button></div>';
  document.getElementById('btn-restart').addEventListener('click',()=>location.reload());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLTIP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTip(e,id){
  const item=[...G.inv,...Object.values(G.selfEq),...G.workers.flatMap(w=>Object.values(w.eq))].filter(Boolean).find(x=>x.id===id);
  if(!item)return;
  const c=qcol(item.quality);
  document.getElementById('tt').innerHTML=
    '<div class="tt-nm" style="color:'+c+'">'+item.em+' '+item.name+'</div>'+
    '<div class="tt-ty">'+qlbl(item.quality).toUpperCase()+' ¬∑ –¢'+item.tier+' ¬∑ '+SLOTNM[item.slot]+'</div>'+
    item.mods.map(m=>'<div class="tt-st">+ '+m.value+' '+STATNM[m.stat]+'</div>').join('')+
    '<hr class="tt-dv"><div class="tt-sm">–í–æ–∏–Ω: ‚öîÔ∏è'+iDmg(item,'warrior')+' üõ°'+iSurv(item,'warrior')+'<br>–ú–∞–≥: ‚öîÔ∏è'+iDmg(item,'mage')+' üõ°'+iSurv(item,'mage')+'<br>–°–ª–µ–¥–æ–ø—ã—Ç: ‚öîÔ∏è'+iDmg(item,'ranger')+' üõ°'+iSurv(item,'ranger')+'</div>'+
    '<div class="tt-sv">üí∞ –ü—Ä–æ–¥–∞–∂–∞: '+item.sellPrice+'üí∞</div>';
  const tt=document.getElementById('tt');tt.style.display='block';
  let x=e.clientX+14,y=e.clientY+14;
  if(x+270>window.innerWidth)x=e.clientX-270;if(y+tt.offsetHeight>window.innerHeight)y=e.clientY-tt.offsetHeight-8;
  tt.style.left=x+'px';tt.style.top=y+'px';
}
function hideTip(){document.getElementById('tt').style.display='none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFS & LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showN(msg,type){
  const el=document.createElement('div');
  el.className='notif'+(type?' '+type:'');el.textContent=msg;
  document.getElementById('notif-area').appendChild(el);setTimeout(()=>el.remove(),3200);
}
function log(msg,cls){
  const el=document.getElementById('loot-log');if(!el)return;
  const now=new Date();const t=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const d=document.createElement('div');d.className='le '+(cls||'');
  d.innerHTML='<span class="lt">['+t+']</span>'+msg;el.prepend(d);
  while(el.children.length>120)el.removeChild(el.lastChild);
}
function floatT(txt,color){
  const el=document.createElement('div');el.className='fl';
  el.style.cssText='color:'+color+';left:'+(Math.random()*160+window.innerWidth/2-80)+'px;top:'+(window.innerHeight*.4)+'px';
  el.textContent=txt;document.body.appendChild(el);setTimeout(()=>el.remove(),1300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE / LOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save(){
  try{localStorage.setItem('kartahodec_save',JSON.stringify({
    v:8,gold:G.gold,totalRuns:G.totalRuns,maps:G.maps,inv:G.inv,workers:G.workers,
    ups:G.ups,selfEq:G.selfEq,selfCls:G.selfCls,clsLocked:G.clsLocked,selfXp:G.selfXp,selfLevel:G.selfLevel,stats:G.stats,iid:G.iid,wid:G.wid,
    maxTier:G.maxTier,cleared:G.cleared,achs:G.achs,prestige:G.prestige,prestigeBonus:G.prestigeBonus,
  }));}catch(e){}
}
function load(){
  try{
    const raw=localStorage.getItem('kartahodec_save');if(!raw)return;
    const s=JSON.parse(raw);
    if(!s.v||s.v<8){localStorage.removeItem('kartahodec_save');log('‚ö† –°—Ç–∞—Ä—ã–π —Å–µ–π–≤ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ','ev');return;}
    Object.assign(G,s);
    if(!G.cleared)G.cleared={};if(!G.achs)G.achs={};if(!G.prestige)G.prestige=0;if(!G.prestigeBonus)G.prestigeBonus=0;
    if(!G.selfCls)G.selfCls='warrior';if(!G.selfXp)G.selfXp=0;if(!G.selfLevel)G.selfLevel=0;if(G.selfLevelUp===undefined)G.selfLevelUp=false;
    G.workers.forEach(w=>{
      if(w.status==='running'||w.status==='exp'){w.status='idle';w.prog=0;w.elapsed=0;}
      if(!w.xp)w.xp=0;if(!w.level)w.level=0;if(!w.expTiers)w.expTiers=[];if(!w.expIdx)w.expIdx=0;
      recalcW(w);
    });
    G.selfRun=null;G.actRun=null;log('üíæ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω','info');
  }catch(e){log('‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','ev');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click',function(e){
  const t=e.target;const cl=s=>t.closest?t.closest(s):null;
  hideTip();
  // Tabs
  const tabBtn=cl('.tab-btn');
  if(tabBtn&&tabBtn.dataset.tab){
    const tab=tabBtn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
    const el=document.getElementById('tab-'+tab);if(el)el.classList.add('active');
    tabBtn.classList.add('active');
    if(tab==='inv')renderInv();else if(tab==='acts')renderActs();
    else if(tab==='atlas')renderAtlasTab();else if(tab==='ach')renderAchs();
    return;
  }
  // Map select
  const mc=cl('.mcard');if(mc&&mc.dataset.mapkey){selectMap(mc.dataset.mapkey);return;}
  // Fixed buttons
  // Self class selection
  if(t.dataset.cls){G.selfCls=t.dataset.cls;updateSelfStats();renderWorkers();log('–í—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å: '+WCLS[t.dataset.cls].nm,'info');return;}
  // Self level up
  if(t.id==='btn-self-lvlup'){G.selfLevelUp=false;log('‚≠ê –í—ã –ø—Ä–æ–∫–∞—á–∞–ª–∏ —É—Ä–æ–≤–µ–Ω—å '+G.selfLevel+'! +3‚öîÔ∏è +3üõ°','info');showN('–£—Ä–æ–≤–µ–Ω—å '+G.selfLevel+' –ø—Ä–∏–º–µ–Ω—ë–Ω!','pur');updateSelfStats();return;}
  if(t.id==='btn-self-run'){selfRun();return;}
  if(t.id==='btn-cancel-run'){cancelRun();return;}
  if(t.id==='btn-self-eq'){openSelfEq();return;}
  if(t.id==='btn-hire'){openHire();return;}
  if(t.id==='btn-expedition'){openExpedition();return;}
  if(t.id==='btn-debug'){openDebug();return;}
  if(t.id==='btn-reset'){confirmReset();return;}
  if(t.id==='btn-do-reset'){doReset();return;}
  if(t.id==='btn-close-m'){closeM();return;}
  if(t.id==='btn-sell-all'){sellAllNormal();return;}
  if(t.id==='btn-copy-debug'){try{navigator.clipboard.writeText(window._debugStr||'');}catch(ex){}showN('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');return;}
  if(t.id==='btn-prestige'){
    openM('‚ú® –ü–†–ï–°–¢–ò–ñ',
      '<div style="margin-bottom:10px;font-size:12px">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤!<br><br>'+
      '<span class="gt">–ë–æ–Ω—É—Å—ã –ø—Ä–∏ –ü—Ä–µ—Å—Ç–∏–∂–µ:</span><br>‚Ä¢ +15% –∑–æ–ª–æ—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞ (—Å—É–º–º–∏—Ä—É–µ—Ç—Å—è)<br>‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 20% —Ç–µ–∫—É—â–µ–≥–æ –∑–æ–ª–æ—Ç–∞<br>‚Ä¢ –ù–∞—á–∏–Ω–∞–µ—Ç–µ —Å T1‚ÄìT3 –∫–∞—Ä—Ç–∞–º–∏<br><br>'+
      '–¢–µ–∫—É—â–∏–π: <span class="gt">'+G.prestige+'</span> ‚Üí <span style="color:#ffaa00">'+(G.prestige+1)+'</span> (+'+((G.prestige+1)*15)+'% –∑–æ–ª–æ—Ç–∞)</div>'+
      '<div style="display:flex;gap:6px"><button class="btn btn-p" id="btn-confirm-prestige">‚ú® –í–æ–∑–Ω–µ—Å—Ç–∏—Å—å!</button>'+
      '<button class="btn btn-sm" id="btn-close-m">–û—Ç–º–µ–Ω–∞</button></div>');
    return;
  }
  if(t.id==='btn-confirm-prestige'){doPrestige();return;}
  // Shop
  if(t.dataset.shop){buyShop(t.dataset.shop);return;}
  // Upgrades
  if(t.dataset.up){
    const costs={slots:()=>Math.floor(200*Math.pow(2.2,G.ups.slots)),rescue:()=>Math.floor(250*Math.pow(2,G.ups.rescue)),heal:()=>Math.floor(220*Math.pow(2,G.ups.heal))};
    const maxes={slots:5,rescue:3,heal:3};
    const id=t.dataset.up;if(!costs[id])return;
    if(G.ups[id]>=maxes[id]){showN('–ú–∞–∫—Å–∏–º—É–º!');return;}
    const cost=costs[id]();if(G.gold<cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!');return;}
    G.gold-=cost;G.ups[id]++;log('‚öô '+id+' ‚Üí –£—Ä.'+G.ups[id],'info');updateRes();renderUpgrades();return;
  }
  // Workers
  const sendEl=t.dataset.send?t:cl('[data-send]');if(sendEl&&sendEl.dataset.send){sendWorker(parseInt(sendEl.dataset.send));return;}
  const rescEl=t.dataset.rescue?t:cl('[data-rescue]');if(rescEl&&rescEl.dataset.rescue){rescueW(parseInt(rescEl.dataset.rescue));return;}
  const weqEl=t.dataset.weq?t:cl('[data-weq]');if(weqEl&&weqEl.dataset.weq){openWorkerEq(parseInt(weqEl.dataset.weq));return;}
  const hireEl=cl('[data-hire]');if(hireEl){hireWorker(hireEl.dataset.hire);return;}
  // Act
  if(t.dataset.act){startAct(t.dataset.act);return;}
  // Expedition
  const expEl=t.dataset.expW?t:cl('[data-exp-w]');if(expEl&&expEl.dataset.expW){startExpedition(parseInt(expEl.dataset.expW));return;}
  // Equip pick slot
  const pickEl=cl('[data-pick-w]');if(pickEl){openSlotPick(parseInt(pickEl.dataset.pickW),pickEl.dataset.pickSl,parseInt(pickEl.dataset.pickW)!==0);return;}
  // Do equip
  const eqEl=cl('[data-equip-item]');if(eqEl){doEquip(parseInt(eqEl.dataset.equipOwner),eqEl.dataset.equipSlot,parseInt(eqEl.dataset.equipItem),eqEl.dataset.equipIsw==='1');return;}
  // Unequip
  const uqEl=t.dataset.uneqSlot?t:cl('[data-uneq-slot]');if(uqEl&&uqEl.dataset.uneqSlot){doUnequip(parseInt(uqEl.dataset.uneqOwner),uqEl.dataset.uneqSlot,uqEl.dataset.uneqIsw==='1');return;}
  // Back from slot pick
  if(t.dataset.backEq!==undefined){if(t.dataset.backIsw==='1')openWorkerEq(parseInt(t.dataset.backEq));else openSelfEq();return;}
  // Item click
  const iico=cl('[data-iid]');if(iico){openItemM(parseInt(iico.dataset.iid));return;}
  if(t.dataset.sellId){sellItem(parseInt(t.dataset.sellId));return;}
  if(t.dataset.discardId){discardItem(parseInt(t.dataset.discardId));return;}
  if(t.id==='moverlay'){closeM();return;}
});
document.addEventListener('mousemove',function(e){
  const el=e.target.closest?e.target.closest('[data-tip]'):null;
  if(el)showTip(e,parseInt(el.dataset.tip));else hideTip();
});
document.addEventListener('scroll',()=>hideTip(),true);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  load();renderAll();
  window._tickId=setInterval(tick,200);
  window._saveId=setInterval(save,8000);
  log('üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü v0.008','info');
}
init();
</script>
</body>
</html>
