<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü v0.022</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root{--gold:#c8a96e;--gold-b:#f0d080;--gold-d:#8a6a2e;--blood:#8b1a1a;--blood-b:#c0392b;--bg0:#0a0806;--bg1:#110e09;--bg2:#1a1510;--bg3:#1f1912;--bg4:#241d14;--brd:#3a2e1e;--brd-g:#5a4a2a;--txt:#d4c4a0;--txt-d:#8a7a60;--txt-b:#f0e0b0;--mag:#8888ff;--rare:#f0d060;--uniq:#e87020;--norm:#b0b0b0;--grn:#4a9a4a;--cyn:#4ab0b0;--red:#c03030;--org:#cc7700;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg0);color:var(--txt);font-family:'Crimson Pro',Georgia,serif;font-size:16px;font-weight:400;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(100,60,10,.15) 0%,transparent 70%);}
#app{position:relative;z-index:1;max-width:1440px;margin:0 auto;padding:8px;}
header{text-align:center;padding:12px 0 8px;border-bottom:1px solid var(--brd-g);margin-bottom:10px;position:relative;}
header::after{content:'‚öô –ú–ê–®–ò–ù–ê –ö–ê–õ–ì–£–£–†–ê ‚öô';position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);background:var(--bg0);padding:0 10px;font-family:'Cinzel',serif;font-size:9px;color:var(--gold-d);letter-spacing:3px;}
h1{font-family:'Cinzel',serif;font-size:22px;font-weight:900;color:var(--gold);text-shadow:0 0 25px rgba(200,169,110,.4);letter-spacing:4px;display:flex;align-items:center;justify-content:center;gap:10px;}
.ver{font-size:10px;color:var(--gold-d);border:1px solid var(--gold-d);padding:2px 6px;letter-spacing:2px;font-weight:400;}
.sub{font-size:10px;color:var(--txt-d);letter-spacing:2px;margin-top:2px;font-style:italic;}
#res-bar{display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap;}
.ri{background:var(--bg3);border:1px solid var(--brd);padding:4px 10px;display:flex;align-items:center;gap:6px;font-family:'Cinzel',serif;font-size:13px;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);}
.ri-ico{font-size:17px;}.ri-lbl{color:var(--txt-d);font-size:11px;letter-spacing:1px;display:block;}.ri-val{color:var(--gold);font-weight:600;}
#atlas-bar{background:var(--bg3);border:1px solid var(--brd-g);padding:5px 12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:11px;flex-wrap:wrap;}
.pt-lbl{font-family:'Cinzel',serif;color:var(--gold-d);letter-spacing:1px;font-size:11px;white-space:nowrap;}
.pt-tiers{display:flex;gap:2px;flex-wrap:wrap;}
.pt-t{width:18px;height:12px;background:var(--bg2);border:1px solid var(--brd);font-size:9px;display:flex;align-items:center;justify-content:center;color:var(--txt-d);}
.pt-t.done{background:var(--gold-d);border-color:var(--gold);color:var(--bg0);}
#layout{display:grid;grid-template-columns:310px 1fr 285px;gap:8px;align-items:start;}
.panel{background:var(--bg3);border:1px solid var(--brd);padding:10px;position:relative;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-d),transparent);}
.ptitle{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;gap:6px;}
.tabs{display:flex;gap:1px;margin-bottom:8px;border-bottom:1px solid var(--brd);flex-wrap:wrap;}
.tab-btn{background:transparent;border:none;color:var(--txt-d);font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;padding:5px 9px;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-1px;}
.tab-btn:hover{color:var(--txt);}.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}
.tabpanel{display:none;}.tabpanel.active{display:block;}
.mcard{background:var(--bg4);border:1px solid var(--brd);padding:6px 9px;margin-bottom:4px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.mcard:hover{border-color:var(--gold-d);}.mcard.sel{border-color:var(--gold);box-shadow:0 0 7px rgba(200,169,110,.2);}.mcard.cursed{border-color:#9944cc;}
.mtier{font-family:'Cinzel',serif;font-size:9px;font-weight:900;width:22px;text-align:center;}.mname{flex:1;font-size:14px;color:var(--txt-b);font-weight:500;}.mcnt{background:var(--bg2);border:1px solid var(--brd);padding:2px 6px;font-size:12px;font-family:'Cinzel',serif;}.mreward{font-size:12px;color:var(--txt-d);}
.mch-wrap{display:flex;align-items:center;gap:3px;margin-top:2px;}.mch-bg{flex:1;height:2px;background:var(--bg2);}.mch-fill{height:100%;}.mch-pct{font-size:11px;font-family:'Cinzel',serif;min-width:26px;text-align:right;}
.run-vis{background:var(--bg4);border:1px solid var(--brd);min-height:140px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.run-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 80%,rgba(80,20,0,.3) 0%,transparent 70%);}
.run-con{position:relative;z-index:1;text-align:center;padding:8px;}.run-nm{font-family:'Cinzel',serif;font-size:17px;color:var(--gold);margin-bottom:4px;}
.prog-wrap{margin:4px 0;}.prog-lbl{font-size:9px;color:var(--txt-d);margin-bottom:2px;display:flex;justify-content:space-between;}
.prog-bar{height:6px;background:var(--bg2);border:1px solid var(--brd);overflow:hidden;position:relative;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));transition:width .1s linear;}
.prog-fill.red{background:linear-gradient(90deg,#882200,#ff4400);}.prog-fill.grn{background:linear-gradient(90deg,#1a5a1a,#4a9a4a);}.prog-fill.purple{background:linear-gradient(90deg,#330066,#9900ff);}
.btn{background:linear-gradient(180deg,rgba(200,169,110,.15),rgba(200,169,110,.05));border:1px solid var(--gold-d);color:var(--gold);font-family:'Cinzel',serif;font-size:12px;letter-spacing:1px;padding:8px 14px;cursor:pointer;transition:all .2s;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%);}
.btn:hover:not(:disabled){background:linear-gradient(180deg,rgba(200,169,110,.3),rgba(200,169,110,.1));border-color:var(--gold);box-shadow:0 0 10px rgba(200,169,110,.2);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-r{border-color:var(--blood);color:#ff6666;background:linear-gradient(180deg,rgba(139,26,26,.2),rgba(139,26,26,.05));}.btn-r:hover:not(:disabled){border-color:var(--blood-b);}
.btn-g{border-color:#2a6a2a;color:#6acf6a;background:linear-gradient(180deg,rgba(26,80,26,.2),rgba(26,80,26,.05));}.btn-g:hover:not(:disabled){border-color:#4a9a4a;}
.btn-p{border-color:#553388;color:#bb66ff;background:linear-gradient(180deg,rgba(85,51,136,.2),rgba(85,51,136,.05));}.btn-p:hover:not(:disabled){border-color:#aa66ff;}
.btn-sm{padding:4px 11px;font-size:11px;}
.wslot{background:var(--bg4);border:1px solid var(--brd);padding:8px 9px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.wavat{width:32px;height:32px;border-radius:50%;border:2px solid var(--brd);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.winfo{flex:1;min-width:0;}.wname{font-size:14px;color:var(--txt-b);}.wcls{font-size:10px;color:var(--txt-d);letter-spacing:1px;}
.wst{font-size:10px;padding:1px 5px;border:1px solid;letter-spacing:1px;font-family:'Cinzel',serif;}
.st-idle{color:var(--txt-d);border-color:var(--brd);}.st-run{color:var(--grn);border-color:var(--grn);animation:pg 2s infinite;}.st-cap{color:var(--red);border-color:var(--red);animation:pr 1.5s infinite;}.st-inj{color:var(--org);border-color:var(--org);}.st-exp{color:#bb66ff;border-color:#553388;animation:pg 2s infinite;}
@keyframes pg{0%,100%{opacity:1}50%{opacity:.6}}@keyframes pr{0%,100%{opacity:1;box-shadow:0 0 4px rgba(200,50,50,.3)}50%{opacity:.7;box-shadow:none}}
.wxp{height:2px;background:var(--bg2);margin-top:3px;}.wxp-f{height:100%;background:linear-gradient(90deg,#553388,#aa66ff);}
.lvl-b{display:inline-block;background:rgba(170,100,255,.15);border:1px solid #553388;color:#aa66ff;font-family:'Cinzel',serif;font-size:11px;padding:1px 4px;margin-left:3px;}
#loot-log{background:var(--bg4);border:1px solid var(--brd);height:150px;overflow-y:auto;padding:4px 8px;font-size:13px;display:flex;flex-direction:column-reverse;gap:1px;}
#loot-log::-webkit-scrollbar{width:3px;}#loot-log::-webkit-scrollbar-thumb{background:var(--gold-d);}
.le{padding:1px 0;border-bottom:1px solid rgba(255,255,255,.03);}
.ge{color:var(--gold);}.i-n{color:var(--norm);}.i-m{color:var(--mag);}.i-r{color:var(--rare);}.i-u{color:var(--uniq);}.ev{color:#ff8844;font-style:italic;}.info{color:var(--cyn);}.lt{color:var(--txt-d);margin-right:3px;font-size:8px;}
.igrid{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;max-height:300px;overflow-y:auto;}
.igrid::-webkit-scrollbar{width:3px;}
.iico{background:var(--bg4);border:1px solid var(--brd);aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;transition:all .15s;position:relative;}
.iico:hover{transform:scale(1.08);}
.iico.n{border-color:#444;}.iico.m{border-color:#5555aa;}.iico.r{border-color:#aaaa00;}.iico.u{border-color:#cc5500;}
.isp{position:absolute;bottom:1px;right:2px;font-size:12px;font-weight:bold;color:var(--gold-d);font-family:'Cinzel',serif;}
#tt{position:fixed;background:var(--bg1);border:1px solid var(--gold-d);padding:8px 12px;max-width:260px;pointer-events:none;z-index:9999;display:none;font-size:11px;box-shadow:0 0 18px rgba(0,0,0,.9);}
.tt-nm{font-family:'Cinzel',serif;font-size:16px;margin-bottom:4px;}.tt-ty{font-size:8px;color:var(--txt-d);margin-bottom:4px;letter-spacing:1px;border-bottom:1px solid var(--brd);padding-bottom:3px;}
.tt-st{color:var(--mag);padding:2px 0;font-size:14px;}.tt-dv{border:none;border-top:1px solid var(--brd);margin:4px 0;}.tt-sm{font-size:11px;color:var(--txt-d);line-height:1.7;}.tt-sv{color:var(--gold-d);font-size:9px;margin-top:2px;}
.srow{background:var(--bg4);border:1px solid var(--brd);padding:7px 9px;margin-bottom:3px;display:flex;align-items:center;gap:7px;}
.si{flex:1;}.snm{font-size:14px;color:var(--txt-b);}.sds{font-size:11px;color:var(--txt-d);margin-top:1px;}.spr{color:var(--gold);font-family:'Cinzel',serif;font-size:12px;white-space:nowrap;}
#notif-area{position:fixed;top:70px;right:14px;z-index:9500;display:flex;flex-direction:column;gap:4px;max-width:270px;}
.notif{background:var(--bg1);border:1px solid var(--gold-d);padding:7px 11px;font-size:10px;animation:sli .3s ease,fao .5s ease 2.5s forwards;}
.notif.red{border-color:var(--blood-b);color:#ff8888;}.notif.grn{border-color:var(--grn);color:#88ff88;}.notif.pur{border-color:#aa66ff;color:#cc99ff;}
@keyframes sli{from{transform:translateX(100%);opacity:0}to{transform:none;opacity:1}}@keyframes fao{to{opacity:0;transform:translateX(18px)}}
.eqsl{background:var(--bg2);border:1px dashed var(--brd);padding:8px 10px;font-size:14px;color:var(--txt-d);min-height:52px;cursor:pointer;display:flex;flex-direction:column;gap:3px;transition:all .15s;}
.eqsl:hover{border-color:var(--gold-d);}.eqsl.filled{border-style:solid;border-color:var(--brd);color:var(--txt);}
.eqlbl{font-size:12px;color:var(--txt-d);letter-spacing:1px;font-weight:600;}
#moverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:none;align-items:center;justify-content:center;}
#moverlay.on{display:flex;}
#mbox{background:var(--bg3);border:1px solid var(--gold-d);padding:16px;max-width:480px;width:92%;max-height:85vh;overflow-y:auto;box-shadow:0 0 35px rgba(0,0,0,.9);}
#mbox::-webkit-scrollbar{width:3px;}#mbox::-webkit-scrollbar-thumb{background:var(--gold-d);}
.mtl{font-family:'Cinzel',serif;font-size:14px;color:var(--gold);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--brd);}
@keyframes fup{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-50px);opacity:0}}
.fl{position:fixed;pointer-events:none;font-family:'Cinzel',serif;font-size:12px;z-index:9999;animation:fup 1.2s ease forwards;}
.sep{border:none;border-top:1px solid var(--brd);margin:6px 0;}.dim{color:var(--txt-d);}.gt{color:var(--gold);}.rt{color:var(--red);}.grnt{color:var(--grn);}.tiny{font-size:11px;color:var(--txt-d);}.dp{color:var(--mag);}.dn{color:var(--red);}
#self-sec{background:var(--bg4);border:1px solid var(--brd-g);padding:8px;margin-bottom:8px;}
.act-card{background:var(--bg4);border:1px solid var(--brd);padding:8px 9px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.act-pg{height:3px;background:var(--bg2);margin-top:3px;}.act-pgf{height:100%;background:var(--grn);transition:width .1s;}
#atlas-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.at-cell{background:var(--bg4);border:1px solid var(--brd);padding:6px 4px;text-align:center;}
.at-cell.done{border-color:var(--gold-d);background:rgba(200,169,110,.08);}.at-cell.locked{opacity:.4;}
.ach-row{background:var(--bg4);border:1px solid var(--brd);padding:7px 9px;margin-bottom:3px;display:flex;align-items:center;gap:8px;}
.ach-row.done{border-color:var(--gold-d);background:rgba(200,169,110,.06);}.ach-row.pending{border-color:#cc7700;background:rgba(170,90,0,.1);animation:pr 2s infinite;}
.ach-ico{font-size:20px;width:28px;text-align:center;flex-shrink:0;}
.ach-nm{font-size:13px;color:var(--txt-b);}.ach-ds{font-size:11px;color:var(--txt-d);}.ach-rw{font-size:11px;color:var(--gold-d);}
#dbg-out{background:var(--bg0);border:1px solid #333;padding:8px;font-family:monospace;font-size:9px;color:#88ff88;max-height:400px;overflow-y:auto;line-height:1.6;}
</style>
</head>
<body>
<div id="app">
<header>
  <h1>–ö–ê–†–¢–û–•–û–î–ï–¶ <span class="ver">v0.022</span></h1>
</header>
<div id="res-bar">
  <div class="ri"><span class="ri-ico">üí∞</span><div><span class="ri-lbl">–ó–û–õ–û–¢–û</span><span class="ri-val" id="r-gold">0</span></div></div>
  <div class="ri"><span class="ri-ico">üó∫</span><div><span class="ri-lbl">–ö–ê–†–¢–´</span><span class="ri-val" id="r-maps">0</span></div></div>
  <div class="ri"><span class="ri-ico">‚öîÔ∏è</span><div><span class="ri-lbl">–ü–†–ï–î–ú–ï–¢–´</span><span class="ri-val" id="r-items">0</span></div></div>
  <div class="ri"><span class="ri-ico">üë•</span><div><span class="ri-lbl">–†–ê–ë–û–¢–ù–ò–ö–ò</span><span class="ri-val" id="r-workers">0</span></div></div>
  <div class="ri"><span class="ri-ico">üîÑ</span><div><span class="ri-lbl">–ü–†–û–ô–î–ï–ù–û</span><span class="ri-val" id="r-runs">0</span></div></div>
  <div class="ri" id="ri-pres" style="display:none"><span class="ri-ico">‚ú®</span><div><span class="ri-lbl">–ü–†–ï–°–¢–ò–ñ</span><span class="ri-val" id="r-pres">0</span></div></div>
</div>
<div id="atlas-bar">
  <span class="pt-lbl">–ê–¢–õ–ê–°:</span>
  <div class="pt-tiers" id="pt-tiers"></div>
  <span id="pt-hint" class="dim" style="font-size:9px;margin-left:4px"></span>
</div>
<div id="layout">
<!-- LEFT -->
<div>
  <div class="panel">
    <div class="tabs">
      <button class="tab-btn" data-tab="maps">üó∫ –ö–ê–†–¢–´</button>
      <button class="tab-btn" data-tab="shop">üè™ –õ–ê–í–ö–ê</button>
      <button class="tab-btn" data-tab="inv">üéí –°–ö–õ–ê–î</button>
      <button class="tab-btn active" data-tab="acts">üèï –ê–ö–¢–´</button>
      <button class="tab-btn" data-tab="atlas">üåê –ê–¢–õ–ê–°</button>
      <button class="tab-btn" data-tab="ach">üèÜ –ê–†–•–ò–í</button>
    </div>
    <div id="tab-maps" class="tabpanel"></div>
    <div id="tab-shop" class="tabpanel"></div>
    <div id="tab-inv" class="tabpanel"></div>
    <div id="tab-acts" class="tabpanel active"></div>
    <div id="tab-atlas" class="tabpanel"></div>
    <div id="tab-ach" class="tabpanel"></div>
  </div>
</div>
<!-- CENTER -->
<div>
  <div id="self-sec">
    <div class="ptitle">üßô –í–´ ‚Äî –ò–ó–ì–ù–ê–ù–ù–ò–ö <span id="self-cls-badge" style="font-size:10px;color:var(--txt-d)"></span></div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
      <div><div class="tiny">–ö–õ–ê–°–°</div><div style="display:flex;gap:4px;margin-top:2px" id="cls-btns" style="font-size:13px">
        <button class="btn btn-sm" data-cls="warrior" id="cls-warrior">‚öîÔ∏è –î–∏–∫–∞—Ä—å</button>
        <button class="btn btn-sm" data-cls="mage" id="cls-mage">üîÆ –í–µ–¥—å–º–∞</button>
        <button class="btn btn-sm" data-cls="ranger" id="cls-ranger">üèπ –û—Ö–æ—Ç–Ω–∏—Ü–∞</button>
        <button class="btn btn-sm" data-cls="noble" id="cls-noble" style="display:none;border-color:#e8c020;color:#e8c020">üë∏ –î–≤–æ—Ä—è–Ω–∫–∞</button>
      </div></div>
      <div style="margin-left:auto"><button class="btn btn-sm" id="btn-self-eq">üéí –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</button></div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div><div class="tiny">‚öîÔ∏è –£–†–û–ù</div><div class="gt" style="font-family:'Cinzel',serif;font-size:16px" id="s-dmg">5</div></div>
      <div><div class="tiny">üõ° –í–´–ñ–ò–í–ê–ï–ú–û–°–¢–¨</div><div class="grnt" style="font-family:'Cinzel',serif;font-size:16px" id="s-surv">10</div></div>
      <div><div class="tiny">‚úÖ –®–ê–ù–°</div><div style="font-family:'Cinzel',serif;font-size:13px" id="s-ch">‚Äî</div></div>
      <div style="flex:1;min-width:120px"><div class="tiny">‚≠ê –£–†–û–í–ï–ù–¨ <span id="s-lvl-xp" style="color:var(--mag)"></span></div><div style="display:flex;align-items:center;gap:6px;margin-top:2px"><span class="gt" style="font-family:'Cinzel',serif;font-size:16px" id="s-lvl">0</span><button class="btn btn-sm btn-p" id="btn-self-lvlup" style="display:none;padding:2px 8px;font-size:12px">–ü–æ–≤—ã—Å–∏—Ç—å</button></div><div style="height:3px;background:var(--bg2);border:1px solid var(--brd);margin-top:3px;width:100%"><div id="s-xp-bar" style="height:100%;background:linear-gradient(90deg,#553388,#aa66ff);width:0%"></div></div></div>
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">üåÄ –ü–û–†–¢–ê–õ –ö–ê–†–¢–´</div>
    <div class="run-vis"><div class="run-bg"></div><div class="run-con" id="run-con"><div class="dim" style="font-style:italic">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Å–ª–µ–≤–∞</div></div></div>
    <div class="prog-wrap" id="rpw" style="display:none">
      <div class="prog-lbl"><span id="rpl">–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="rpp">0%</span></div>
      <div class="prog-bar"><div class="prog-fill" id="rpf" style="width:0%"></div></div>
    </div>
    <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:6px">
      <button class="btn" id="btn-self-run">‚öî –ü—Ä–æ–π—Ç–∏ —Å–∞–º–æ–º—É</button>
      <button class="btn btn-r" id="btn-cancel-run" style="display:none">‚úñ –û—Ç—Å—Ç—É–ø–∏—Ç—å</button>
    </div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üë• –†–ê–ë–û–¢–ù–ò–ö–ò <button class="btn btn-sm btn-p" id="btn-expedition">üó∫ –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è</button></div>
    <div id="workers-list"></div>
    <div style="margin-top:7px"><button class="btn" id="btn-hire">+ –ù–∞–Ω—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</button></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üìú –ñ–£–†–ù–ê–õ</div>
    <div id="loot-log"></div>
  </div>
</div>
<!-- RIGHT -->
<div>
  <div class="panel">
    <div class="ptitle">‚öô –ú–ê–®–ò–ù–ê –ö–ê–õ–ì–£–£–†–ê</div>
    <div id="upgrades"></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê <button class="btn btn-sm" id="btn-debug" style="font-size:7px">üîß –î–ï–ë–ê–ì</button></div>
    <div id="stats-p" style="font-size:13px;line-height:2.1"></div>
  </div>
  <div class="panel" style="margin-top:8px">
    <div class="ptitle">‚ö†Ô∏è –û–ü–ê–°–ù–û</div>
    <button class="btn btn-r" style="width:100%" id="btn-reset">üíÄ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  </div>
</div>
</div>
</div>
<div id="tt"></div>
<div id="moverlay"><div id="mbox"><div class="mtl" id="mtl"></div><div id="mbd"></div></div></div>
<div id="notif-area"></div>
<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAP_TIERS=[
  {t:1, nm:'–ê–∫–∞–¥–µ–º–∏—è',              em:'üèõÔ∏è',time:8, g:[15,35],  drop:.28,md:.08,mx:2, dgr:22},
  {t:2, nm:'–î—é–Ω—ã',                  em:'üèúÔ∏è',time:9, g:[22,48],  drop:.30,md:.09,mx:3, dgr:35},
  {t:3, nm:'–ö–∞–Ω—å–æ–Ω',                em:'üèîÔ∏è',time:10,g:[32,68],  drop:.32,md:.10,mx:4, dgr:52},
  {t:4, nm:'–ö–ª–∞–¥–±–∏—â–µ',              em:'‚õ™',time:12,g:[45,90],  drop:.34,md:.11,mx:5, dgr:73},
  {t:5, nm:'–ê—Ç–æ–ª–ª',                 em:'üèùÔ∏è',time:13,g:[60,115], drop:.36,md:.12,mx:6, dgr:98},
  {t:6, nm:'–ê—Ä—Å–µ–Ω–∞–ª',               em:'‚öîÔ∏è',time:15,g:[80,150], drop:.38,md:.13,mx:7, dgr:128},
  {t:7, nm:'–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å',     em:'üèôÔ∏è',time:17,g:[100,185],drop:.40,md:.14,mx:8, dgr:163},
  {t:8, nm:'–ë–∞–∑–∞—Ä',                 em:'üõí',time:18,g:[125,230], drop:.42,md:.15,mx:9, dgr:203},
  {t:9, nm:'–¢—ë–º–Ω—ã–π –ª–µ—Å',            em:'üåë',time:20,g:[155,285], drop:.44,md:.16,mx:10,dgr:248},
  {t:10,nm:'–õ–µ–¥—è–Ω—ã–µ —Ö–∏–∂–∏–Ω—ã',       em:'üèîÔ∏è',time:22,g:[195,345], drop:.46,md:.16,mx:11,dgr:298},
  {t:11,nm:'–ö–∏—Å–ª–æ—Ç–Ω—ã–µ –ø–µ—â–µ—Ä—ã',      em:'üß™',time:25,g:[240,410], drop:.48,md:.17,mx:12,dgr:354},
  {t:12,nm:'–ü—É—Ä–ø—É—Ä–Ω—ã–π —Ö—Ä–∞–º',       em:'üü£',time:28,g:[290,480], drop:.50,md:.18,mx:13,dgr:416},
  {t:13,nm:'–ü–æ–≥—Ä–µ–±–∞–ª—å–Ω—ã–µ –∫–∞–º–µ—Ä—ã',   em:'ü™¶',time:30,g:[350,570], drop:.52,md:.19,mx:14,dgr:484},
  {t:14,nm:'–ì—Ä–æ–±–Ω–∏—Ü–∞ –ø–∞—É–∫–∞',        em:'üï∑Ô∏è',time:33,g:[420,670], drop:.55,md:.20,mx:15,dgr:558},
  {t:15,nm:'–ê—Ä–µ–Ω–∞',                 em:'üèüÔ∏è',time:36,g:[500,790], drop:.58,md:.22,mx:16,dgr:638},
  {t:16,nm:'–ü–ª—è–∂',                  em:'üåä',time:40,g:[600,900], drop:.62,md:.25,mx:16,dgr:725},
];
const SHOP_COSTS={1:15,2:35,3:65,4:100,5:140,6:185,7:240,8:310,9:400,10:510,11:640,12:800,13:990,14:1220,15:1500,16:1850};
const WCLS={
  warrior:{nm:'–î–∏–∫–∞—Ä—å',   em:'‚öîÔ∏è',col:'#cc4444',desc:'–í—ã—Å–æ–∫–æ–µ –•–ü –∏ –±—Ä–æ–Ω—è.'},
  mage:   {nm:'–í–µ–¥—å–º–∞',   em:'üîÆ',col:'#8888ff',desc:'–í—ã—Å–æ–∫–∏–π —É—Ä–æ–Ω –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è–º–∏.'},
  ranger: {nm:'–û—Ö–æ—Ç–Ω–∏—Ü–∞', em:'üèπ',col:'#44cc88',desc:'–ë—ã—Å—Ç—Ä—ã–π, —É–∫–ª–æ–Ω—è–µ—Ç—Å—è.'},
  noble:  {nm:'–î–≤–æ—Ä—è–Ω–∫–∞',  em:'üë∏',col:'#e8c020',desc:'–ü–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å—ã –æ—Ç –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤–µ—â–µ–π.'},
};
const WNAMES=['–•–∞—Ä–∞–ª—å–¥','–°–∏–≥—Ä–∏–¥','–¢–æ—Ä–≤–∞–ª—å–¥','–ê—Å—Ç—Ä–∏–¥','–†–∞–≥–Ω–∞—Ä','–•–∏–ª—å–¥–∞','–≠–π–Ω–∞—Ä','–§—Ä–µ–π—è','–ë—å—ë—Ä–Ω','–ò–Ω–≥—Ä–∏–¥','–ì—É–Ω–Ω–∞—Ä','–ë—Ä—É–Ω—Ö–∏–ª—å–¥','–°–≤–µ–π–Ω','–û–ª–∞—Ñ','–ú–∞–≥–Ω—É—Å','–õ–µ–π—Ñ','–•–µ–ª—å–≥–∞','–ò–≤–∞—Ä'];
const ACTS=[
  {id:'a1',nm:'–ê–∫—Ç 1: –ó–æ–Ω–∞ –Ω–æ–≤–∏—á–∫–æ–≤',em:'üèï',time:14,g:[3,8]},
  {id:'a2',nm:'–ê–∫—Ç 2: –õ–∞–≥–µ—Ä—å –±—Ä–æ–¥—è–≥',em:'üåÑ',time:21,g:[6,14]},
  {id:'a3',nm:'–ê–∫—Ç 3: –ü–æ–ª—è —Å—Ä–∞–∂–µ–Ω–∏–π',em:'üó°Ô∏è',time:31,g:[10,22]},
];
const WLVLS=[0,50,150,350,750,1500,3000,5500,9000,14000,21000];
const SLOTS=['weapon','armor','helmet','ring'];
const SLOTNM={weapon:'‚öîÔ∏è –û—Ä—É–∂–∏–µ',armor:'üõ°Ô∏è –ë—Ä–æ–Ω—è',helmet:'‚õëÔ∏è –®–ª–µ–º',ring:'üíç –ö–æ–ª—å—Ü–æ'};
const STATNM={dmgPhys:'–§–∏–∑. —É—Ä–æ–Ω',dmgSpell:'–£—Ä–æ–Ω –∑–∞–∫–ª–∏–Ω.',dmgArea:'–£—Ä–æ–Ω –ø–æ –æ–±–ª–∞—Å—Ç–∏',minionDmg:'–£—Ä–æ–Ω –ø—Ä–∏–∑—ã–≤–æ–≤',critChance:'–®–∞–Ω—Å –∫—Ä–∏—Ç–∞',critMult:'–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫—Ä–∏—Ç–∞',critSpell:'–ö—Ä–∏—Ç –∑–∞–∫–ª–∏–Ω.',castSpd:'–°–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Å—Ç–∞',atkSpd:'–°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏',str:'–°–∏–ª–∞',int:'–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',dex:'–õ–æ–≤–∫–æ—Å—Ç—å',hp:'–û—á–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è',energyShield:'–≠–Ω–µ—Ä–≥–æ—â–∏—Ç',armor:'–ë—Ä–æ–Ω—è',evasion:'–£–∫–ª–æ–Ω–µ–Ω–∏–µ',blockChance:'–®–∞–Ω—Å –±–ª–æ–∫–∞',allRes:'–í—Å–µ —Å–æ–ø—Ä.',fireRes:'–û–≥–Ω. —Å–æ–ø—Ä.',coldRes:'–•–æ–ª. —Å–æ–ø—Ä.',moveSpd:'–°–∫–æ—Ä. –¥–≤–∏–∂–µ–Ω–∏—è'};
const CDMG={warrior:['dmgPhys','dmgArea','critChance','critMult','atkSpd','str'],mage:['dmgSpell','minionDmg','critSpell','castSpd','int'],ranger:['dmgPhys','critChance','critMult','atkSpd','dex'],noble:['dmgPhys','dmgSpell','dmgArea','minionDmg','critChance','critMult','critSpell','atkSpd','str','int','dex','castSpd']};
const CSURV={warrior:['armor','hp','blockChance','str','allRes','fireRes'],mage:['energyShield','int','allRes'],ranger:['evasion','hp','dex','allRes','coldRes'],noble:['armor','energyShield','evasion','hp','blockChance','allRes','fireRes','coldRes','moveSpd','str','int','dex']};
const IBASES=[
  {nm:'–î–ª–∏–Ω–Ω—ã–π –º–µ—á',      em:'üó°Ô∏è',cls:'warrior',slot:'weapon',mods:['dmgPhys','critChance','atkSpd','str']},
  {nm:'–ë–æ–µ–≤–æ–π —Ç–æ–ø–æ—Ä',     em:'ü™ì',cls:'warrior',slot:'weapon',mods:['dmgPhys','dmgArea','str','atkSpd']},
  {nm:'–î–≤—É—Ä—É—á–Ω—ã–π –º–æ–ª–æ—Ç',  em:'üî®',cls:'warrior',slot:'weapon',mods:['dmgPhys','dmgArea','str','critMult']},
  {nm:'–°—Ç–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–¥–Ω–∏–∫',em:'üõ°',cls:'warrior',slot:'armor', mods:['armor','hp','str','allRes']},
  {nm:'–õ–∞—Ç–Ω—ã–µ –ø–æ–Ω–æ–∂–∏',    em:'ü•æ',cls:'warrior',slot:'armor', mods:['armor','hp','str','fireRes']},
  {nm:'–®–ª–µ–º –ø–∞–ª–∞–¥–∏–Ω–∞',    em:'‚õëÔ∏è',cls:'warrior',slot:'helmet',mods:['armor','hp','str','fireRes']},
  {nm:'–ö–æ–ª—å—Ü–æ –≤–æ–∏–Ω–∞',     em:'üî¥',cls:'warrior',slot:'ring',  mods:['hp','str','allRes','armor']},
  {nm:'–ñ–µ–∑–ª —Å–∏–ª—ã',        em:'ü™Ñ',cls:'mage',   slot:'weapon',mods:['dmgSpell','castSpd','critSpell','int']},
  {nm:'–ü–æ—Å–æ—Ö –º–∞–≥–∞',       em:'ü¶Ø',cls:'mage',   slot:'weapon',mods:['dmgSpell','castSpd','int','energyShield']},
  {nm:'–°–≤–∏—Ç–æ–∫ –ø—Ä–∏–∑—ã–≤–∞',   em:'üìú',cls:'mage',   slot:'weapon',mods:['minionDmg','dmgSpell','int','castSpd']},
  {nm:'–ú–∞–Ω—Ç–∏—è –∞—Ä—Ö–∏–º–∞–≥–∞',  em:'üß•',cls:'mage',   slot:'armor', mods:['energyShield','int','allRes','castSpd']},
  {nm:'–î–∏–∞–¥–µ–º–∞ –º–∞–≥–∞',     em:'üëë',cls:'mage',   slot:'helmet',mods:['energyShield','int','critSpell','dmgSpell']},
  {nm:'–ö–æ–ª—å—Ü–æ –∑–Ω–∞–Ω–∏—è',    em:'üîµ',cls:'mage',   slot:'ring',  mods:['int','dmgSpell','critSpell','allRes']},
  {nm:'–û—Ö–æ—Ç–Ω–∏—á–∏–π –ª—É–∫',    em:'üèπ',cls:'ranger', slot:'weapon',mods:['dmgPhys','atkSpd','dex','critChance']},
  {nm:'–ö–∏–Ω–∂–∞–ª –∞—Å—Å–∞—Å–∏–Ω–∞',  em:'üî™',cls:'ranger', slot:'weapon',mods:['dmgPhys','critChance','critMult','dex']},
  {nm:'–ö–æ–∂–∞–Ω—ã–π –¥–æ—Å–ø–µ—Ö',   em:'ü•ã',cls:'ranger', slot:'armor', mods:['evasion','dex','hp','allRes']},
  {nm:'–°–∞–ø–æ–≥–∏ –ª–æ–≤–∫–∞—á–∞',   em:'üëü',cls:'ranger', slot:'armor', mods:['evasion','dex','moveSpd','hp']},
  {nm:'–ö–æ–ª—å—Ü–æ –ª–æ–≤–∫–æ—Å—Ç–∏',  em:'üü¢',cls:'ranger', slot:'ring',  mods:['hp','dex','evasion','coldRes']},
];
const NPFX={warrior:['–ö—Ä–æ–≤–∞–≤—ã–π','–°—Ç–∞–ª—å–Ω–æ–π','–ñ–µ–ª–µ–∑–Ω—ã–π','–Ø—Ä–æ—Å—Ç–Ω—ã–π','–ë–æ–µ–≤–æ–π','–ö–∞–º–µ–Ω–Ω—ã–π'],mage:['–¢—ë–º–Ω—ã–π','–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π','–í–µ—á–Ω—ã–π','–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π','–°—É–º–µ—Ä–µ—á–Ω—ã–π','–ó–≤—ë–∑–¥–Ω—ã–π'],ranger:['–¢–æ—á–Ω—ã–π','–ë—ã—Å—Ç—Ä—ã–π','–õ–µ—Å–Ω–æ–π','–¢–µ–Ω–µ–≤–æ–π','–í–µ—Ç—Ä–µ–Ω—ã–π','–°–∫—Ä—ã—Ç—ã–π'],generic:['–î—Ä–µ–≤–Ω–∏–π','–ü—Ä–æ–∫–ª—è—Ç—ã–π','–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π','–í–µ–ª–∏–∫–∏–π','–ú–æ–≥—É—á–∏–π','–ó–ª–æ–≤–µ—â–∏–π']};
const NSFX={warrior:['–ë–µ—Ä—Å–µ—Ä–∫–µ—Ä–∞','–ü–∞–ª–∞–¥–∏–Ω–∞','–ó–∞—â–∏—Ç–Ω–∏–∫–∞','–í–æ–∏—Ç–µ–ª—è','–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞'],mage:['–ê—Ä—Ö–∏–º–∞–≥–∞','–ß–∞—Ä–æ–¥–µ—è','–ù–µ–∫—Ä–æ–º–∞–Ω—Ç–∞','–ü—Ä–æ–≤–∏–¥—Ü–∞','–ü–æ–≤–µ–ª–∏—Ç–µ–ª—è'],ranger:['–ê—Å—Å–∞—Å–∏–Ω–∞','–°–ª–µ–¥–æ–ø—ã—Ç–∞','–û—Ö–æ—Ç–Ω–∏–∫–∞','–†–∞–∑–≤–µ–¥—á–∏–∫–∞','–°—Ç—Ä–µ–ª–∫–∞'],generic:['–†–æ–∫–∞','–ì–∏–±–µ–ª–∏','–°—É–¥—å–±—ã','–í–µ—á–Ω–æ—Å—Ç–∏','–ó–∞–±–≤–µ–Ω–∏—è']};
// Unique maps: {t: min_tier, nm, em, bonus description}
const UNIQ_MAPS=[
  {t:3, nm:'–ö–æ—à–º–∞—Ä –ê–∫—Ç–æ–Ω–∞',         em:'üåÄ',desc:'–õ–∞–±–∏—Ä–∏–Ω—Ç —Å–∫–µ–ª–µ—Ç–æ–≤ ¬∑ +100%IIQ',     bonus:'x2 –ø—Ä–µ–¥–º–µ—Ç—ã'},
  {t:4, nm:'–û—Å–≤—è—â—ë–Ω–Ω–∞—è –∑–µ–º–ª—è',       em:'‚õ™',desc:'+100%IIQ ¬∑ +3 –∫–∞—Ä—Ç—ã –æ—Ç –±–æ—Å—Å–∞',      bonus:'+3 –∫–∞—Ä—Ç—ã'},
  {t:5, nm:'–í–æ–¥–æ–≤–æ—Ä–æ—Ç –•–∞–æ—Å–∞',        em:'üåä',desc:'–ú–æ–ª–Ω–∏—è+–ò–º–º—É–Ω–∏—Ç–µ—Ç ¬∑ —Ä–µ–¥–∫–æ—Å—Ç—å +300%', bonus:'x2 —Ä–µ–¥–∫–æ—Å—Ç—å'},
  {t:6, nm:'–ó–∞–ª –í–µ–ª–∏–∫–∏—Ö –ú–∞—Å—Ç–µ—Ä–æ–≤',   em:'üëë',desc:'–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–µ –ì—Ä–∞–Ω–¥–º–∞—Å—Ç–µ—Ä–∞ ¬∑ PvP',    bonus:'x3 –æ–ø—ã—Ç'},
  {t:8, nm:'–õ–µ—Å–Ω–æ–π –°–∫–ª–µ–ø',           em:'üåë',desc:'–¢—ë–º–Ω—ã–π –ª–µ—Å ¬∑ –ù–µ–∫—Ä–æ–º–∞–Ω—Ç—ã',           bonus:'+1 —É–Ω–∏–∫.—à–∞–Ω—Å'},
  {t:9, nm:'–ò–∑–º–µ–Ω—ë–Ω–Ω–∞—è –ü–∞–º—è—Ç—å',      em:'üß†',desc:'–°–∏–Ω—Ç–µ–∑ ¬∑ +100%IIQ ¬∑ +25% –º–æ–Ω—Å—Ç—Ä–æ–≤', bonus:'x2 XP'},
  {t:10,nm:'–î–æ–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ü–∞–º—è—Ç—å',     em:'üîÆ',desc:'–°–∏–Ω—Ç–µ–∑ ¬∑ 5 –¥–æ–ø. –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤',      bonus:'x2 XP'},
  {t:11,nm:'–ú–∞—à–∏–Ω–∞—Ä–∏—É–º –î–æ—Ä–∏–∞–Ω–∏',     em:'‚öôÔ∏è',desc:'–ë–æ—Å—Å—ã —É—Å–∏–ª–µ–Ω—ã –≤—ã–±–æ—Ä–æ–º –∏–≥—Ä–æ–∫–∞',       bonus:'x2 –ª—É—Ç'},
  {t:12,nm:'–°–º–µ—Ä—Ç—å –∏ –ù–∞–ª–æ–≥–∏',        em:'‚ò†Ô∏è',desc:'–ë–æ—Å—Å: +12-20 –≤–∞–ª—é—Ç—ã ¬∑ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ',    bonus:'x4 –∑–æ–ª–æ—Ç–æ'},
  {t:13,nm:'–ö–æ—Ä—Ç–µ–∫—Å',                em:'üß¨',desc:'–°–∏–Ω—Ç–µ–∑ ¬∑ —É—Ä–æ–≤–µ–Ω—å 83 ¬∑ 5 –º–æ–¥–æ–≤',       bonus:'x2 –ª—É—Ç + XP'},
  {t:14,nm:'–£—Å—ã–ø–∞–ª—å–Ω–∏—Ü–∞ –í–∞–∞–ª–∞',        em:'üè∫',desc:'–ó–∞—Ä—è–∂–µ–Ω–Ω—ã–π –õ–∞–±–∏—Ä–∏–Ω—Ç ¬∑ —É–Ω–∏–∫. –¥—Ä–æ–ø',   bonus:'+2 —É–Ω–∏–∫–∞'},
  {t:15,nm:'–õ–æ–≥–æ–≤–æ –í–æ–ª—á—å–µ–π –°—Ç–∞–∏',    em:'üê∫',desc:'+150%IIQ ¬∑ +4 –∫–∞—Ä—Ç—ã –æ—Ç –±–æ—Å—Å–∞',       bonus:'+4 –∫–∞—Ä—Ç—ã'},
  {t:16,nm:'–ó–∞—Ä–∞–∂—ë–Ω–Ω—ã–π –ü–ª–∞—Ü–¥–∞—Ä–º',    em:'üí´',desc:'–•–∞—Ä–±–∏–Ω–¥–∂–µ—Ä—ã ¬∑ +20 –æ—Å–æ–±—ã—Ö –≤—Ä–∞–≥–æ–≤',    bonus:'x3 –ª—É—Ç'},
];
const UNIQ_MAP_NAMES=UNIQ_MAPS.map(m=>m.nm); // compat

// ‚îÄ‚îÄ ENDGAME BOSSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GUARDIAN_MAPS=[
  {id:'g_hydra',    nm:'–õ–æ–≥–æ–≤–æ –ì–∏–¥—Ä—ã',       em:'üêç',boss:'–ì–∏–¥—Ä–∞',    type:'shaper',t:16,dgr:820,time:50,g:[900,1400],md:0,mx:16},
  {id:'g_minotaur', nm:'–õ–∞–±–∏—Ä–∏–Ω—Ç –ú–∏–Ω–æ—Ç–∞–≤—Ä–∞', em:'üêÇ',boss:'–ú–∏–Ω–æ—Ç–∞–≤—Ä', type:'shaper',t:16,dgr:820,time:50,g:[900,1400],md:0,mx:16},
  {id:'g_phoenix',  nm:'–ì–æ—Ä–Ω–∏–ª–æ –§–µ–Ω–∏–∫—Å–∞',    em:'üî•',boss:'–§–µ–Ω–∏–∫—Å',   type:'shaper',t:16,dgr:820,time:50,g:[900,1400],md:0,mx:16},
  {id:'g_chimera',  nm:'–Ø–º–∞ –•–∏–º–µ—Ä—ã',         em:'ü¶Å',boss:'–•–∏–º–µ—Ä–∞',   type:'shaper',t:16,dgr:820,time:50,g:[900,1400],md:0,mx:16},
];
const BOSSES=[
  {id:'shaper', nm:'–°–æ–∑–¥–∞—Ç–µ–ª—å',       em:'üí†',desc:'–°—Ç—Ä–∞–∂ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –¢—Ä–µ–±—É–µ—Ç 4 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–∂–µ–π.',
   req:{shaper:4},dgr:1800,time:70,g:[3000,6000],t:16,md:0,mx:16,
   uniqPool:['–ö–æ–ª—å—Ü–æ –°–æ–∑–¥–∞—Ç–µ–ª—è','–ö–ª–∏–Ω–æ–∫ –°–æ–∑–¥–∞—Ç–µ–ª—è','–û—Ä–± –°–æ–∑–∏–¥–∞–Ω–∏—è','–¢—é—Ä—å–º–∞ –°–æ–∑–¥–∞—Ç–µ–ª—è']},
  {id:'exarch', nm:'–ü–ª–∞–º–µ–Ω–Ω—ã–π –≠–∫–∑–∞—Ä—Ö',em:'üî•',desc:'–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –ø—ã–ª–∞—é—â–∏—Ö –∑–≤—ë–∑–¥. –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 28 T16 –∫–∞—Ä—Ç.',
   req:{},dgr:1400,time:55,g:[2000,4000],t:16,md:0,mx:16,
   uniqPool:['–ß—ë—Ä–Ω–∞—è –ó–≤–µ–∑–¥–∞','–í–µ–Ω–µ—Ü –ü–ª–∞–º–µ–Ω–∏','–î–æ—Å–ø–µ—Ö –≠–∫–∑–∞—Ä—Ö–∞','–ö–æ–ª—å—Ü–æ –≠–∫–∑–∞—Ä—Ö–∞']},
  {id:'eater',  nm:'–ü–æ–∂–∏—Ä–∞—Ç–µ–ª—å –ú–∏—Ä–æ–≤',em:'üåë',desc:'–ü—É—Å—Ç–æ—Ç–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –∏–∑-–∑–∞ –ì—Ä–∞–Ω–∏. –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 28 T16 –∫–∞—Ä—Ç.',
   req:{},dgr:1400,time:55,g:[2000,4000],t:16,md:0,mx:16,
   uniqPool:['–°–µ–º—è –ü—É—Å—Ç–æ—Ç—ã','–ü–æ–∂–∏—Ä–∞—é—â–∏–π –û—Å–∫–æ–ª–æ–∫','–©–∏—Ç –ü–æ–∂–∏—Ä–∞—Ç–µ–ª—è','–ö–æ–ª—å—Ü–æ –ü—É—Å—Ç–æ—Ç—ã']},
];
const ACHDEFS=[
  {id:'first_run', ico:'üó∫',nm:'–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏',    ds:'–ü—Ä–æ–π—Ç–∏ –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç—É',          rw:'+30üí∞'},
  {id:'t5_clear',  ico:'üå≤',nm:'–ü—Ä–æ–∫–ª—è—Ç—ã–π –ª–µ—Å',  ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T5',              rw:'+50üí∞'},
  {id:'t10_clear', ico:'üíÄ',nm:'–ù–µ–∫—Ä–æ–º–∞–Ω—Ç',       ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T10',             rw:'+150üí∞'},
  {id:'t16_clear', ico:'üí´',nm:'–ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü',      ds:'–ü—Ä–æ–π—Ç–∏ –∫–∞—Ä—Ç—É T16',             rw:'+500üí∞'},
  {id:'hire3',     ico:'üë•',nm:'–ö–æ–º–∞–Ω–¥–∞',         ds:'–ù–∞–Ω—è—Ç—å 3 —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤',          rw:'+100üí∞'},
  {id:'runs50',    ico:'üîÑ',nm:'–í–µ—Ç–µ—Ä–∞–Ω',         ds:'–ü—Ä–æ–π—Ç–∏ 50 –∫–∞—Ä—Ç',               rw:'+200üí∞'},
  {id:'runs200',   ico:'‚öîÔ∏è',nm:'–ú–∞—Å—Ç–µ—Ä',         ds:'–ü—Ä–æ–π—Ç–∏ 200 –∫–∞—Ä—Ç',              rw:'+1000üí∞'},
  {id:'items20',   ico:'üéí',nm:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',   ds:'–ù–∞–π—Ç–∏ 20 –ø—Ä–µ–¥–º–µ—Ç–æ–≤',           rw:'+80üí∞'},
  {id:'rare_item', ico:'üåü',nm:'–ü–µ—Ä–≤–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å', ds:'–ù–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç',         rw:'+60üí∞'},
  {id:'uniq_item', ico:'üíé',nm:'–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å',   ds:'–ù–∞–π—Ç–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç',     rw:'+250üí∞'},
  {id:'sell500',   ico:'üí∞',nm:'–¢–æ—Ä–≥–æ–≤–µ—Ü',        ds:'–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞ 500üí∞',   rw:'+100üí∞'},
  {id:'all16',     ico:'üåê',nm:'–ê—Ç–ª–∞—Å –∑–∞–≤–µ—Ä—à—ë–Ω', ds:'–ü—Ä–æ–π—Ç–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤',          rw:'–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –í–æ–∑–≤—ã—à–µ–Ω–∏–µ'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshG(){
  return {gold:50,totalRuns:0,maps:{1:5,2:2},inv:[],workers:[],
    ups:{slots:0,rescue:0,heal:0},
    selfEq:{weapon:null,armor:null,helmet:null,ring:null},
    selfRun:null,actRun:null,selMap:null,maxTier:2,
    cleared:{},achs:{},prestige:0,prestigeBonus:0,
    guardianPieces:{shaper:0,elder:0},bossAttempts:{},bossKills:{},bossTriesLeft:0,activeBossId:null,t16RunsSinceBoss:0,pendingBoss:null,
    selfCls:null,selfXp:0,selfLevel:0,selfPendingLevel:0,selfLevelUp:false,clsLocked:false,
    stats:{ge:0,fi:0,mr:0,ar:0,sold:0,sg:0,cap:0,inj:0,tierRuns:{}},achsPending:{},
    gt:0,iid:0,wid:0};
}
let G=freshG();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const fN=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':Math.floor(n)+'';
const qcol=q=>({normal:'#b0b0b0',magic:'#8888ff',rare:'#f0d060',unique:'#e87020'}[q]||'#fff');
const qlbl=q=>({normal:'–û–±—ã—á–Ω—ã–π',magic:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π',rare:'–†–µ–¥–∫–∏–π',unique:'–£–Ω–∏–∫–∞–ª—å–Ω—ã–π'}[q]||q);
const tcol=t=>t<=3?'#aaa':t<=6?'#5599ff':t<=10?'#bb55ff':t<=14?'#ff8844':'#ff4422';
const calcCh=(power,tier,dgrOverride)=>{
  const t=Math.max(1,Math.min(16,tier||1));
  const d=dgrOverride||MAP_TIERS[t-1].dgr;
  return Math.max(0.03,Math.min(0.97,(power/d-0.2)/0.7));
};
// Parse any map key (normal "5", cursed "c5", uniq "u5", guardian "grd_g_hydra") ‚Üí tier int
const parseMapKey=k=>{
  const s=String(k);
  if(s.startsWith('grd_')||s.startsWith('boss_'))return 16;
  if(s.startsWith('c')||s.startsWith('u'))return parseInt(s.slice(1))||1;
  return parseInt(s)||1;
};
// Get md object for any map key
const getMd=k=>{
  const s=String(k);
  if(s.startsWith('grd_')){const gm=GUARDIAN_MAPS.find(g=>'grd_'+g.id===s);return gm||MAP_TIERS[15];}
  if(s.startsWith('boss_')){const b=BOSSES.find(b2=>'boss_'+b2.id===s);return b||BOSSES[0];}
  return MAP_TIERS[(parseMapKey(k)-1)]||MAP_TIERS[0];
};
const chcol=ch=>ch>=0.8?'#4acf4a':ch>=0.5?'#cfcf4a':ch>=0.25?'#cf8040':'#cf4040';
const iDmg=(it,cls)=>{if(!it||!it.mods)return 0;const r=CDMG[cls]||[];return Math.floor(it.mods.reduce((s,m)=>s+(r.includes(m.stat)?m.value*1:m.value*.08),0));};
const iSurv=(it,cls)=>{if(!it||!it.mods)return 0;const r=CSURV[cls]||[];return Math.floor(it.mods.reduce((s,m)=>s+(r.includes(m.stat)?m.value*1:m.value*.08),0));};
const sDmg=()=>{const sc=G.selfCls||'warrior';let v=3+G.selfLevel*2;SLOTS.forEach(s=>{if(G.selfEq[s])v+=iDmg(G.selfEq[s],sc);});return v;};
const sSurv=()=>{const sc=G.selfCls||'warrior';let v=5+G.selfLevel*2;SLOTS.forEach(s=>{if(G.selfEq[s])v+=iSurv(G.selfEq[s],sc);});return v;};
function recalcW(w){let d=4+w.level*2,s=4+w.level*2;SLOTS.forEach(sl=>{if(w.eq[sl]){d+=iDmg(w.eq[sl],w.cls);s+=iSurv(w.eq[sl],w.cls);}});w.dmg=d;w.surv=s;}
function addXPSelf(amt){
  G.selfXp+=amt;const mx=WLVLS.length-1;
  while(G.selfXp>=WLVLS[Math.min(mx,G.selfPendingLevel+1)]&&G.selfPendingLevel<mx){G.selfPendingLevel++;G.selfLevelUp=true;log('‚≠ê –£—Ä–æ–≤–µ–Ω—å '+(G.selfPendingLevel)+' –≥–æ—Ç–æ–≤! –ù–∞–∂–º–∏—Ç–µ üÜô','info');showN('üÜô –£—Ä.'+G.selfPendingLevel+' –≥–æ—Ç–æ–≤!','pur');}
}
function addXP(w,amt){
  w.xp+=amt;const mx=WLVLS.length-1;
  while(w.level<mx&&w.xp>=WLVLS[w.level+1]){w.level++;recalcW(w);log('‚≠ê '+w.name+' ‚Äî –£—Ä.'+w.level+'!','info');showN(w.name+' ‚Äî –£—Ä.'+w.level+'!','pur');}
}
const xpAmt=tier=>tier*8+12;
// Gold formula: rand(mapCost, mapCost*(1+variance)) * prestige
// variance = (g1-g0)/g0 ‚Äî natural spread of the tier
const goldReward=(md,_power,mapCost=0)=>{
  const pm=1+(G.prestigeBonus||0)/100;
  const base=mapCost||md.g[0]||1;
  const variance=(md.g[1]-md.g[0])/Math.max(1,md.g[0]);
  const rnd=base+Math.floor(Math.random()*(base*variance+1));
  return Math.floor(rnd*pm);
};
const goldMin=(md,mapCost=0)=>{
  const pm=1+(G.prestigeBonus||0)/100;
  return Math.floor((mapCost||md.g[0]||1)*pm);
};
const goldMax=(md,mapCost=0)=>{
  const pm=1+(G.prestigeBonus||0)/100;
  const base=mapCost||md.g[0]||1;
  const variance=(md.g[1]-md.g[0])/Math.max(1,md.g[0]);
  return Math.floor(base*(1+variance)*pm);
};
const canPrestige=()=>[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].every(t=>G.cleared[t]);

function genItem(tier,workerCls){
  let pool=IBASES;
  if(workerCls)pool=Math.random()<.72?IBASES.filter(b=>b.cls===workerCls):IBASES;
  if(!pool.length)pool=IBASES;
  const base=pool[Math.floor(Math.random()*pool.length)];
  const r=Math.random();
  const quality=tier>=16&&r<.18?'unique':tier>=14&&r<.12?'unique':tier>=10&&r<.07?'unique':tier>=5&&r<.28?'rare':r<.60?'magic':'normal';
  const cnt={normal:1,magic:ri(1,2),rare:ri(3,5),unique:4}[quality];
  // Unique items are 1.4x stronger than rare
  const qm={normal:1,magic:1.25,rare:1.6,unique:2.24}[quality];
  const mods=[...base.mods].sort(()=>Math.random()-.5).slice(0,cnt).map(stat=>({stat,value:Math.floor((tier*2+ri(3,12))*qm)}));
  const sp=Math.floor({normal:3,magic:8,rare:22,unique:75}[quality]*(1+tier*.35));
  const pfx=NPFX[base.cls]||NPFX.generic,sfx=NSFX[base.cls]||NSFX.generic;
  const nm=quality==='normal'?base.nm:quality==='magic'?pfx[ri(0,pfx.length-1)]+' '+base.nm:pfx[ri(0,pfx.length-1)]+' '+base.nm+' '+sfx[ri(0,sfx.length-1)];
  return {id:++G.iid,name:nm,em:base.em,cls:base.cls,slot:base.slot,quality,mods,tier,sellPrice:sp};
}
function tryItem(md,cls,mult=1){
  if(Math.random()>md.drop*mult)return;
  const it=genItem(md.t,cls);G.inv.push(it);G.stats.fi++;
  log(it.em+' <span style="color:'+qcol(it.quality)+'">'+it.name+'</span> ['+qlbl(it.quality)+']','i-'+it.quality[0]);
  checkAchs();
}
function tryMap(md){
  if(!md||!md.t)return; // guardian/boss maps have no .md drop field
  if(Math.random()>(md.md||0))return;
  const dt=Math.max(1,Math.min(16,(md.t||16)+ri(0,Math.min(3,(md.mx||16)-(md.t||16)))));
  // Guardian maps drop from T16
  if(md.t>=14&&Math.random()<.25){
    const gm=GUARDIAN_MAPS[Math.floor(Math.random()*GUARDIAN_MAPS.length)];
    G.maps['grd_'+gm.id]=(G.maps['grd_'+gm.id]||0)+1;
    log('üî∑ –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞–∂–∞ ¬´'+gm.nm+'¬ª —É–ø–∞–ª–∞!','ev');
    renderMaps();return;
  }
  if(md.t>=12&&Math.random()<.10){
    const uPool=UNIQ_MAPS.filter(m=>m.t<=dt);const uMap=uPool.length?uPool[Math.floor(Math.random()*uPool.length)]:UNIQ_MAPS[UNIQ_MAPS.length-1];
    G.maps['u'+dt]=(G.maps['u'+dt]||0)+1;
    G.uniqMapData=G.uniqMapData||{};G.uniqMapData['u'+dt]=uMap;
    log('üó∫üü† –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´'+uMap.nm+'¬ª T'+dt+' —É–ø–∞–ª–∞!','ev');
    renderMaps();return;
  }
  if(Math.random()<.12){G.maps['c'+dt]=(G.maps['c'+dt]||0)+1;log('üó∫üíú –ó–∞—Ä–∞–∂—ë–Ω–Ω–∞—è T'+dt+'!','ev');}
  else{G.maps[dt]=(G.maps[dt]||0)+1;log('üó∫ –ö–∞—Ä—Ç–∞ T'+dt+' —É–ø–∞–ª–∞','info');}
  renderMaps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RUNS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selfRun(){
  if(!G.selMap){showN('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É!');return;}
  if(G.selfRun){showN('–£–∂–µ –≤ –ø–æ—Ö–æ–¥–µ!');return;}
  if(G.actRun){showN('–£–∂–µ –≤ –∞–∫—Ç–µ!');return;}
  const key=String(G.selMap);
  const cursed=key.startsWith('c');
  const uniq=key.startsWith('u');
  const isGrd=key.startsWith('grd_');
  const isBoss=key.startsWith('boss_');
  const tier=cursed||uniq?parseInt(key.slice(1)):(isGrd||isBoss)?16:parseInt(key);
  const bossId=isBoss?key.slice(5):null;
  const grdMapData=isGrd?GUARDIAN_MAPS.find(g=>'grd_'+g.id===key):null;
  const bossData=isBoss?BOSSES.find(b=>b.id===bossId):null;
  if(isBoss){
    const isAltBoss=bossId==='exarch'||bossId==='eater';
    if(isAltBoss){
      if(G.pendingBoss!==bossId&&G.bossTriesLeft<=0){showN('–≠—Ç–æ—Ç –±–æ—Å—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!');return;}
      if(G.bossTriesLeft<=0){G.pendingBoss=null;G.bossTriesLeft=6;G.activeBossId=bossId;log('üí• '+bossData.nm+' –≤—ã–∑–≤–∞–Ω! 6 –ø–æ–ø—ã—Ç–æ–∫.','ev');}
    } else {
      const pcs=G.guardianPieces.shaper||0;
      if(pcs<4&&G.bossTriesLeft<=0){showN('–ù—É–∂–Ω–æ 4 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –°–æ–∑–¥–∞—Ç–µ–ª—è!');return;}
      if(pcs>=4&&G.bossTriesLeft<=0){
        Object.entries(bossData.req).forEach(([k2,v2])=>{G.guardianPieces[k2]=Math.max(0,(G.guardianPieces[k2]||0)-v2);});
        G.bossTriesLeft=6;G.activeBossId=bossId;log('üí† –°–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–∏–∑–≤–∞–Ω! 6 –ø–æ–ø—ã—Ç–æ–∫.','ev');
      }
    }
  } else {
    if(!(G.maps[key]>0)){showN('–ù–µ—Ç –∫–∞—Ä—Ç!');return;}
    G.maps[key]--;
  }
  // Lock class on first run
  G.clsLocked=true;
  if(!G.selfCls)G.selfCls='warrior';
  const md=isGrd?(grdMapData||MAP_TIERS[15]):isBoss?(bossData||BOSSES[0]):MAP_TIERS[tier-1];
  const cost=(isGrd||isBoss)?0:SHOP_COSTS[tier]||0;
  const _mc=(isGrd||isBoss)?0:SHOP_COSTS[tier]||0;
  G.selfRun={md,tier,cursed,uniq,isGrd,isBoss,grdId:isGrd?key.slice(4):null,bossId,elapsed:0,cost,
    goldRange:[goldMin(md,_mc),goldMax(md,_mc)]};
  document.getElementById('rpw').style.display='block';
  document.getElementById('btn-cancel-run').style.display='inline-block';
  document.getElementById('btn-self-run').disabled=true;
  document.getElementById('rpl').textContent=(isGrd?'üî∑ ':(cursed?'üíú ':uniq?'üü† ':'')+'')+md.em+' '+(isGrd&&md.boss?md.boss:md.nm)+' ['+(isGrd?'–°—Ç—Ä–∞–∂':isBoss?'–ë–û–°–°':'T'+tier)+']';
  updateRunVis(md,false,isGrd,isBoss);renderMaps();
  log('‚ö° –ü–æ—Ä—Ç–∞–ª: '+(cursed?'üíú –ó–ê–†–ê–ñ–Å–ù–ù–ê–Ø ':uniq?'üü† –£–ù–ò–ö–ê–õ–¨–ù–ê–Ø ':'')+'T'+tier+' '+md.nm,'info');
}
function cancelRun(){if(!G.selfRun)return;G.selfRun=null;resetRunUI();log('‚ö† –û—Ç—Å—Ç—É–ø–∏–ª–∏.','ev');}
function resetRunUI(){
  document.getElementById('rpw').style.display='none';
  document.getElementById('btn-cancel-run').style.display='none';
  document.getElementById('btn-self-run').disabled=false;
  const f=document.getElementById('rpf');if(f)f.style.width='0%';
  const p=document.getElementById('rpp');if(p)p.textContent='0%';
}

function checkT16BossUnlock(){
  if(G.pendingBoss)return; // already have a boss pending
  G.t16RunsSinceBoss=(G.t16RunsSinceBoss||0)+1;
  if(G.t16RunsSinceBoss>=28){
    G.pendingBoss=Math.random()<.5?'exarch':'eater';
    G.t16RunsSinceBoss=0;
    const pb=BOSSES.find(b=>b.id===G.pendingBoss);
    log('üí• '+pb.nm+' –ø—Ä–æ–±—É–¥–∏–ª—Å—è! –ü–æ—Ä—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω.','ev');
    showN('üí• '+pb.nm+' –≤—ã–∑–≤–∞–Ω!','pur');
    renderMaps();
  }
}
function completeSelfRun(){
  // Save everything from selfRun BEFORE nulling it
  const {md,tier,cursed,uniq,isGrd,isBoss,grdId,bossId,cost}=G.selfRun;
  const grdMapData=grdId?GUARDIAN_MAPS.find(g=>g.id===grdId):null;
  const bossMapData=bossId?BOSSES.find(b=>b.id===bossId):null;
  const power=sDmg()+sSurv();
  // Cursed/uniq = 1 tier harder, grd/boss use their own dgr
  const effTier=tier+(cursed?1:0)+(uniq?1:0);
  const chMod=(isGrd?-.15:0)+(isBoss?-.05:0);
  if(isBoss&&bossMapData){
    // Boss: uncapped chance, requires significantly more power
    const bossDgr=bossMapData.dgr;
    const rawCh=(power/bossDgr-0.2)/0.7;
    const bossCap=bossId==='shaper'?0.70:0.80;
    const bossCh=Math.max(.03,Math.min(bossCap,rawCh)+chMod);
    var ch=bossCh;
  } else {
    const bossDgr=null;
    var ch=Math.max(.03,calcCh(power,Math.min(16,effTier))+chMod);
  }
  const ok=Math.random()<ch;
  G.stats.mr++;G.totalRuns++;
  if(!G.stats.tierRuns)G.stats.tierRuns={};
  G.stats.tierRuns[tier]=(G.stats.tierRuns[tier]||0)+1;
  G.selfRun=null;resetRunUI();  // null AFTER extracting all data
  if(ok){
    const lm=cursed?3:uniq?2:1;
    if(!isGrd&&!isBoss){G.cleared[tier]=true;if(tier>G.maxTier)G.maxTier=tier;}
    if(isBoss&&bossMapData){
      G.bossKills[bossId]=(G.bossKills[bossId]||0)+1;
      G.bossTriesLeft=0;G.activeBossId=null;if(bossId==='exarch'||bossId==='eater')G.pendingBoss=null;
      // Drop boss unique item
      // Real PoE Shaper unique items (translated)
      // Boss drop pools by id
      const _bossPools={
        shaper:[
          {nm:'–ó–≤—ë–∑–¥–Ω–∞—è –ö—É–∑–Ω—è',         em:'‚öîÔ∏è',slot:'weapon',mods:[{stat:'dmgPhys',value:350},{stat:'critChance',value:70},{stat:'str',value:100},{stat:'atkSpd',value:50}]},
          {nm:'–≠—Ñ–µ–º–µ—Ä–Ω–æ–µ –õ–µ–∑–≤–∏–µ',       em:'üí´',slot:'weapon',mods:[{stat:'dmgSpell',value:320},{stat:'energyShield',value:180},{stat:'critSpell',value:65},{stat:'int',value:90}]},
          {nm:'–ü—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ –°–æ–∑–¥–∞—Ç–µ–ª—è',em:'üß§',slot:'armor', mods:[{stat:'armor',value:300},{stat:'energyShield',value:250},{stat:'hp',value:300},{stat:'allRes',value:90}]},
          {nm:'–°–µ–º—è –°–æ–∑–¥–∞—Ç–µ–ª—è',         em:'üí†',slot:'armor', mods:[{stat:'energyShield',value:400},{stat:'int',value:120},{stat:'allRes',value:80},{stat:'dmgSpell',value:150}]},
          {nm:'–ö–æ—Ä–æ–Ω–∞ –ê–∞—Ä—É–ª—è',          em:'üëë',slot:'helmet',mods:[{stat:'hp',value:350},{stat:'allRes',value:80},{stat:'dmgSpell',value:180},{stat:'critSpell',value:50}]},
          {nm:'–ö–æ–ª—å—Ü–æ –°–æ–∑–∏–¥–∞–Ω–∏—è',       em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:90},{stat:'hp',value:250},{stat:'dmgPhys',value:150},{stat:'str',value:70}]},
        ],
        exarch:[
          {nm:'–ß—ë—Ä–Ω–∞—è –ó–≤–µ–∑–¥–∞',      em:'üåü',slot:'weapon',mods:[{stat:'dmgPhys',value:300},{stat:'dmgSpell',value:220},{stat:'critChance',value:55},{stat:'str',value:90}]},
          {nm:'–í–µ–Ω–µ—Ü –ü–ª–∞–º–µ–Ω–∏',      em:'üî•',slot:'helmet',mods:[{stat:'hp',value:320},{stat:'allRes',value:75},{stat:'dmgSpell',value:200},{stat:'critSpell',value:45}]},
          {nm:'–î–æ—Å–ø–µ—Ö –≠–∫–∑–∞—Ä—Ö–∞',     em:'üõ°Ô∏è',slot:'armor', mods:[{stat:'armor',value:320},{stat:'hp',value:280},{stat:'allRes',value:85},{stat:'energyShield',value:180}]},
          {nm:'–ö–æ–ª—å—Ü–æ –≠–∫–∑–∞—Ä—Ö–∞',     em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:80},{stat:'hp',value:220},{stat:'dmgSpell',value:140},{stat:'str',value:65}]},
        ],
        eater:[
          {nm:'–°–µ–º—è –ü—É—Å—Ç–æ—Ç—ã',       em:'üåë',slot:'weapon',mods:[{stat:'minionDmg',value:320},{stat:'dmgSpell',value:240},{stat:'int',value:110},{stat:'energyShield',value:160}]},
          {nm:'–ü–æ–∂–∏—Ä–∞—é—â–∏–π –û—Å–∫–æ–ª–æ–∫', em:'üíÄ',slot:'weapon',mods:[{stat:'dmgPhys',value:260},{stat:'critChance',value:50},{stat:'allRes',value:55},{stat:'str',value:85}]},
          {nm:'–©–∏—Ç –ü–æ–∂–∏—Ä–∞—Ç–µ–ª—è',     em:'üîµ',slot:'armor', mods:[{stat:'energyShield',value:380},{stat:'hp',value:260},{stat:'allRes',value:80},{stat:'int',value:100}]},
          {nm:'–ö–æ–ª—å—Ü–æ –ü—É—Å—Ç–æ—Ç—ã',     em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:85},{stat:'int',value:90},{stat:'dmgSpell',value:150},{stat:'critSpell',value:48}]},
        ],
      };
      const bossUniqPool2=_bossPools[bossId]||_bossPools.shaper;
      const bUI2=bossUniqPool2[Math.floor(Math.random()*bossUniqPool2.length)];
      const bItem={id:++G.iid,name:bUI2.nm,em:bUI2.em,cls:'warrior',slot:bUI2.slot,
        quality:'unique',mods:bUI2.mods,tier:16,sellPrice:5000};
      G.inv.push(bItem);G.stats.fi++;
      const bossGold=goldReward(bossMapData,power,0);G.gold+=bossGold;G.stats.ge+=bossGold;
      log('üí† '+bossMapData.nm+' –ø–æ–≤–µ—Ä–∂–µ–Ω! +'+bossGold+'üí∞ + üí† '+bUI2.nm,'ev');
      floatT('+'+bossGold+'üí∞','#44aaff');showN('üí† '+bossMapData.nm+' —É–±–∏—Ç!','pur');
      renderMaps();
    }
    if(isGrd){
      const gtype=(grdMapData&&grdMapData.type)||'shaper';
      G.guardianPieces[gtype]=(G.guardianPieces[gtype]||0)+1;
      const pieces=G.guardianPieces[gtype];
      log('üî∑ –°—Ç—Ä–∞–∂ –ø–æ–≤–µ—Ä–∂–µ–Ω! –§—Ä–∞–≥–º–µ–Ω—Ç –°–æ–∑–¥–∞—Ç–µ–ª—è: '+pieces+'/4','ev');
      showN('üî∑ –§—Ä–∞–≥–º–µ–Ω—Ç –°–æ–∑–¥–∞—Ç–µ–ª—è '+pieces+'/4','pur');
      checkBossUnlocks();
    }
    const suffix=cursed?' (x3 –ª—É—Ç)':uniq?' (x2 –ª—É—Ç)':isGrd?' [–°—Ç—Ä–∞–∂]':isBoss?'':'';
    if(!isBoss){const g=goldReward(md,power,cost);G.gold+=g;G.stats.ge+=g;log('‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ! +'+g+'üí∞'+suffix,'ge');floatT('+'+g+'üí∞','#f0d080');
      if(tier===16&&!cursed&&!uniq&&!isGrd)checkT16BossUnlock();
    }
    if(!isBoss){for(let i=0;i<lm;i++)tryItem(md,G.selfCls,1);tryMap(md);}
    addXPSelf(xpAmt(tier));
    checkAchs();renderAtlasBar();renderShop();
  }else{
    if(isBoss){
      G.bossTriesLeft=Math.max(0,(G.bossTriesLeft||0)-1);
      if(G.bossTriesLeft<=0){G.activeBossId=null;if(bossId==='exarch'||bossId==='eater')G.pendingBoss=null;}
      const bname=bossMapData?bossMapData.nm:'–ë–æ—Å—Å';
      log('üíÄ '+bname+' —É—Å—Ç–æ—è–ª! –û—Å—Ç–∞–ª–æ—Å—å '+G.bossTriesLeft+' –ø–æ–ø—ã—Ç–æ–∫.','ev');
      showN(bname+' –ø–æ–±–µ–¥–∏–ª! '+G.bossTriesLeft+' –æ—Å—Ç–∞–ª–æ—Å—å','red');
      renderMaps();
    } else {
      log('üíÄ –í—ã –ø–∞–ª–∏ –≤ T'+tier+(cursed?' [–ó–ê–†–ê–ñ–Å–ù–ù–ê–Ø]':uniq?' [–£–ù–ò–ö–ê–õ–¨–ù–ê–Ø]':isGrd?' [–°–¢–†–ê–ñ]':'')+'!','ev');
      showN('–í—ã –ø–æ–≥–∏–±–ª–∏!','red');
    }
  }
  const isBossCard=G.selMap&&String(G.selMap).startsWith('boss_');
  if(G.selMap&&!isBossCard){const selMd=getMd(G.selMap);const _sg=String(G.selMap);updateRunVis(selMd,true,_sg.startsWith('grd_'),_sg.startsWith('boss_'));}else updateRunVis(null);
  renderMaps();renderInv();renderUpgrades();updateRes();
}
function updateRunVis(md,idle,isGrd,isBoss){
  const el=document.getElementById('run-con');if(!el)return;
  if(!md){
    const showActHint=G.selfLevel<2;
    el.innerHTML=showActHint
      ?'<div style="text-align:center;padding:8px"><div style="font-size:20px;margin-bottom:6px">üèï</div>'+
        '<div style="font-size:13px;color:var(--gold);font-weight:600;margin-bottom:4px">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –ê–∫—Ç—ã!</div>'+
        '<div style="font-size:12px;color:var(--txt-d)">–í–∫–ª–∞–¥–∫–∞ üèï –ê–ö–¢–´ ‚Üí –ø–æ–ª—É—á–∏—Ç–µ —É—Ä–æ–≤–Ω–∏ –ø–µ—Ä–µ–¥ –∫–∞—Ä—Ç–∞–º–∏.<br>–ë–µ–∑ –ø—Ä–æ–∫–∞—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –±—É–¥–µ—Ç ~30% —à–∞–Ω—Å.</div></div>'
      :'<div class="dim" style="font-style:italic">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Å–ª–µ–≤–∞</div>';
    return;
  }
  const col=isGrd?'#44aaff':tcol(md.t);
  let ch='';if(idle){const _sk=String(G.selMap||'');const _eff=md.t+(_sk.startsWith('c')?1:0)+(_sk.startsWith('u')?1:0);const cv=calcCh(sDmg()+sSurv(),Math.min(16,_eff));ch='<div style="margin-top:4px;font-size:12px;color:'+chcol(cv)+'">–í–∞—à —à–∞–Ω—Å: '+Math.round(cv*100)+'%</div>';}
  const cost=SHOP_COSTS[md.t]||0;
  el.innerHTML='<div class="run-nm" style="color:'+col+'">'+md.em+' '+(isGrd&&md.boss?md.boss:md.nm)+'</div>'+
    '<div class="dim" style="font-size:10px;letter-spacing:2px;margin-bottom:4px">'+(isGrd?'–ö–ê–†–¢–ê –°–¢–†–ê–ñ–ê':isBoss?'–ü–û–†–¢–ê–õ –°–û–ó–î–ê–¢–ï–õ–Ø':'–ö–ê–†–¢–ê –¢–ò–†–ê '+md.t)+'</div>'+
    '<div style="font-size:12px;color:var(--txt-d)">‚è± ~'+md.time+'—Å &nbsp; üí∞'+(goldMin(md,cost))+(goldMax(md,cost)>goldMin(md,cost)?'-'+goldMax(md,cost):'')+' + –ø—Ä–µ–¥–º–µ—Ç—ã</div>'+ch;
}
function startAct(id){
  if(G.actRun){showN('–£–∂–µ –≤ –∞–∫—Ç–µ!');return;}if(G.selfRun){showN('–£–∂–µ –≤ –ø–æ—Ö–æ–¥–µ!');return;}
  const act=ACTS.find(a=>a.id===id);if(!act)return;
  G.actRun={act,elapsed:0};const btn=document.getElementById('abtn-'+id);if(btn)btn.disabled=true;
  log('üèï –û—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å: '+act.nm,'info');
}
function completeAct(){
  const act=G.actRun.act;const g=ri(act.g[0],act.g[1]);G.gold+=g;G.stats.ge+=g;G.stats.ar++;G.actRun=null;
  // Acts give small self XP
  const xpGain=Math.floor(xpAmt(1)*1.5);addXPSelf(xpGain);
  log('üèï '+act.nm+' –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî +'+g+'üí∞ +'+xpGain+'XP','ge');floatT('+'+g+'üí∞','#c8a96e');
  const btn=document.getElementById('abtn-'+act.id);if(btn)btn.disabled=false;
  const fill=document.getElementById('apf-'+act.id);if(fill)fill.style.width='0%';
  updateRes();
}
function sendWorker(id){
  if(!G.selMap){showN('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É!');return;}
  const w=G.workers.find(x=>x.id===id);if(!w||w.status!=='idle')return;
  const running=G.workers.filter(x=>x.status==='running'||x.status==='exp').length;
  const maxS=1+G.ups.slots;
  if(running>=maxS){showN('–ù—É–∂–µ–Ω –∞–ø–≥—Ä–µ–π–¥ –ú–∞—à–∏–Ω—ã –¥–ª—è –µ—â—ë –æ–¥–Ω–æ–≥–æ —Å–ª–æ—Ç–∞!');return;}
  const key=String(G.selMap);
  const cursed=key.startsWith('c');
  const uniq=key.startsWith('u');
  const isGrd=key.startsWith('grd_');
  const isBossW=key.startsWith('boss_');
  if(isBossW){showN('–†–∞–±–æ—Ç–Ω–∏–∫–∏ –Ω–µ –º–æ–≥—É—Ç –∏–¥—Ç–∏ –∫ –±–æ—Å—Å—É!');return;}
  const tier=cursed||uniq?parseInt(key.slice(1)):isGrd?16:parseInt(key);
  const grdMapData=isGrd?GUARDIAN_MAPS.find(g=>'grd_'+g.id===key):null;
  if(!(G.maps[key]>0)){showN('–ù–µ—Ç –∫–∞—Ä—Ç!');return;}
  G.maps[key]--;
  w.status='running';w.curMap=tier;w.curMapKey=key;w.cursed=cursed;w.uniq=uniq;w.isGrd=isGrd;w.elapsed=0;w.prog=0;
  log('üöÄ '+w.name+' ‚Üí '+(cursed?'üíú ':uniq?'üü† ':'')+'T'+tier,'info');
  renderWorkers();renderMaps();
}
function resolveWorker(w,md){
  const power=w.dmg+w.surv;
  const wEffTier=md.t+(w.cursed?1:0)+(w.uniq?1:0);
  const ch=Math.max(.03,calcCh(power,Math.min(16,wEffTier)));
  const ok=Math.random()<ch;
  G.stats.mr++;G.totalRuns++;w.runsCompleted=(w.runsCompleted||0)+1;
  if(!G.stats.tierRuns)G.stats.tierRuns={};
  G.stats.tierRuns[md.t]=(G.stats.tierRuns[md.t]||0)+1;
  if(!ok){
    if(Math.random()<.3){w.status='captured';w.capturedAt=G.gt;G.stats.cap++;log('‚õìÔ∏è '+w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω –Ω–∞ T'+w.curMap+'!','ev');showN(w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω!','red');return;}
    else{w.status='injured';w.injuredAt=G.gt;G.stats.inj++;log('üíî '+w.name+' —Ä–∞–Ω–µ–Ω –Ω–∞ T'+w.curMap+'!','ev');}
  }else{w.status='idle';}
  const cost=SHOP_COSTS[md.t]||0;
  const lm=w.cursed?3:w.uniq?2:1;
  const g=goldReward(md,power,cost);G.gold+=g;G.stats.ge+=g;
  if(!w.isGrd){G.cleared[md.t]=true;if(md.t>G.maxTier)G.maxTier=md.t;if(md.t===16&&!w.cursed&&!w.uniq)checkT16BossUnlock();}
  if(w.isGrd){
    const gtype=(md.type)||'shaper';
    G.guardianPieces[gtype]=(G.guardianPieces[gtype]||0)+1;
    log('üî∑ '+w.name+' –ø–æ–≤–µ—Ä–≥ —Å—Ç—Ä–∞–∂–∞! –§—Ä–∞–≥–º–µ–Ω—Ç –°–æ–∑–¥–∞—Ç–µ–ª—è: '+G.guardianPieces[gtype]+'/4','ev');
    showN('üî∑ –§—Ä–∞–≥–º–µ–Ω—Ç '+G.guardianPieces[gtype]+'/4','pur');
    checkBossUnlocks();renderMaps();
  }
  log('üí∞ '+w.name+' T'+md.t+(w.isGrd?' [–°—Ç—Ä–∞–∂]':w.cursed?' üíú':w.uniq?' üü†':'')+' +'+g+'üí∞'+(lm>1?' √ó'+lm:''),'ge');
  floatT('+'+g+'üí∞','#f0d080');
  for(let i=0;i<lm;i++)tryItem(md,w.cls,1);tryMap(md);addXP(w,xpAmt(md.t));
  // Small self XP from workers
  addXPSelf(Math.floor(xpAmt(md.t)*.25));
  w.prog=0;w.elapsed=0;checkAchs();renderAtlasBar();renderShop();renderUpgrades();renderWorkers();renderInv();updateRes();
}
function resolveExpStep(w){
  const tier=w.expTiers[w.expIdx];const md=MAP_TIERS[tier-1];const power=w.dmg+w.surv;
  // Chance based on hardest tier's fail chance * 1.5
  const hardest=Math.max(...w.expTiers);
  const failHard=1-calcCh(power,hardest);
  const ch=Math.max(.03,1-Math.min(.65,failHard*1.5));
  const ok=Math.random()<ch;
  G.stats.mr++;G.totalRuns++;
  if(!ok){
    if(Math.random()<.2){w.status='captured';w.capturedAt=G.gt;G.stats.cap++;log('‚õìÔ∏è '+w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω –≤ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ T'+tier+'!','ev');showN(w.name+' –∑–∞—Ö–≤–∞—á–µ–Ω!','red');}
    else{w.status='injured';w.injuredAt=G.gt;G.stats.inj++;log('üíî '+w.name+' —Ä–∞–Ω–µ–Ω –≤ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏!','ev');}
    w.expTiers=[];w.expIdx=0;renderWorkers();renderInv();updateRes();return;
  }
  const ecost=SHOP_COSTS[tier]||0;
  const g=Math.floor(goldReward(md,power,ecost)*1.2);G.gold+=g;G.stats.ge+=g;
  G.cleared[tier]=true;if(tier>G.maxTier)G.maxTier=tier;
  if(tier===16)checkT16BossUnlock();
  log('üí∞ '+w.name+' —ç–∫—Å–ø–µ–¥. T'+tier+' +'+g+'üí∞','ge');
  tryItem(md,w.cls,1.5);tryMap(md);addXP(w,xpAmt(tier));
  addXPSelf(Math.floor(xpAmt(tier)*.15));
  checkAchs();renderAtlasBar();renderShop();
  w.expIdx++;w.elapsed=0;w.prog=0;
  if(w.expIdx>=w.expTiers.length){
    w.status='idle';w.expTiers=[];w.expIdx=0;
    log('üéâ '+w.name+' –∑–∞–≤–µ—Ä—à–∏–ª —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é!','info');showN(w.name+' –∑–∞–≤–µ—Ä—à–∏–ª —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é!','pur');
  }
  renderWorkers();renderInv();updateRes();
}
function rescueW(id){
  const w=G.workers.find(x=>x.id===id);if(!w||w.status!=='captured')return;
  const cost=Math.floor((30+(w.curMap||1)*12)*(1-G.ups.rescue*.15));
  if(G.gold<cost){showN('–ù—É–∂–Ω–æ '+cost+'üí∞!');return;}
  G.gold-=cost;w.status='idle';
  log('üîì '+w.name+' –≤—ã–∫—É–ø–ª–µ–Ω –∑–∞ '+cost+'üí∞','info');showN(w.name+' –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω!','grn');
  renderWorkers();updateRes();
}
function sellItem(id){
  const it=G.inv.find(x=>x.id===id);if(!it)return;
  const sp=parseInt(it.sellPrice)||0;G.gold+=sp;G.stats.sg+=sp;G.stats.sold++;
  G.inv=G.inv.filter(x=>x.id!==id);
  log('üí∞ '+it.em+' '+it.name+' +'+it.sellPrice+'üí∞','ge');floatT('+'+it.sellPrice+'üí∞','#c8a96e');
  checkAchs();closeM();renderInv();updateRes();
}
function sellAllNormal(){
  const ns=G.inv.filter(x=>x.quality==='normal');if(!ns.length){showN('–ù–µ—Ç –æ–±—ã—á–Ω—ã—Ö!');return;}
  const tot=ns.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);G.inv=G.inv.filter(x=>x.quality!=='normal');
  G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=ns.length;
  log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+ns.length+'x –æ–±—ã—á–Ω—ã—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#c8a96e');
  checkAchs();renderInv();updateRes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOSS SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBossUnlocks(){
  BOSSES.forEach(b=>{
    // shaper uses fragments; exarch/eater use pendingBoss
    const isAlt=b.id==='exarch'||b.id==='eater';
    const ready=isAlt?(G.pendingBoss===b.id):(Object.entries(b.req).every(([k,v])=>(G.guardianPieces[k]||0)>=v));
    if(ready&&!G.bossAttempts[b.id]){
      log('üí† –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–∫—Ä—ã—Ç –¥–æ—Å—Ç—É–ø –∫ '+b.nm+'!','ev');
      showN('üí† '+b.nm+' –∂–¥—ë—Ç!','pur');
      renderUpgrades();
    }
  });
}
function tryBoss(id){
  const b=BOSSES.find(x=>x.id===id);if(!b)return;
  const ready=Object.entries(b.req).every(([k,v])=>(G.guardianPieces[k]||0)>=v);
  if(!ready){showN('–ù—É–∂–Ω—ã –≤—Å–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã!');return;}
  // Deduct fragments
  Object.entries(b.req).forEach(([k,v])=>{G.guardianPieces[k]=Math.max(0,(G.guardianPieces[k]||0)-v);});
  const power=sDmg()+sSurv();
  const ch=Math.max(.03,calcCh(power,16)*.6); // Bosses are much harder
  const ok=Math.random()<ch;
  G.bossAttempts[id]=(G.bossAttempts[id]||0)+1;
  if(ok){
    G.bossKills[id]=(G.bossKills[id]||0)+1;
    const g=Math.floor(Math.random()*(b.g[1]-b.g[0])+b.g[0]);G.gold+=g;G.stats.ge+=g;
    // Guaranteed unique item
    // Boss unique item ‚Äî proper slot based on item name, high power mods
    const _bp2={
      shaper:[
        {nm:'–ó–≤—ë–∑–¥–Ω–∞—è –ö—É–∑–Ω—è',         em:'‚öîÔ∏è',slot:'weapon',mods:[{stat:'dmgPhys',value:350},{stat:'critChance',value:70},{stat:'str',value:100},{stat:'atkSpd',value:50}]},
        {nm:'–≠—Ñ–µ–º–µ—Ä–Ω–æ–µ –õ–µ–∑–≤–∏–µ',       em:'üí´',slot:'weapon',mods:[{stat:'dmgSpell',value:320},{stat:'energyShield',value:180},{stat:'critSpell',value:65},{stat:'int',value:90}]},
        {nm:'–ü—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ –°–æ–∑–¥–∞—Ç–µ–ª—è',em:'üß§',slot:'armor', mods:[{stat:'armor',value:300},{stat:'energyShield',value:250},{stat:'hp',value:300},{stat:'allRes',value:90}]},
        {nm:'–°–µ–º—è –°–æ–∑–¥–∞—Ç–µ–ª—è',         em:'üí†',slot:'armor', mods:[{stat:'energyShield',value:400},{stat:'int',value:120},{stat:'allRes',value:80},{stat:'dmgSpell',value:150}]},
        {nm:'–ö–æ—Ä–æ–Ω–∞ –ê–∞—Ä—É–ª—è',          em:'üëë',slot:'helmet',mods:[{stat:'hp',value:350},{stat:'allRes',value:80},{stat:'dmgSpell',value:180},{stat:'critSpell',value:50}]},
        {nm:'–ö–æ–ª—å—Ü–æ –°–æ–∑–∏–¥–∞–Ω–∏—è',       em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:90},{stat:'hp',value:250},{stat:'dmgPhys',value:150},{stat:'str',value:70}]},
      ],
      exarch:[
        {nm:'–ß—ë—Ä–Ω–∞—è –ó–≤–µ–∑–¥–∞',   em:'üåü',slot:'weapon',mods:[{stat:'dmgPhys',value:300},{stat:'dmgSpell',value:220},{stat:'critChance',value:55},{stat:'str',value:90}]},
        {nm:'–í–µ–Ω–µ—Ü –ü–ª–∞–º–µ–Ω–∏',   em:'üî•',slot:'helmet',mods:[{stat:'hp',value:320},{stat:'allRes',value:75},{stat:'dmgSpell',value:200},{stat:'critSpell',value:45}]},
        {nm:'–î–æ—Å–ø–µ—Ö –≠–∫–∑–∞—Ä—Ö–∞',  em:'üõ°Ô∏è',slot:'armor', mods:[{stat:'armor',value:320},{stat:'hp',value:280},{stat:'allRes',value:85},{stat:'energyShield',value:180}]},
        {nm:'–ö–æ–ª—å—Ü–æ –≠–∫–∑–∞—Ä—Ö–∞',  em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:80},{stat:'hp',value:220},{stat:'dmgSpell',value:140},{stat:'str',value:65}]},
      ],
      eater:[
        {nm:'–°–µ–º—è –ü—É—Å—Ç–æ—Ç—ã',       em:'üåë',slot:'weapon',mods:[{stat:'minionDmg',value:320},{stat:'dmgSpell',value:240},{stat:'int',value:110},{stat:'energyShield',value:160}]},
        {nm:'–ü–æ–∂–∏—Ä–∞—é—â–∏–π –û—Å–∫–æ–ª–æ–∫', em:'üíÄ',slot:'weapon',mods:[{stat:'dmgPhys',value:260},{stat:'critChance',value:50},{stat:'allRes',value:55},{stat:'str',value:85}]},
        {nm:'–©–∏—Ç –ü–æ–∂–∏—Ä–∞—Ç–µ–ª—è',     em:'üîµ',slot:'armor', mods:[{stat:'energyShield',value:380},{stat:'hp',value:260},{stat:'allRes',value:80},{stat:'int',value:100}]},
        {nm:'–ö–æ–ª—å—Ü–æ –ü—É—Å—Ç–æ—Ç—ã',     em:'üíç',slot:'ring',  mods:[{stat:'allRes',value:85},{stat:'int',value:90},{stat:'dmgSpell',value:150},{stat:'critSpell',value:48}]},
      ],
    };
    const bossUniqPool=_bp2[bossId]||_bp2.shaper;
    const bUI=bossUniqPool[Math.floor(Math.random()*bossUniqPool.length)];
    const uniqIt={id:++G.iid,name:bUI.nm,em:bUI.em,cls:'warrior',slot:bUI.slot,
      quality:'unique',mods:bUI.mods,tier:16,sellPrice:5000};
    G.inv.push(uniqIt);G.stats.fi++;
    log('üí† '+b.nm+' –ø–æ–≤–µ—Ä–∂–µ–Ω! +'+g+'üí∞ + üí† '+uniqNm,'ev');showN('üí† '+b.nm+' —É–±–∏—Ç!','pur');
    renderInv();checkAchs();
  }else{
    log('üí† –í—ã –ø–∞–ª–∏ –ø–µ—Ä–µ–¥ '+b.nm+'!','ev');showN('üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç '+b.nm,'red');
  }
  G.selfRun=null;resetRunUI();renderUpgrades();updateRes();save();
  closeM();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkAchs(){
  function grant(id){
    if(G.achs[id])return;
    if(!G.achsPending)G.achsPending={};
    if(G.achsPending[id])return;
    G.achsPending[id]=true;
    const a=ACHDEFS.find(x=>x.id===id);
    if(a){log('üèÜ –ê–†–•–ò–í: '+a.nm+' ‚Äî –∑–∞–±–µ—Ä–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É!','info');showN('üèÜ '+a.nm+' ‚Äî –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ê—Ä—Ö–∏–≤!','pur');}
    updateAchBadge();renderAchs();
  }
  if(G.stats.mr>=1)grant('first_run');
  if(G.cleared[5])grant('t5_clear');
  if(G.cleared[10])grant('t10_clear');
  if(G.cleared[16])grant('t16_clear');
  if(G.workers.length>=3)grant('hire3');
  if(G.totalRuns>=50)grant('runs50');
  if(G.totalRuns>=200)grant('runs200');
  if(G.stats.fi>=20)grant('items20');
  const allEq=[...G.inv,...Object.values(G.selfEq),...G.workers.flatMap(w=>Object.values(w.eq))].filter(Boolean);
  if(allEq.some(x=>x.quality==='rare'))grant('rare_item');
  if(allEq.some(x=>x.quality==='unique'))grant('uniq_item');
  if(G.stats.sg>=500)grant('sell500');
  if(canPrestige())grant('all16');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRESTIGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doPrestige(){
  if(!canPrestige()){showN('–ù—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤ –¥–ª—è –í–æ–∑–≤—ã—à–µ–Ω–∏—è!');return;}
  const np=G.prestige+1,nb=np*15,kg=Math.floor(G.gold*.15);
  // Save lifetime stats and achievements across prestige
  const lstats={...G.stats};
  const lruns=G.totalRuns;
  const lachs={...G.achs};
  const lpend={...(G.achsPending||{})};
  G=freshG();
  G.prestige=np;G.prestigeBonus=nb;G.gold=kg+100;G.maps={1:5,2:3,3:1};
  G.stats=lstats;G.totalRuns=lruns;G.achs=lachs;G.achsPending=lpend;
  closeM();log('‚ú® –í–û–ó–í–´–®–ï–ù–ò–ï '+np+'! +'+nb+'% –∑–æ–ª–æ—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞!','info');showN('‚ú® –í–æ–∑–≤—ã—à–µ–Ω–∏–µ '+np+'!','pur');
  renderAll();save();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPEDITION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openExpedition(){
  if(!G.workers.length){showN('–ù–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!');return;}
  const idle=G.workers.filter(w=>w.status==='idle');
  // Don't block opening ‚Äî show 'no free workers' inside modal instead
  // Build tier availability (normal maps only)
  const tierCounts={};
  Object.keys(G.maps).filter(k=>!isNaN(k)&&G.maps[k]>0).forEach(k=>{
    const t=parseInt(k);tierCounts[t]=(tierCounts[t]||0)+G.maps[k];
  });
  if(Object.keys(tierCounts).length<1){showN('–ù–µ—Ç –∫–∞—Ä—Ç –¥–ª—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏!');return;}
  // Restore last selection if maps still available
  let initSlots=[null,null,null];
  if(G.lastExpSlots){
    const tc2={...tierCounts};
    initSlots=G.lastExpSlots.map(t=>{
      if(t!==null&&tc2[t]>0){tc2[t]--;return t;}return null;
    });
  }
  window._exp={slots:initSlots,wid:null,tierCounts};
  window._exp.render=function(){
    const {slots,wid,tierCounts}=window._exp;
    const selW=wid?G.workers.find(x=>x.id===wid):null;
    // Chance display
    let chHtml='';
    const filled=slots.filter(Boolean);
    if(selW&&filled.length===3){
      const hardest=Math.max(...filled);
      const failH=1-calcCh(selW.dmg+selW.surv,hardest);
      const stepCh=Math.max(.03,1-Math.min(.65,failH*1.5));
      const totalCh=Math.pow(stepCh,3); // all 3 steps must succeed
      chHtml='<div style="margin:8px 0;font-size:14px;background:var(--bg2);border:1px solid var(--brd);padding:6px">'+
        'üó∫ –®–∞–Ω—Å —É—Å–ø–µ—Ö–∞ –≤—Å–µ–π —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏: <b style="color:'+chcol(totalCh)+'">'+Math.round(totalCh*100)+'%</b>'+
        '<div style="font-size:11px;color:var(--txt-d);margin-top:2px">–ö–∞–∂–¥—ã–π —à–∞–≥ (T'+hardest+'): '+Math.round(stepCh*100)+'% ¬∑ –õ—É—Ç √ó1.5</div></div>';
    }
    // 3 slots
    let html='<div style="font-size:13px;color:var(--txt-d);margin-bottom:10px">–í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã –∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞. –ü—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ ‚Äî –∑–∞—Ö–≤–∞—Ç –∏–ª–∏ —Ä–∞–Ω–µ–Ω–∏–µ.</div>';
    html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">';
    slots.forEach((t,i)=>{
      const active=window._exp.pickSlot===i;
      html+='<div style="background:var(--bg4);border:2px solid '+(t?'var(--gold-d)':active?'var(--gold)':'var(--brd)')+';padding:8px;text-align:center;cursor:pointer;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center" data-xslot="'+i+'">';
      if(t){const md=MAP_TIERS[t-1];html+='<div style="font-size:18px">'+md.em+'</div><div style="font-size:13px;color:var(--gold)">T'+t+'</div><div style="font-size:10px;color:var(--txt-d)">'+md.nm.slice(0,9)+'</div><div style="font-size:10px;color:var(--red);cursor:pointer" data-xslot-clear="'+i+'">‚úï</div>';}
      else html+='<div style="font-size:24px;color:var(--brd)">+</div><div style="font-size:11px;color:var(--txt-d)">–°–ª–æ—Ç '+(i+1)+'</div>';
      html+='</div>';
    });
    html+='</div>';
    // Tier picker
    if(window._exp.pickSlot!==undefined){
      const si=window._exp.pickSlot;
      const used=slots.filter((s,ii)=>ii!==si&&s!==null);
      html+='<div style="font-size:12px;color:var(--txt-d);margin-bottom:6px">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è —Å–ª–æ—Ç–∞ '+(si+1)+':</div>';
      html+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">';
      Object.keys(tierCounts).map(Number).sort((a,b)=>a-b).forEach(t=>{
        const avail=tierCounts[t]-used.filter(x=>x===t).length;
        if(avail<=0)return;
        html+='<button class="btn btn-sm" data-xpick="'+t+'">T'+t+' ('+avail+')</button>';
      });
      html+='</div>';
    }
    html+=chHtml;
    // Worker
    html+='<div style="font-size:12px;color:var(--txt-d);margin-bottom:6px">–†–∞–±–æ—Ç–Ω–∏–∫:</div>';
    const currentIdle=G.workers.filter(w=>w.status==='idle');
    if(!currentIdle.length){
      html+='<div style="padding:10px;background:var(--bg2);border:1px solid var(--brd);color:var(--txt-d);font-size:13px;text-align:center">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</div>';
    }else{
      html+=currentIdle.map(iw=>{
        const sel=wid===iw.id;
        return '<div class="srow" style="cursor:pointer;border-color:'+(sel?'var(--gold)':'var(--brd)')+'" data-xworker="'+iw.id+'">'+
          '<div class="wavat" style="border-color:'+WCLS[iw.cls].col+'">'+WCLS[iw.cls].em+'</div>'+
          '<div class="si"><div class="snm">'+iw.name+' <span class="lvl-b">–£—Ä.'+iw.level+'</span></div>'+
          '<div style="font-size:12px;color:var(--txt-d)">‚öîÔ∏è'+iw.dmg+' üõ°'+iw.surv+'</div></div>'+
          (sel?'<span class="gt" style="font-size:16px">‚úì</span>':'')+'</div>';
      }).join('');
    }
    const canGo=slots.every(Boolean)&&wid&&currentIdle.find(w=>w.id===wid);
    html+='<div style="display:flex;gap:6px;margin-top:10px">'+
      '<button class="btn btn-p" id="btn-xgo"'+(canGo?'':' disabled')+'>üó∫ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>'+
      '<button class="btn btn-r btn-sm" id="btn-close-m">–û—Ç–º–µ–Ω–∞</button></div>';
    openM('üó∫ –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è',html);
  };
  window._exp.render();
}
function startExpedition(wid){
  const {slots,tierCounts}=window._exp;
  if(!slots.every(Boolean)){showN('–í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã!');return;}
  const w=G.workers.find(x=>x.id===wid);if(!w||w.status!=='idle')return;
  // Check availability
  const needed={};slots.forEach(t=>{needed[t]=(needed[t]||0)+1;});
  for(const t in needed){
    if((G.maps[parseInt(t)]||0)<needed[t]){showN('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞—Ä—Ç T'+t+'!');return;}
  }
  for(const t in needed){G.maps[parseInt(t)]=Math.max(0,(G.maps[parseInt(t)]||0)-needed[t]);}
  G.lastExpSlots=[...slots];
  w.status='exp';w.expTiers=[...slots];w.expIdx=0;w.elapsed=0;w.prog=0;w.curMap=slots[0];
  log('üó∫ '+w.name+' ‚Äî —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è: T'+slots.join(', T'),'info');
  renderWorkers();renderMaps();
  // Reopen expedition modal with fresh state (don't close)
  setTimeout(()=>openExpedition(),50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TICK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tick(){
  G.gt+=200;
  // Self run
  if(G.selfRun){
    G.selfRun.elapsed+=200;const pct=Math.min(1,G.selfRun.elapsed/(G.selfRun.md.time*1000));
    const f=document.getElementById('rpf');if(f)f.style.width=(pct*100)+'%';
    const p=document.getElementById('rpp');if(p)p.textContent=Math.floor(pct*100)+'%';
    if(pct>=1)completeSelfRun();
  }
  // Act run
  if(G.actRun){
    G.actRun.elapsed+=200;const pct=Math.min(1,G.actRun.elapsed/(G.actRun.act.time*1000));
    const f=document.getElementById('apf-'+G.actRun.act.id);if(f)f.style.width=(pct*100)+'%';
    const l=document.getElementById('apct-'+G.actRun.act.id);if(l)l.textContent=Math.floor(pct*100)+'%';
    if(pct>=1)completeAct();
  }
  // Workers
  let wch=false;
  G.workers.forEach(w=>{
    if(w.status==='running'||w.status==='exp'){
      w.elapsed+=200;
      const tier=w.status==='exp'?w.expTiers[w.expIdx]:w.curMap;
      const md=w.isGrd&&w.curMapKey?getMd(w.curMapKey):(MAP_TIERS[tier-1]||MAP_TIERS[15]);
      const spd=w.cls==='ranger'?1.25:1;
      w.prog=Math.min(1,w.elapsed/(md.time*1000/spd));
      if(w.prog>=1){if(w.status==='running')resolveWorker(w,md);else resolveExpStep(w);wch=true;}
    }else if(w.status==='injured'){
      const hd=Math.max(5000,(10+(w.curMap||1)*2)*1000*(1-G.ups.heal*.2));
      if(G.gt-w.injuredAt>=hd){w.status='idle';log('üíä '+w.name+' –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è!','info');wch=true;}
    }
    const wp=document.getElementById('wp-'+w.id);if(wp)wp.style.width=(w.prog*100)+'%';
    if(w.status==='injured'){
      const hp=document.getElementById('hp-'+w.id);
      if(hp){const hd=Math.max(5000,(10+(w.curMap||1)*2)*1000*(1-G.ups.heal*.2));hp.style.width=(Math.min(1,(G.gt-w.injuredAt)/hd)*100)+'%';}
    }
  });
  if(wch)renderWorkers();
  updateRes();updateStats();updateSelfStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){updateAchBadge();renderMaps();renderShop();renderInv();renderActs();renderWorkers();renderUpgrades();renderAtlasBar();renderAtlasTab();renderAchs();updateRes();updateStats();updateSelfStats();}

function renderMaps(){
  const el=document.getElementById('tab-maps');if(!el)return;
  const allKeys=Object.keys(G.maps).filter(k=>G.maps[k]>0);
  if(!allKeys.length){el.innerHTML='<div class="dim" style="text-align:center;padding:14px;font-style:italic">–ù–µ—Ç –∫–∞—Ä—Ç.<br>–ö—É–ø–∏—Ç–µ –≤ –ª–∞–≤–∫–µ –∏–ª–∏ –ø—Ä–æ–π–¥–∏—Ç–µ –∞–∫—Ç—ã!</div>';return;}
  const power=sDmg()+sSurv();
  const normal=allKeys.filter(k=>!isNaN(k)).map(Number).sort((a,b)=>a-b);
  const cursed=allKeys.filter(k=>String(k).startsWith('c')).map(k=>parseInt(k.slice(1))).sort((a,b)=>a-b);
  const uniqs=allKeys.filter(k=>String(k).startsWith('u')).map(k=>parseInt(k.slice(1))).sort((a,b)=>a-b);
  const grdKeys=Object.keys(G.maps).filter(k=>k.startsWith('grd_')&&G.maps[k]>0);
  // Boss portal cards
  const bossCards=BOSSES.filter(b=>{
    const isAltB=b.id==='exarch'||b.id==='eater';
    if(isAltB) return G.pendingBoss===b.id||(G.bossTriesLeft>0&&G.activeBossId===b.id)||(G.bossKills[b.id]||0)>0;
    // shaper: show if have any fragments, ever attempted, or ever killed
    const pieces=G.guardianPieces.shaper||0;
    return pieces>0||(G.bossAttempts[b.id]||0)>0||(G.bossKills[b.id]||0)>0;
  }).map(b=>({t:17,k:'boss_'+b.id,type:'boss'}));
  const items=[
    ...normal.map(t=>({t,k:String(t),type:'normal'})),
    ...cursed.map(t=>({t,k:'c'+t,type:'cursed'})),
    ...uniqs.map(t=>({t,k:'u'+t,type:'uniq'})),
    ...grdKeys.map(k=>({t:16,k,type:'guardian'})),
    ...bossCards,
  ];
  let html='';
  items.forEach(({t,k,type})=>{
    // Boss card rendering
    if(type==='boss'){
      const bid=k.slice(5);const b=BOSSES.find(x=>x.id===bid);if(!b)return;
      const isAlt=bid==='exarch'||bid==='eater';
      const pieces=isAlt?0:(G.guardianPieces.shaper||0);const maxP=isAlt?0:4;
      const hasTries=G.bossTriesLeft>0&&G.activeBossId===bid;
      // Ready if has fragments OR has remaining tries (for any boss type)
      const ready=hasTries||(isAlt?(G.pendingBoss===bid):(pieces>=maxP));
      const isSel=String(G.selMap)===k;
      html+='<div class="mcard '+(isSel?'sel':'')+'" style="border-color:'+(ready?'#0088cc':'#335566')+';cursor:'+(ready?'pointer':'default')+'" '+(ready?'data-mapkey="'+k+'"':'')+'>'+
        '<div class="mtier" style="color:#44aaff">üí†</div>'+
        '<div style="flex:1">'+
          '<div class="mname" style="color:'+(ready?'#44aaff':'#6699bb')+'">'+b.em+' '+b.nm+
            (!ready?' <span style="font-size:10px;color:var(--txt-d)">['+pieces+'/'+maxP+' —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤]</span>':hasTries?' <span style="font-size:10px;color:#ffaa44">['+G.bossTriesLeft+'/6 –ø–æ–ø—ã—Ç–æ–∫]</span>':'')+'</div>'+
          '<div class="mreward">üí∞3000-6000 + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç</div>'+
          (ready?'<div style="font-size:11px;color:#44aaff;margin-top:2px">‚ú® –ü–æ—Ä—Ç–∞–ª –æ—Ç–∫—Ä—ã—Ç!</div>':
                  (isAlt?(
  G.pendingBoss===bid||hasTries
    ?'<div style="font-size:11px;color:#ffaa44;margin-top:2px">‚öîÔ∏è –ü–æ–ø—ã—Ç–æ–∫: '+(G.bossTriesLeft)+'/6</div>'
    :'<div style="margin-top:4px"><div style="font-size:10px;color:var(--txt-d);margin-bottom:2px">'+
      (G.t16RunsSinceBoss||0)+'/28 T16 –∫–∞—Ä—Ç</div>'+
      '<div style="height:3px;background:var(--bg2);border-radius:2px"><div style="height:100%;width:'+
      Math.round(((G.t16RunsSinceBoss||0)/28)*100)+'%;background:#44aaff;border-radius:2px"></div></div></div>'
):'<div style="font-size:11px;color:var(--txt-d);margin-top:2px">–£–±–µ–π—Ç–µ 4 —Å—Ç—Ä–∞–∂–µ–π –Ω–∞ T16</div>'))+
        '</div></div>';
      return;
    }
    if(!(G.maps[k]>0))return;
    if(!(G.maps[k]>0))return;
    const md=MAP_TIERS[t-1];
    const chMod=0;const chTier=md.t+(type==='cursed'?1:0)+(type==='uniq'?1:0);
    const ch=Math.max(.03,calcCh(power,t)+chMod);
    const cc=chcol(ch);
    const sel=String(G.selMap)===k?'sel':'';
    const borderCol=type==='cursed'?'#9944cc':type==='uniq'?'#cc5500':type==='guardian'?'#0088cc':'';
    const badge=type==='cursed'?'<span style="color:#bb44ff;font-size:10px">[–ó–ê–†–ê–ñ.]</span>':
                type==='uniq'?'<span style="color:#e87020;font-size:10px">[–£–ù–ò–ö.]</span>':'';
    const prefix=type==='cursed'?'üíú ':type==='uniq'?'üü† ':type==='guardian'?'üî∑ ':'';  const grdData=type==='guardian'?GUARDIAN_MAPS.find(g=>'grd_'+g.id===k):null;
    const cost=SHOP_COSTS[t]||0;
    html+='<div class="mcard '+sel+'" style="'+(borderCol?'border-color:'+borderCol+';':'')+'" data-mapkey="'+k+'">'+
      '<div class="mtier" style="color:'+tcol(t)+'">'+prefix+'T'+t+'</div>'+
      '<div style="flex:1">'+
        '<div class="mname">'+(type==='guardian'?'üî∑ <span style="color:#44aaff">'+(grdData?grdData.nm:'–ì–≤–∞—Ä–¥–µ–π—Å–∫–∞—è')+'</span> <span style="color:#44aaff;font-size:10px">[–°–¢–†–ê–ñ]</span>':type==='uniq'?(()=>{const ud=G.uniqMapData&&G.uniqMapData[k];return (ud?ud.em:md.em)+' <span style="color:#e87020">'+(ud?ud.nm:md.nm)+'</span>';})():md.em+' '+md.nm)+' '+badge+'</div>'+
        '<div style="font-size:11px;color:var(--txt-d)">üí∞'+(goldMin(md,SHOP_COSTS[md.t]||0))+(goldMax(md,SHOP_COSTS[md.t]||0)>goldMin(md,SHOP_COSTS[md.t]||0)?'-'+goldMax(md,SHOP_COSTS[md.t]||0):'')+' + –ø—Ä–µ–¥–º–µ—Ç—ã</div>'+
        '<div class="mch-wrap"><div class="mch-bg"><div class="mch-fill" style="width:'+(Math.min(1,ch)*100)+'%;background:'+cc+'"></div></div>'+
        '<div class="mch-pct" style="color:'+cc+'">'+Math.round(Math.min(1,ch)*100)+'%</div></div>'+
      '</div>'+
      '<div class="mcnt">'+G.maps[k]+'x</div></div>';
  });
  el.innerHTML=html;
}
function selectMap(key){
  G.selMap=String(key);renderMaps();
  const k=String(key);const isGrdKey=k.startsWith('grd_');
  const md=getMd(k);
  if(!G.selfRun)updateRunVis(md,false,isGrdKey,String(G.selMap||'').startsWith('boss_'));
  updateSelfStats();renderWorkers();
}

function renderShop(){
  const all=[
    {id:'s1', nm:'–ö–∞—Ä—Ç–∞ T1 √ó3',cost:15,  mt:0, fn:()=>{G.maps[1]=(G.maps[1]||0)+3;}},
    {id:'s2', nm:'–ö–∞—Ä—Ç–∞ T2 √ó2',cost:35,  mt:0, fn:()=>{G.maps[2]=(G.maps[2]||0)+2;}},
    {id:'s3', nm:'–ö–∞—Ä—Ç–∞ T3 √ó2',cost:65,  mt:1, fn:()=>{G.maps[3]=(G.maps[3]||0)+2;}},
    {id:'s4', nm:'–ö–∞—Ä—Ç–∞ T4',   cost:100, mt:2, fn:()=>{G.maps[4]=(G.maps[4]||0)+1;}},
    {id:'s5', nm:'–ö–∞—Ä—Ç–∞ T5',   cost:140, mt:3, fn:()=>{G.maps[5]=(G.maps[5]||0)+1;}},
    {id:'s6', nm:'–ö–∞—Ä—Ç–∞ T6',   cost:185, mt:4, fn:()=>{G.maps[6]=(G.maps[6]||0)+1;}},
    {id:'s7', nm:'–ö–∞—Ä—Ç–∞ T7',   cost:240, mt:5, fn:()=>{G.maps[7]=(G.maps[7]||0)+1;}},
    {id:'s8', nm:'–ö–∞—Ä—Ç–∞ T8',   cost:310, mt:6, fn:()=>{G.maps[8]=(G.maps[8]||0)+1;}},
    {id:'s9', nm:'–ö–∞—Ä—Ç–∞ T9',   cost:400, mt:7, fn:()=>{G.maps[9]=(G.maps[9]||0)+1;}},
    {id:'s10',nm:'–ö–∞—Ä—Ç–∞ T10',  cost:510, mt:8, fn:()=>{G.maps[10]=(G.maps[10]||0)+1;}},
    {id:'s11',nm:'–ö–∞—Ä—Ç–∞ T11',  cost:640, mt:9, fn:()=>{G.maps[11]=(G.maps[11]||0)+1;}},
    {id:'s12',nm:'–ö–∞—Ä—Ç–∞ T12',  cost:800, mt:10,fn:()=>{G.maps[12]=(G.maps[12]||0)+1;}},
    {id:'s13',nm:'–ö–∞—Ä—Ç–∞ T13',  cost:990, mt:11,fn:()=>{G.maps[13]=(G.maps[13]||0)+1;}},
    {id:'s14',nm:'–ö–∞—Ä—Ç–∞ T14',  cost:1220,mt:12,fn:()=>{G.maps[14]=(G.maps[14]||0)+1;}},
    {id:'s15',nm:'–ö–∞—Ä—Ç–∞ T15',  cost:1500,mt:13,fn:()=>{G.maps[15]=(G.maps[15]||0)+1;}},
    {id:'s16',nm:'–ö–∞—Ä—Ç–∞ T16',  cost:1850,mt:14,fn:()=>{G.maps[16]=(G.maps[16]||0)+1;}},
  ];
  if(G.clsLocked){
    all.push({id:'respec',nm:'üîÑ –°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞',cost:200,mt:-1,fn:()=>{G.clsLocked=false;log('üîÑ –°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π!','info');showN('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å!','pur');updateSelfStats();}});
  }
  window._shopItems=all;
  const unlocked=all.filter(it=>G.maxTier>=it.mt);
  const locked=all.filter(it=>G.maxTier<it.mt);
  let html=unlocked.map(it=>{
    const n=parseInt(it.id.slice(1));const md=n>=1&&n<=16?MAP_TIERS[n-1]:null;
    const n2=parseInt(it.id.slice(1));const cost2=SHOP_COSTS[n2]||0;
    const desc=md?'üí∞'+(goldMin(md,cost2))+(goldMax(md,cost2)>goldMin(md,cost2)?'‚Äì'+goldMax(md,cost2):'')+' + –ø—Ä–µ–¥–º–µ—Ç—ã':it.nm.includes('–°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞')?'–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å':'';;
    return '<div class="srow"><span style="font-size:16px">'+(md?'üó∫':'üîÑ')+'</span>'+
      '<div class="si"><div class="snm">'+it.nm+'</div><div class="sds">'+desc+'</div></div>'+
      '<div style="text-align:right"><div class="spr">üí∞'+it.cost+'</div>'+
      '<button class="btn btn-sm" style="margin-top:2px" data-shop="'+it.id+'">–ö—É–ø–∏—Ç—å</button></div></div>';
  }).join('');
  if(locked.length){const nx=locked[0];html+='<div class="srow" style="opacity:.4;pointer-events:none"><span>üîí</span><div class="si"><div class="snm">'+nx.nm+'</div><div class="sds">–ü–æ—Å–ª–µ T'+(nx.mt+1)+'</div></div><div class="spr">üí∞'+nx.cost+'</div></div>';}
  document.getElementById('tab-shop').innerHTML=html;
}
function buyShop(id){
  const it=window._shopItems.find(x=>x.id===id);if(!it)return;
  if(G.gold<it.cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!');return;}
  G.gold-=it.cost;it.fn();
  log('üõí –ö—É–ø–ª–µ–Ω–æ: '+it.nm,'info');updateRes();renderMaps();renderShop();
}

function renderInv(){
  const el=document.getElementById('tab-inv');if(!el)return;
  if(!G.inv.length){el.innerHTML='<div class="dim" style="text-align:center;padding:14px;font-style:italic">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>';return;}
  const ns=G.inv.filter(x=>x.quality==='normal');
  const ms=G.inv.filter(x=>x.quality==='magic');
  const rs=G.inv.filter(x=>x.quality==='rare');
  const hasSell=ns.length||ms.length||rs.length;
  let html=hasSell?'<div style="display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap">':'';
  if(ns.length)html+='<button class="btn btn-sm" style="flex:1;min-width:80px;border-color:var(--brd);color:var(--txt)" id="btn-sell-all">–û–±—ã—á–Ω—ã–µ: '+ns.length+' —à—Ç ‚Äì '+ns.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0)+'üí∞</button>';
  if(ms.length)html+='<button class="btn btn-sm btn-p" style="flex:1;min-width:80px" id="btn-sell-magic">–í–æ–ª—à–µ–±–Ω—ã–µ: '+ms.length+' —à—Ç ‚Äì '+ms.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0)+'üí∞</button>';
  if(rs.length)html+='<button class="btn btn-sm" style="flex:1;min-width:80px;border-color:var(--gold);color:var(--gold)" id="btn-sell-rare">–†–µ–¥–∫–∏–µ: '+rs.length+' —à—Ç ‚Äì '+rs.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0)+'üí∞</button>';
  if(hasSell)html+='</div>';
  html+='<div class="igrid">'+
    G.inv.map(it=>'<div class="iico '+it.quality[0]+'" style="border-color:'+qcol(it.quality)+'77" data-iid="'+it.id+'" data-tip="'+it.id+'">'+it.em+
      '<span class="isp" style="font-size:12px;color:'+qcol(it.quality)+'">'+it.sellPrice+'üí∞</span></div>').join('')+
    '</div>';
  el.innerHTML=html;updateRes();
}

function renderActs(){
  document.getElementById('tab-acts').innerHTML=
    '<div class="dim" style="font-size:12px;margin-bottom:7px">üèï –ü—Ä–æ–π–¥–∏—Ç–µ –∞–∫—Ç—ã —á—Ç–æ–±—ã <b style="color:var(--gold)">–Ω–∞–±—Ä–∞—Ç—å —É—Ä–æ–≤–Ω–∏</b> –ø–µ—Ä–µ–¥ –∫–∞—Ä—Ç–∞–º–∏!<br>–ö–∞–∂–¥—ã–π –∞–∫—Ç –¥–∞—ë—Ç –æ–ø—ã—Ç –∏ –Ω–µ–º–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞.</div>'+
    ACTS.map(a=>'<div class="act-card"><span style="font-size:17px">'+a.em+'</span>'+
      '<div style="flex:1"><div style="font-size:13px;color:var(--txt-b)">'+a.nm+'</div>'+
      '<div class="tiny">üí∞'+a.g[0]+'‚Äì'+a.g[1]+' ¬∑ ‚è±'+a.time+'—Å</div>'+
      '<div class="act-pg"><div class="act-pgf" id="apf-'+a.id+'" style="width:0%"></div></div>'+
      '<div style="font-size:11px" id="apct-'+a.id+'"></div></div>'+
      '<button class="btn btn-sm btn-g" id="abtn-'+a.id+'" data-act="'+a.id+'">‚ñ∂ –ò–¥—Ç–∏</button></div>').join('');
}

function renderWorkers(){
  const el=document.getElementById('workers-list');if(!el)return;
  if(!G.workers.length){el.innerHTML='<div class="dim" style="text-align:center;padding:8px;font-style:italic">–ù–∞–π–º–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞!</div>';return;}
  const maxS=1+G.ups.slots;
  const running=G.workers.filter(x=>x.status==='running'||x.status==='exp').length;
  el.innerHTML=G.workers.map(w=>{
    const cls=WCLS[w.cls];
    const xpp=w.level>=WLVLS.length-1?1:Math.min(1,Math.max(0,(w.xp-WLVLS[w.level])/(WLVLS[w.level+1]-WLVLS[w.level])));
    const selTier=G.selMap?parseMapKey(G.selMap):null;
    const ch=selTier?calcCh(w.dmg+w.surv,selTier):null;const cc=ch?chcol(ch):'';
    let sEl='',aEl='';
    if(w.status==='idle'){
      sEl='<span class="wst st-idle">–û–ñ–ò–î–ê–ï–¢</span>';
      const hasM=!!(G.selMap&&G.maps[String(G.selMap)]>0);
      const hasS=running<maxS;
      const disReason=!hasM?'–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É':!hasS?'–ù—É–∂–µ–Ω –∞–ø–≥—Ä–µ–π–¥ –ú–∞—à–∏–Ω—ã –¥–ª—è –¥–æ–ø. —Å–ª–æ—Ç–∞':'';
      aEl='<button class="btn btn-sm" data-send="'+w.id+'"'+(hasM&&hasS?'':' disabled title="'+disReason+'"')+'>‚ñ∂</button>';
    }else if(w.status==='running'){
      sEl='<span class="wst st-run">'+(w.cursed?'üíú':w.uniq?'üü†':'')+'T'+w.curMap+'</span>';
      aEl='<div class="prog-bar" style="width:60px;height:4px"><div class="prog-fill" id="wp-'+w.id+'" style="width:'+(w.prog*100)+'%"></div></div>';
    }else if(w.status==='exp'){
      const et=w.expTiers&&w.expTiers[w.expIdx];
      sEl='<span class="wst st-exp">–≠–ö–° T'+et+'</span>';
      aEl='<div class="prog-bar" style="width:60px;height:4px"><div class="prog-fill purple" id="wp-'+w.id+'" style="width:'+(w.prog*100)+'%"></div></div>';
    }else if(w.status==='captured'){
      const cost=Math.floor((30+(w.curMap||1)*12)*(1-G.ups.rescue*.15));
      sEl='<span class="wst st-cap">‚õì –ü–õ–ï–ù</span>';
      aEl='<button class="btn btn-sm btn-r" data-rescue="'+w.id+'">üîì'+cost+'üí∞</button>';
    }else if(w.status==='injured'){
      sEl='<span class="wst st-inj">üíî –õ–ï–ß–ò–¢–°–Ø</span>';
      aEl='<div class="prog-bar" style="width:60px;height:4px"><div class="prog-fill red" id="hp-'+w.id+'" style="width:0%"></div></div>';
    }
    return '<div class="wslot">'+
      '<div class="wavat" style="border-color:'+cls.col+'">'+cls.em+'</div>'+
      '<div class="winfo">'+
        '<div class="wname">'+w.name+' <span class="lvl-b">–£—Ä.'+w.level+'</span></div>'+
        '<div class="wcls">'+cls.nm.toUpperCase()+'</div>'+
        '<div class="tiny">‚öîÔ∏è'+w.dmg+' üõ°'+w.surv+(ch?' ¬∑ <span style="color:'+cc+'">'+Math.round(ch*100)+'% T'+(selTier||'')+'</span>':'')+'</div>'+
        '<div class="wxp"><div class="wxp-f" style="width:'+(xpp*100)+'%"></div></div>'+
      '</div>'+
      '<div style="display:flex;flex-direction:column;gap:3px;align-items:flex-end">'+
        sEl+
        '<div style="display:flex;gap:3px">'+aEl+'<button class="btn btn-sm" data-weq="'+w.id+'">üéí</button></div>'+
      '</div></div>';
  }).join('');
}

function renderUpgrades(){
  const defs=[
    {id:'slots', nm:'‚öô –°–ª–æ—Ç –º–∞—à–∏–Ω—ã',  max:4,desc:()=>'–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: '+(1+G.ups.slots)+' —Ä–∞–±–æ—Ç.', cost:()=>Math.floor(200*Math.pow(2.2,G.ups.slots))},
    {id:'rescue',nm:'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—â–∏–∫',max:3,desc:()=>'–°–∫–∏–¥–∫–∞ –≤—ã–∫—É–ø–∞: '+(G.ups.rescue*15)+'%',    cost:()=>Math.floor(250*Math.pow(2,G.ups.rescue))},
    {id:'heal',  nm:'üíä –õ–∞–∑–∞—Ä–µ—Ç',     max:3,desc:()=>'–õ–µ—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ: '+(G.ups.heal*20)+'%',    cost:()=>Math.floor(220*Math.pow(2,G.ups.heal))},
  ];
  window._upsDefs=defs;
  let html=defs.map(u=>{
    const lvl=G.ups[u.id],maxed=lvl>=u.max,cost=u.cost();
    return '<div class="srow"><div style="flex:1"><div class="snm">'+u.nm+'</div><div class="sds">'+u.desc()+'</div>'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:3px">'+
      (maxed?'<span class="gt" style="font-size:11px">‚úì MAX</span>':
       '<span class="spr">üí∞'+cost+'</span><button class="btn btn-sm" data-up="'+u.id+'">–£–ª—É—á—à–∏—Ç—å</button>')+
      '</div></div></div>';
  }).join('');
  // Boss is now shown in the Maps tab as a card
  if(canPrestige())html+=
    '<div style="margin-top:8px;padding:8px;border:1px solid #553388;background:rgba(85,51,136,.15);text-align:center">'+
    '<div style="font-family:Cinzel,serif;color:#ffaa00;font-size:12px;margin-bottom:6px">‚ú® –í–´ –ü–†–û–®–õ–ò –í–°–ï 16 –¢–ò–†–û–í!</div>'+
    '<button class="btn btn-p" id="btn-prestige">‚ú® –í–æ–∑–≤—ã—à–µ–Ω–∏–µ ‚Äî —Å–±—Ä–æ—Å —Å –±–æ–Ω—É—Å–æ–º</button></div>';
  document.getElementById('upgrades').innerHTML=html;
  // Sync atlas bar prestige button
  renderAtlasBar();
}

function renderAtlasBar(){
  const ct=document.getElementById('pt-tiers');if(!ct)return;
  ct.innerHTML=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].map(t=>'<div class="pt-t '+(G.cleared[t]?'done':'')+'" title="T'+t+' '+MAP_TIERS[t-1].nm+'">'+t+'</div>').join('');
  const hint=document.getElementById('pt-hint');if(!hint)return;
  const cl=Object.keys(G.cleared).length;
  if(G.prestige>0)hint.innerHTML='–í–æ–∑–≤—ã—à–µ–Ω–∏–µ '+G.prestige+' ¬∑ +'+G.prestigeBonus+'% –∑–æ–ª–æ—Ç–∞';
  else if(canPrestige())hint.innerHTML='<span style="color:#ffaa00;font-weight:bold">‚ú® –ê—Ç–ª–∞—Å –∑–∞–≤–µ—Ä—à—ë–Ω!</span> <button class="btn btn-sm btn-p" id="btn-prestige-bar" style="margin-left:6px">‚ú® –í–æ–∑–≤—ã—à–µ–Ω–∏–µ</button>';
  else hint.textContent='–¢–∏—Ä–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: '+cl+'/16';
  const rip=document.getElementById('ri-pres');if(rip)rip.style.display=G.prestige>0?'flex':'none';
  const rpp=document.getElementById('r-pres');if(rpp)rpp.textContent=G.prestige;
}
function renderAtlasTab(){
  const el=document.getElementById('tab-atlas');if(!el)return;
  let html='<div style="font-size:12px;color:var(--txt-d);margin-bottom:8px">–ó–µ–ª—ë–Ω—ã–π = –ø—Ä–æ–π–¥–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 16 –¥–ª—è –í–æ–∑–≤—ã—à–µ–Ω–∏–µ–∞.</div><div id="atlas-grid">';
  for(let t=1;t<=16;t++){
    const md=MAP_TIERS[t-1];const done=!!G.cleared[t];
    const runs=(G.stats.tierRuns&&G.stats.tierRuns[t])||0;
    html+='<div class="at-cell '+(done?'done':'locked')+'">'+
      '<div style="font-size:20px">'+md.em+'</div>'+
      '<div style="font-family:Cinzel,serif;font-size:9px;margin-top:2px">T'+t+'</div>'+
      '<div style="font-size:9px;color:var(--txt-d)">'+md.nm.slice(0,10)+'</div>'+
      (done?'<div style="color:var(--grn);font-size:10px">‚úì '+runs+'x</div>':'<div style="font-size:10px">‚Äî</div>')+
    '</div>';
  }
  html+='</div>';
  // Guardians section
  html+='<div style="margin-top:12px;font-family:Cinzel,serif;font-size:11px;color:var(--gold-d);margin-bottom:6px;letter-spacing:2px">üî∑ –°–¢–†–ê–ñ–ò</div>';
  GUARDIAN_MAPS.forEach(gm=>{
    const key='grd_'+gm.id;const runs=G.stats.tierRuns&&G.stats.tierRuns[key]||0;
    const killed=(G.guardianPieces&&G.guardianPieces.shaper)||0;
    html+='<div style="display:flex;align-items:center;gap:8px;padding:5px 8px;background:var(--bg4);border:1px solid var(--brd);margin-bottom:3px">'+
      '<span style="font-size:18px">'+gm.em+'</span>'+
      '<div style="flex:1"><div style="font-size:13px">'+gm.nm+'</div>'+
      '<div style="font-size:11px;color:var(--txt-d)">'+gm.boss+'</div></div>'+
      '<div style="text-align:right;font-size:11px;color:var(--txt-d)">'+(G.maps[key]>0?'<span style="color:#44aaff">'+G.maps[key]+'x –≤ –Ω–∞–ª–∏—á–∏–∏</span>':'–Ω–µ—Ç')+'</div></div>';
  });
  const bk=G.bossKills&&G.bossKills.shaper||0;
  if(bk>0)html+='<div style="margin-top:8px;padding:8px;background:rgba(0,80,140,.15);border:1px solid #335566;font-size:13px;color:#44aaff">üí† –°–æ–∑–¥–∞—Ç–µ–ª—å –ø–æ–≤–µ—Ä–∂–µ–Ω: <b>'+bk+'x</b></div>';
  html+='</div>';el.innerHTML=html;
}
function renderAchs(){
  const el=document.getElementById('tab-ach');if(!el)return;
  el.innerHTML=ACHDEFS.map(a=>{
    const done=!!G.achs[a.id];
    const pending=!done&&G.achsPending&&G.achsPending[a.id];
    return '<div class="ach-row '+(done?'done':pending?'pending':'')+'">'+
      '<div class="ach-ico">'+(done?a.ico:pending?'üéÅ':'üîí')+'</div>'+
      '<div style="flex:1"><div class="ach-nm">'+a.nm+'</div>'+
      '<div class="ach-ds">'+a.ds+'</div>'+
      '<div class="ach-rw">'+a.rw+'</div></div>'+
      (done?'<span class="gt" style="font-size:16px">‚úì</span>':
       pending?'<button class="btn btn-sm btn-g" data-claim-ach="'+a.id+'">–ó–∞–±—Ä–∞—Ç—å!</button>':'')+'</div>';
  }).join('');
}

function updateAchBadge(){
  const cnt=G.achsPending?Object.keys(G.achsPending).filter(k=>!G.achs[k]).length:0;
  // Highlight tab button
  document.querySelectorAll('.tab-btn').forEach(b=>{
    if(b.dataset.tab==='ach'){
      b.innerHTML=cnt>0?'üèÜ –ê–†–•–ò–í <span style="background:#aa6600;color:#fff;border-radius:50%;padding:0 4px;font-size:9px;margin-left:2px">'+cnt+'</span>':'üèÜ –ê–†–•–ò–í';
    }
  });
}
function claimAch(id){
  if(!G.achsPending||!G.achsPending[id]||G.achs[id])return;
  G.achs[id]=true;delete G.achsPending[id];
  const a=ACHDEFS.find(x=>x.id===id);
  if(!a)return;
  const rwMatch=a.rw.match(/\+?(\d+)/);const rewardGold=rwMatch?parseInt(rwMatch[1]):0;
  if(rewardGold>0){G.gold+=rewardGold;floatT('+'+rewardGold+'üí∞','#f0d080');}
  log('üèÜ '+a.nm+' ‚Äî –ø–æ–ª—É—á–µ–Ω–æ! '+a.rw,'info');showN(''+a.nm+' '+a.rw,'pur');
  updateAchBadge();renderAchs();updateRes();
}
function updateRes(){
  const tm=Object.keys(G.maps).reduce((s,k)=>s+(G.maps[k]||0),0);
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  if(isNaN(G.gold))G.gold=0;  set('r-gold',fN(G.gold));set('r-maps',tm);set('r-items',G.inv.length);set('r-workers',G.workers.length);set('r-runs',G.totalRuns);
}
function updateStats(){
  const el=document.getElementById('stats-p');if(!el)return;
  el.innerHTML=
    '<div>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span class="gt">'+fN(G.stats.ge)+'</span></div>'+
    '<div>üíé –ü—Ä–æ–¥–∞–Ω–æ: <span class="gt">'+G.stats.sold+'—à—Ç ('+fN(G.stats.sg)+'üí∞)</span></div>'+
    '<div>üó∫ –ö–∞—Ä—Ç –ø—Ä–æ–π–¥–µ–Ω–æ: <span class="gt">'+G.stats.mr+'</span></div>'+
    '<div>üèï –ê–∫—Ç–æ–≤: <span class="gt">'+G.stats.ar+'</span></div>'+
    '<div>‚öîÔ∏è –ü—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: <span class="gt">'+G.stats.fi+'</span></div>'+
    '<div>‚õì –ó–∞—Ö–≤–∞—á–µ–Ω–æ: <span style="color:var(--red)">'+G.stats.cap+'</span></div>'+
    '<div>üíî –†–∞–Ω–µ–Ω–∏–π: <span style="color:var(--org)">'+G.stats.inj+'</span></div>'+
    (G.prestige?'<div>‚ú® –í–æ–∑–≤—ã—à–µ–Ω–∏–µ: <span style="color:#ffaa00">'+G.prestige+'x (+'+G.prestigeBonus+'%üí∞)</span></div>':'')+
    (G.bossKills.shaper?'<div>üí† –°–æ–∑–¥–∞—Ç–µ–ª—å —É–±–∏—Ç: <span style="color:#44aaff">'+G.bossKills.shaper+'x</span></div>':'')+
    '<div>üî∑ –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –°–æ–∑–¥–∞—Ç–µ–ª—è: <span style="color:#44aaff">'+(G.guardianPieces.shaper||0)+'/4</span></div>';
}
function updateSelfStats(){
  if(!document.getElementById('s-dmg'))return; // after reset DOM may be replaced
  const d=sDmg(),s=sSurv();
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('s-dmg',d);set('s-surv',s);set('s-lvl',G.selfLevel);
  // XP bar
  const xpBar=document.getElementById('s-xp-bar');
  const xpTxt=document.getElementById('s-lvl-xp');
  const mx=WLVLS.length-1;
  const dispLvl=G.selfPendingLevel||G.selfLevel;
  if(dispLvl>=mx){if(xpBar)xpBar.style.width='100%';if(xpTxt)xpTxt.textContent='MAX';}
  else{const xpPct=Math.min(1,(G.selfXp-WLVLS[dispLvl])/(WLVLS[dispLvl+1]-WLVLS[dispLvl]));if(xpBar)xpBar.style.width=(xpPct*100)+'%';if(xpTxt)xpTxt.textContent=(WLVLS[dispLvl+1]-G.selfXp)+' –¥–æ –£—Ä.'+(dispLvl+1);}
  // Level up button
  const lvlBtn=document.getElementById('btn-self-lvlup');
  if(lvlBtn){lvlBtn.style.display=G.selfLevelUp?'inline-block':'none';if(G.selfLevelUp)lvlBtn.textContent='–ü–æ–≤—ã—Å–∏—Ç—å';}
  // Class buttons
  // Show noble class if prestige unlocked
  const nb=document.getElementById('cls-noble');
  if(nb)nb.style.display=G.prestige>0?'inline-block':'none';
  ['warrior','mage','ranger','noble'].forEach(cl=>{
    const b=document.getElementById('cls-'+cl);if(!b)return;
    const active=cl===(G.selfCls||'warrior');
    b.style.borderColor=active?'var(--gold)':'var(--gold-d)';
    b.disabled=G.clsLocked&&!active;
    b.title=G.clsLocked&&!active?'–ö–ª–∞—Å—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –°–º–µ–Ω–∏—Ç–µ –≤ –õ–∞–≤–∫–µ –∑–∞ 200üí∞':'';
  });
  const ec=document.getElementById('s-ch');
  if(ec){
    if(G.selMap){
      const k=String(G.selMap);
      const t=parseMapKey(k);
      const isC=k.startsWith('c');const isU=k.startsWith('u');const isG=k.startsWith('grd_');
      const isB=k.startsWith('boss_');
      const effT=t+(isC?1:0)+(isU?1:0);
      const mod=isG?-.15:isB?-.05:0;
      let ch;
      if(isB){const bD=BOSSES.find(b=>'boss_'+b.id===k);const bDgr=bD?bD.dgr:1800;const bCap=bD&&bD.id==='shaper'?0.70:0.80;const raw=((d+s)/bDgr-0.2)/0.7;ch=Math.max(.03,Math.min(bCap,raw)+mod);}
      else ch=Math.max(.03,calcCh(d+s,Math.min(16,effT))+mod);
      ec.innerHTML='<span style="color:'+chcol(ch)+'">'+(isG?'üî∑ ':'')+Math.round(ch*100)+'% '+(isG?'[–°—Ç—Ä–∞–∂]':'T'+t)+'</span>';
    }else ec.textContent='‚Äî (–Ω–µ—Ç –∫–∞—Ä—Ç—ã)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openM(title,html){
  document.getElementById('mtl').textContent=title;
  document.getElementById('mbd').innerHTML=html;
  document.getElementById('moverlay').classList.add('on');
}
function closeM(){document.getElementById('moverlay').classList.remove('on');}

function openHire(){
  const cost=80+G.workers.length*60;
  let html='<div class="dim" style="margin-bottom:8px;font-size:13px">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="gt">'+cost+'üí∞</span></div>';
  Object.entries(WCLS).filter(([cls])=>cls!=='noble').forEach(([cls,c])=>{
    html+='<div class="srow" style="margin-bottom:4px">'+
      '<div class="wavat" style="border-color:'+c.col+'">'+c.em+'</div>'+
      '<div class="si"><div class="snm">'+c.nm+'</div><div class="sds">'+c.desc+'</div></div>'+
      '<button class="btn btn-sm" data-hire="'+cls+'">–ù–∞–Ω—è—Ç—å</button></div>';
  });
  html+='<button class="btn btn-r btn-sm" id="btn-close-m" style="margin-top:6px">–û—Ç–º–µ–Ω–∞</button>';
  openM('–ù–∞–Ω—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞',html);
}
function hireWorker(cls){
  const cost=80+G.workers.length*60;
  if(G.gold<cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ '+cost+'üí∞');return;}
  G.gold-=cost;
  const name=WNAMES[Math.floor(Math.random()*WNAMES.length)];
  const w={id:++G.wid,name,cls,status:'idle',curMap:1,cursed:false,uniq:false,elapsed:0,prog:0,runsCompleted:0,
    capturedAt:0,injuredAt:0,xp:0,level:0,expTiers:[],expIdx:0,
    eq:{weapon:null,armor:null,helmet:null,ring:null},dmg:5,surv:5};
  recalcW(w);G.workers.push(w);
  log('üë§ –ù–∞–Ω—è—Ç: '+name+' ('+WCLS[cls].nm+')','info');
  checkAchs();closeM();renderWorkers();updateRes();
}

function openWorkerEq(id){
  const w=G.workers.find(x=>x.id===id);if(!w)return;
  const xpnm=w.level<WLVLS.length-1?((WLVLS[w.level+1]-w.xp)+' XP –¥–æ –£—Ä.'+(w.level+1)):'–ú–∞–∫—Å.';
  const selTier=G.selMap?(String(G.selMap).startsWith('c')||String(G.selMap).startsWith('u')?parseInt(String(G.selMap).slice(1)):parseInt(String(G.selMap))):null;
  const ch=selTier?calcCh(w.dmg+w.surv,selTier):null;
  let html='<div style="display:flex;gap:10px;margin-bottom:8px;flex-wrap:wrap;font-size:13px">'+
    '<div>‚öîÔ∏è<span class="gt">'+w.dmg+'</span></div><div>üõ°<span style="color:var(--grn)">'+w.surv+'</span></div>'+
    '<div>‚≠ê–£—Ä.'+w.level+': <span style="color:var(--mag)">'+xpnm+'</span></div>'+
    (ch?'<div>–®–∞–Ω—Å: <span style="color:'+chcol(ch)+'">'+Math.round(ch*100)+'%</span></div>':'')+
    '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px">';
  SLOTS.forEach(sl=>{
    const eq=w.eq[sl];
    html+='<div class="eqsl '+(eq?'filled':'')+'" data-pick-w="'+id+'" data-pick-sl="'+sl+'">'+
      '<span class="eqlbl">'+SLOTNM[sl]+'</span>'+
      (eq?'<span style="color:'+qcol(eq.quality)+';font-size:14px">'+eq.em+' '+eq.name+'</span>'+
          '<span class="tiny">‚öîÔ∏è+'+iDmg(eq,w.cls)+' üõ°+'+iSurv(eq,w.cls)+'</span>':
       '<span class="dim" style="font-size:11px">–ü—É—Å—Ç–æ</span>')+
    '</div>';
  });
  html+='</div><button class="btn btn-r btn-sm" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button>';
  openM(WCLS[w.cls].em+' '+w.name,html);
}
function openSelfEq(){
  const cls=G.selfCls||'warrior';const d=sDmg(),s=sSurv();
  let html='<div style="display:flex;gap:10px;margin-bottom:8px;font-size:13px">'+
    '<div>‚öîÔ∏è<span class="gt">'+d+'</span></div>'+
    '<div>üõ°<span style="color:var(--grn)">'+s+'</span></div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px">';
  SLOTS.forEach(sl=>{
    const eq=G.selfEq[sl];
    html+='<div class="eqsl '+(eq?'filled':'')+'" data-pick-w="0" data-pick-sl="'+sl+'">'+
      '<span class="eqlbl">'+SLOTNM[sl]+'</span>'+
      (eq?'<span style="color:'+qcol(eq.quality)+';font-size:14px">'+eq.em+' '+eq.name+'</span>'+
          '<span class="tiny">‚öîÔ∏è+'+iDmg(eq,cls)+' üõ°+'+iSurv(eq,cls)+'</span>':
       '<span class="dim" style="font-size:11px">–ü—É—Å—Ç–æ</span>')+
    '</div>';
  });
  html+='</div><button class="btn btn-r btn-sm" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button>';
  openM('üßô –í–∞—à–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ',html);
}
function openSlotPick(ownerId,slot,isWorker){
  const cls=isWorker?(G.workers.find(x=>x.id===ownerId)||{cls:'warrior'}).cls:(G.selfCls||'warrior');
  const owner=isWorker?G.workers.find(x=>x.id===ownerId):null;
  const cur=isWorker?(owner?owner.eq[slot]:null):G.selfEq[slot];
  const compat=G.inv.filter(it=>it.slot===slot);
  let html='';
  if(cur){
    html+='<div class="srow" style="border-color:'+qcol(cur.quality)+'44;margin-bottom:6px">'+
      '<span style="font-size:17px">'+cur.em+'</span>'+
      '<div class="si"><div style="color:'+qcol(cur.quality)+';font-size:13px">'+cur.name+'</div>'+
      '<div class="tiny">‚öîÔ∏è'+iDmg(cur,cls)+' üõ°'+iSurv(cur,cls)+' ¬∑ '+cur.sellPrice+'üí∞</div></div>'+
      '<button class="btn btn-sm btn-r" data-uneq-slot="'+slot+'" data-uneq-owner="'+ownerId+'" data-uneq-isw="'+(isWorker?1:0)+'">–°–Ω—è—Ç—å</button></div>';
  }
  if(!compat.length){html+='<div class="dim" style="padding:8px;font-style:italic">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';}
  else{
    html+=compat.map(it=>{
      const dv=iDmg(it,cls),sv=iSurv(it,cls),cd=cur?iDmg(cur,cls):0,cs=cur?iSurv(cur,cls):0;
      const dd=dv-cd,ds=sv-cs;
      const dds=dd>0?'<span style="color:var(--grn)">+'+dd+'</span>':dd<0?'<span style="color:var(--red)">'+dd+'</span>':'<span class="dim">¬±0</span>';
      const dss=ds>0?'<span style="color:var(--grn)">+'+ds+'</span>':ds<0?'<span style="color:var(--red)">'+ds+'</span>':'<span class="dim">¬±0</span>';
      const co=qcol(it.quality);
      return '<div class="srow" style="cursor:pointer;border-color:'+co+'33" '+
        'data-equip-item="'+it.id+'" data-equip-slot="'+slot+'" data-equip-owner="'+ownerId+'" data-equip-isw="'+(isWorker?1:0)+'" data-tip="'+it.id+'">'+
        '<span style="font-size:17px">'+it.em+'</span>'+
        '<div class="si"><div style="color:'+co+';font-size:13px">'+it.name+'</div>'+
        '<div class="tiny">‚öîÔ∏è'+dv+'('+dds+') üõ°'+sv+'('+dss+') ¬∑ '+it.sellPrice+'üí∞</div></div>'+
        '<button class="btn btn-sm">–ù–∞–¥–µ—Ç—å</button></div>';
    }).join('');
  }
  html+='<div style="margin-top:7px"><button class="btn btn-sm btn-r" data-back-eq="'+ownerId+'" data-back-isw="'+(isWorker?1:0)+'">‚Üê –ù–∞–∑–∞–¥</button></div>';
  openM('–í—ã–±—Ä–∞—Ç—å: '+SLOTNM[slot],html);
}
function doEquip(ownerId,slot,itemId,isWorker){
  const item=G.inv.find(x=>x.id===itemId);if(!item)return;
  if(isWorker){
    const w=G.workers.find(x=>x.id===ownerId);if(!w)return;
    if(w.eq[slot])G.inv.push(w.eq[slot]);w.eq[slot]=item;G.inv=G.inv.filter(x=>x.id!==itemId);
    recalcW(w);log('‚úÖ '+w.name+' –Ω–∞–¥–µ–ª '+item.em+' '+item.name,'info');openWorkerEq(ownerId);
  }else{
    if(G.selfEq[slot])G.inv.push(G.selfEq[slot]);G.selfEq[slot]=item;G.inv=G.inv.filter(x=>x.id!==itemId);
    log('‚úÖ –í—ã –Ω–∞–¥–µ–ª–∏ '+item.em+' '+item.name,'info');openSelfEq();
  }
  renderInv();renderWorkers();renderMaps();updateSelfStats();checkAchs();
}
function doUnequip(ownerId,slot,isWorker){
  if(isWorker){
    const w=G.workers.find(x=>x.id===ownerId);if(!w||!w.eq[slot])return;
    G.inv.push(w.eq[slot]);w.eq[slot]=null;recalcW(w);openWorkerEq(ownerId);
  }else{
    if(!G.selfEq[slot])return;G.inv.push(G.selfEq[slot]);G.selfEq[slot]=null;openSelfEq();
  }
  renderInv();renderWorkers();renderMaps();updateSelfStats();
}
function openItemM(id){
  const it=G.inv.find(x=>x.id===id);if(!it)return;
  openM(it.em+' '+it.name,
    '<div class="tiny" style="margin-bottom:6px">'+qlbl(it.quality).toUpperCase()+' ¬∑ –¢–∏—Ä–∞ '+it.tier+' ¬∑ '+SLOTNM[it.slot]+'</div>'+
    it.mods.map(m=>'<div style="color:var(--mag);padding:2px 0;font-size:14px">+ '+m.value+' '+STATNM[m.stat]+'</div>').join('')+
    '<hr class="sep"><div style="font-size:13px;margin-bottom:6px">–ü—Ä–æ–¥–∞–∂–∞: <span class="gt">'+it.sellPrice+'üí∞</span></div>'+
    '<div style="display:flex;gap:4px">'+
      '<button class="btn btn-sm btn-g" data-sell-id="'+id+'">üí∞ –ü—Ä–æ–¥–∞—Ç—å</button>'+
      '<button class="btn btn-sm btn-r" data-discard-id="'+id+'">üóë –í—ã–±—Ä–æ—Å–∏—Ç—å</button>'+
      '<button class="btn btn-sm btn-r" id="btn-close-m">‚úï</button></div>');
}
function discardItem(id){G.inv=G.inv.filter(x=>x.id!==id);closeM();renderInv();updateRes();}

function openDebug(){
  const sp=sDmg()+sSurv();
  // Average rewards per tier at power=100
  const avgRew=MAP_TIERS.map(m=>{
    const base=(goldMin(m,SHOP_COSTS[m.t]||0)+goldMax(m,SHOP_COSTS[m.t]||0))/2;
    const mult=Math.min(1.6,1+(100*.003));
    return 'T'+m.t+':'+(Math.floor(base*mult));
  }).join(' ');
  const rows=[
    ['version','v0.022'],['gold',G.gold],['totalRuns',G.totalRuns],['prestige',G.prestige],['bonus',G.prestigeBonus+'%'],
    ['selfPower',sp],['chances',[1,3,5,8,10,12,16].map(t=>'T'+t+':'+Math.round(calcCh(sp,t)*100)+'%').join(' ')],
    ['cleared',Object.keys(G.cleared).sort((a,b)=>a-b).join(',')],
    ['maps',Object.keys(G.maps).filter(k=>G.maps[k]>0).map(k=>k+':'+G.maps[k]).join(',')],
    ['workers',G.workers.map(w=>w.name+'('+w.cls+',lvl'+w.level+',‚öî'+w.dmg+',üõ°'+w.surv+','+w.status+')').join('|')],
    ['inv',G.inv.length],['stats',JSON.stringify(G.stats)],['ups',JSON.stringify(G.ups)],
    ['avgRew_p100',avgRew],
    ['dgr',MAP_TIERS.map(m=>'T'+m.t+':'+m.dgr).join(' ')],
    ['achs',Object.keys(G.achs).join(',')],
    ['tierRuns',G.stats.tierRuns?Object.entries(G.stats.tierRuns).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).map(([t,n])=>'T'+t+':'+n).join(' '):'‚Äî'],
  ];
  const dataStr=JSON.stringify(Object.fromEntries(rows),null,2);
  openM('üîß –î–ï–ë–ê–ì',
    '<div id="dbg-out">'+rows.map(([k,v])=>'<div><span style="color:#ffaa44">'+k+':</span> '+JSON.stringify(v)+'</div>').join('')+'</div>'+
    '<div style="margin-top:7px;display:flex;gap:5px">'+
      '<button class="btn btn-sm" id="btn-copy-debug">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>'+
      '<button class="btn btn-sm btn-r" id="btn-close-m">–ó–∞–∫—Ä—ã—Ç—å</button></div>');
  window._debugStr=dataStr;
}

function confirmReset(){
  openM('‚ö†Ô∏è –°–ë–†–û–°',
    '<div style="color:var(--red);margin-bottom:10px;font-size:14px">–í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω.</div>'+
    '<div style="display:flex;gap:6px">'+
      '<button class="btn btn-r" id="btn-do-reset">üíÄ –£–º–µ—Ä–µ—Ç—å –≤ –Ω–∏—â–µ—Ç–µ</button>'+
      '<button class="btn btn-sm" id="btn-close-m">–ù–µ—Ç</button></div>');
}
function doReset(){
  if(window._tickId){clearInterval(window._tickId);window._tickId=null;}
  if(window._saveId){clearInterval(window._saveId);window._saveId=null;}
  try{localStorage.removeItem('kartahodec_save');}catch(e){}
  G=freshG();
  // Hide modal overlay
  const ov=document.getElementById('moverlay');if(ov)ov.classList.remove('on');
  // Replace app
  const app=document.getElementById('app');
  if(!app)return;
  app.innerHTML=
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center;gap:16px">'+
    '<div style="font-size:60px">üíÄ</div>'+
    '<div style="font-family:Cinzel,serif;font-size:28px;color:var(--red);text-shadow:0 0 25px rgba(200,50,50,.6)">–°–ú–ï–†–¢–¨ –í –ù–ò–©–ï–¢–ï</div>'+
    '<div style="color:var(--txt-d);font-style:italic;font-size:18px">–ò–∑–≥–Ω–∞–Ω–Ω–∏–∫ –ø–∞–ª, –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É–≤ –≤–µ–ª–∏—á–∏—è...</div>'+
    '<button class="btn" style="font-size:16px;padding:12px 24px" onclick="location.reload()">‚öî –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button></div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLTIP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTip(e,id){
  const all=[...G.inv,...Object.values(G.selfEq),...G.workers.flatMap(w=>Object.values(w.eq))].filter(Boolean);
  const item=all.find(x=>x&&x.id===id);if(!item)return;
  const c=qcol(item.quality);
  document.getElementById('tt').innerHTML=
    '<div class="tt-nm" style="color:'+c+'">'+item.em+' '+item.name+'</div>'+
    '<div class="tt-ty">'+qlbl(item.quality).toUpperCase()+' ¬∑ –¢'+item.tier+' ¬∑ '+SLOTNM[item.slot]+'</div>'+
    item.mods.map(m=>'<div class="tt-st">+ '+m.value+' '+STATNM[m.stat]+'</div>').join('')+
    '<hr class="tt-dv"><div class="tt-sm">–í–æ–∏–Ω: ‚öîÔ∏è'+iDmg(item,'warrior')+' üõ°'+iSurv(item,'warrior')+'<br>'+
    '–ú–∞–≥: ‚öîÔ∏è'+iDmg(item,'mage')+' üõ°'+iSurv(item,'mage')+'<br>'+
    '–°–ª–µ–¥–æ–ø—ã—Ç: ‚öîÔ∏è'+iDmg(item,'ranger')+' üõ°'+iSurv(item,'ranger')+'</div>'+
    '<div class="tt-sv">üí∞ –ü—Ä–æ–¥–∞–∂–∞: '+item.sellPrice+'üí∞</div>';
  const tt=document.getElementById('tt');tt.style.display='block';
  let x=e.clientX+14,y=e.clientY+14;
  if(x+270>window.innerWidth)x=e.clientX-270;
  if(y+tt.offsetHeight>window.innerHeight)y=e.clientY-tt.offsetHeight-8;
  tt.style.left=x+'px';tt.style.top=y+'px';
}
function hideTip(){const t=document.getElementById('tt');if(t)t.style.display='none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFS & LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showN(msg,type){
  const na=document.getElementById('notif-area');if(!na)return;
  const el=document.createElement('div');el.className='notif'+(type?' '+type:'');el.textContent=msg;
  na.appendChild(el);setTimeout(()=>el.remove(),3200);
}
function log(msg,cls){
  const el=document.getElementById('loot-log');if(!el)return;
  const now=new Date();const t=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const d=document.createElement('div');d.className='le '+(cls||'');
  d.innerHTML='<span class="lt">['+t+']</span>'+msg;el.prepend(d);
  while(el.children.length>120)el.removeChild(el.lastChild);
}
function floatT(txt,color){
  const el=document.createElement('div');el.className='fl';
  el.style.cssText='color:'+color+';left:'+(Math.random()*160+window.innerWidth/2-80)+'px;top:'+(window.innerHeight*.4)+'px';
  el.textContent=txt;document.body.appendChild(el);setTimeout(()=>el.remove(),1300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE / LOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save(){
  try{localStorage.setItem('kartahodec_save',JSON.stringify({
    v:14,gold:G.gold,totalRuns:G.totalRuns,maps:G.maps,inv:G.inv,workers:G.workers,
    ups:G.ups,selfEq:G.selfEq,
    selfCls:G.selfCls,clsLocked:G.clsLocked,selfXp:G.selfXp,selfLevel:G.selfLevel,selfPendingLevel:G.selfPendingLevel,lastExpSlots:G.lastExpSlots,
    stats:G.stats,iid:G.iid,wid:G.wid,
    maxTier:G.maxTier,cleared:G.cleared,achs:G.achs,achsPending:G.achsPending,prestige:G.prestige,prestigeBonus:G.prestigeBonus,
    guardianPieces:G.guardianPieces,bossAttempts:G.bossAttempts,bossKills:G.bossKills,bossTriesLeft:G.bossTriesLeft||0,activeBossId:G.activeBossId||null,t16RunsSinceBoss:G.t16RunsSinceBoss||0,pendingBoss:G.pendingBoss||null,
  }));}catch(e){}
}
function load(){
  try{
    const raw=localStorage.getItem('kartahodec_save');if(!raw)return;
    const s=JSON.parse(raw);
    // Graceful migration ‚Äî never force-wipe saves
if(s.v&&s.v>=9){/* compatible enough */}
    Object.assign(G,s);
    if(!G.cleared)G.cleared={};if(!G.achs)G.achs={};if(!G.achsPending)G.achsPending={};
    if(!G.prestige)G.prestige=0;if(!G.prestigeBonus)G.prestigeBonus=0;
    if(!G.selfCls)G.selfCls=null;if(G.clsLocked===undefined)G.clsLocked=false;if(!G.lastExpSlots)G.lastExpSlots=null;
    if(!G.guardianPieces)G.guardianPieces={shaper:0,elder:0};if(!G.bossAttempts)G.bossAttempts={};if(!G.bossKills)G.bossKills={};if(G.bossTriesLeft===undefined)G.bossTriesLeft=0;if(G.t16RunsSinceBoss===undefined)G.t16RunsSinceBoss=0;if(G.pendingBoss===undefined)G.pendingBoss=null;
    // Restore active tab
    if(G.activeTab){
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===G.activeTab));
      document.querySelectorAll('.tabpanel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+G.activeTab));
    } else if(!G.totalRuns){
      // New player: default to acts
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab==='acts'));
      document.querySelectorAll('.tabpanel').forEach(p=>p.classList.toggle('active',p.id==='tab-acts'));
      G.activeTab='acts';
    }
    if(!G.selfXp)G.selfXp=0;if(!G.selfLevel)G.selfLevel=0;if(G.selfLevelUp===undefined)G.selfLevelUp=false;
    if(G.selfPendingLevel===undefined)G.selfPendingLevel=G.selfLevel;
    G.workers.forEach(w=>{
      if(w.status==='running'||w.status==='exp'){w.status='idle';w.prog=0;w.elapsed=0;}
      if(!w.xp)w.xp=0;if(!w.level)w.level=0;
      if(!w.expTiers)w.expTiers=[];if(!w.expIdx)w.expIdx=0;
      if(w.uniq===undefined)w.uniq=false;
      recalcW(w);
    });
    G.selfRun=null;G.actRun=null;
    log('üíæ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω','info');
  }catch(e){log('‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','ev');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click',function(e){
  const t=e.target;const cl=s=>t.closest?t.closest(s):null;
  hideTip();
  // Tabs
  const tabBtn=cl('.tab-btn');
  if(tabBtn&&tabBtn.dataset.tab){
    const tab=tabBtn.dataset.tab;G.activeTab=tab;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
    const ep=document.getElementById('tab-'+tab);if(ep)ep.classList.add('active');
    tabBtn.classList.add('active');
    if(tab==='inv')renderInv();else if(tab==='acts')renderActs();
    else if(tab==='atlas')renderAtlasTab();else if(tab==='ach')renderAchs();
    return;
  }
  // Map select
  const mc=cl('.mcard');if(mc&&mc.dataset.mapkey){selectMap(mc.dataset.mapkey);return;}
  // Class select (only if not locked, or show message)
  if(t.dataset.cls){
    if(G.clsLocked){showN('–ö–ª–∞—Å—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –°–º–µ–Ω–∏—Ç–µ –≤ –õ–∞–≤–∫–µ –∑–∞ 200üí∞.','red');return;}
    G.selfCls=t.dataset.cls;log('–í—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å: '+WCLS[t.dataset.cls].nm,'info');updateSelfStats();save();return;
  }
  // Self level up
  if(t.id==='btn-self-lvlup'){
    G.selfLevel=G.selfPendingLevel;
    G.selfLevelUp=false;
    const d=sDmg(),s=sSurv();
    log('‚≠ê –£—Ä.'+G.selfLevel+' –ø—Ä–∏–º–µ–Ω—ë–Ω! ‚öîÔ∏è'+d+' üõ°'+s,'info');
    showN('–£—Ä.'+G.selfLevel+'! ‚öîÔ∏è'+d+' üõ°'+s,'pur');
    updateSelfStats();save();return;
  }
  // Fixed buttons
  if(t.id==='btn-self-run'){selfRun();return;}
  if(t.id==='btn-cancel-run'){cancelRun();return;}
  if(t.id==='btn-self-eq'){openSelfEq();return;}
  if(t.id==='btn-hire'){openHire();return;}
  if(t.id==='btn-expedition'){openExpedition();return;}
  if(t.id==='btn-debug'){openDebug();return;}
  if(t.id==='btn-reset'){confirmReset();return;}
  if(t.id==='btn-do-reset'){doReset();return;}
  if(t.id==='btn-close-m'){closeM();return;}
  if(t.id==='btn-sell-all'){sellAllNormal();return;}
  if(t.id==='btn-sell-magic'){
    const ms=G.inv.filter(x=>x.quality==='magic');if(!ms.length){showN('–ù–µ—Ç –≤–æ–ª—à–µ–±–Ω—ã—Ö!');return;}
    const tot=ms.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);G.inv=G.inv.filter(x=>x.quality!=='magic');
    G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=ms.length;
    log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+ms.length+'x –≤–æ–ª—à–µ–±–Ω—ã—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#c8a96e');
    checkAchs();renderInv();updateRes();return;
  }
  if(t.id==='btn-sell-rare'){
    const rs=G.inv.filter(x=>x.quality==='rare');if(!rs.length){showN('–ù–µ—Ç —Ä–µ–¥–∫–∏—Ö!');return;}
    const tot=rs.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);
    openM('‚ö†Ô∏è –ü—Ä–æ–¥–∞—Ç—å —Ä–µ–¥–∫–∏–µ?',
      '<div style="font-size:14px;margin-bottom:12px">–ü—Ä–æ–¥–∞—Ç—å <b style="color:var(--rare)">'+rs.length+'</b> —Ä–µ–¥–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∑–∞ <span class="gt">'+tot+'üí∞</span>?<br>'+
      '<span style="font-size:12px;color:var(--txt-d)">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</span></div>'+
      '<div style="display:flex;gap:6px">'+
        '<button class="btn btn-g" id="btn-confirm-sell-rare">üí∞ –ü—Ä–æ–¥–∞—Ç—å</button>'+
        '<button class="btn btn-r btn-sm" id="btn-close-m">–û—Ç–º–µ–Ω–∞</button></div>');
    window._pendingRareSell=rs;return;
  }
  if(t.id==='btn-confirm-sell-rare'){
    const rs=window._pendingRareSell||[];const tot=rs.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);
    const ids=new Set(rs.map(x=>x.id));G.inv=G.inv.filter(x=>!ids.has(x.id));
    G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=rs.length;
    log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+rs.length+'x —Ä–µ–¥–∫–∏—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#f0d060');
    window._pendingRareSell=null;closeM();checkAchs();renderInv();updateRes();return;
  }
  if(t.id==='btn-sell-magic'){
    const ms=G.inv.filter(x=>x.quality==='magic');if(!ms.length){showN('–ù–µ—Ç –≤–æ–ª—à–µ–±–Ω—ã—Ö!');return;}
    const tot=ms.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);G.inv=G.inv.filter(x=>x.quality!=='magic');
    G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=ms.length;
    log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+ms.length+'x –≤–æ–ª—à–µ–±–Ω—ã—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#c8a96e');
    checkAchs();renderInv();updateRes();return;
  }
  if(t.id==='btn-sell-rare'){
    const rs=G.inv.filter(x=>x.quality==='rare');if(!rs.length){showN('–ù–µ—Ç —Ä–µ–¥–∫–∏—Ö!');return;}
    const tot=rs.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);
    openM('‚ö†Ô∏è –ü—Ä–æ–¥–∞—Ç—å —Ä–µ–¥–∫–∏–µ?',
      '<div style="font-size:14px;margin-bottom:12px">–ü—Ä–æ–¥–∞—Ç—å <b style="color:var(--rare)">'+rs.length+'</b> —Ä–µ–¥–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∑–∞ <span class="gt">'+tot+'üí∞</span>?<br>'+
      '<span style="font-size:12px;color:var(--txt-d)">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</span></div>'+
      '<div style="display:flex;gap:6px">'+
        '<button class="btn btn-g" id="btn-confirm-sell-rare">üí∞ –ü—Ä–æ–¥–∞—Ç—å</button>'+
        '<button class="btn btn-r btn-sm" id="btn-close-m">–û—Ç–º–µ–Ω–∞</button></div>');
    window._pendingRareSell=rs;return;
  }
  if(t.id==='btn-confirm-sell-rare'){
    const rs=window._pendingRareSell||[];const tot=rs.reduce((s,x)=>s+(parseInt(x.sellPrice)||0),0);
    const ids=new Set(rs.map(x=>x.id));G.inv=G.inv.filter(x=>!ids.has(x.id));
    G.gold+=tot;G.stats.sg+=tot;G.stats.sold+=rs.length;
    log('üí∞ –ü—Ä–æ–¥–∞–Ω–æ '+rs.length+'x —Ä–µ–¥–∫–∏—Ö +'+tot+'üí∞','ge');floatT('+'+tot+'üí∞','#f0d060');
    window._pendingRareSell=null;closeM();checkAchs();renderInv();updateRes();return;
  }
  if(t.id==='btn-copy-debug'){try{navigator.clipboard.writeText(window._debugStr||'');}catch(ex){}showN('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');return;}
  // Prestige
  // Boss is now handled via map card click
  if(t.id==='btn-prestige'||t.id==='btn-prestige-bar'){
    openM('‚ú® –í–û–ó–í–´–®–ï–ù–ò–ï',
      '<div style="margin-bottom:12px;font-size:14px">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ 16 —Ç–∏—Ä–æ–≤!<br><br>'+
      '<span class="gt">–ë–æ–Ω—É—Å—ã:</span><br>‚Ä¢ +15% –∑–æ–ª–æ—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞ (—Å—É–º–º–∏—Ä—É–µ—Ç—Å—è)<br>‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 15% —Ç–µ–∫—É—â–µ–≥–æ –∑–æ–ª–æ—Ç–∞<br>‚Ä¢ –ù–∞—á–∏–Ω–∞–µ—Ç–µ —Å T1‚ÄìT3 –∫–∞—Ä—Ç–∞–º–∏<br>‚Ä¢ üÜï –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–ª–∞—Å—Å <span style="color:#e8c020">üë∏ –î–≤–æ—Ä—è–Ω–∫–∞</span><br><br>'+
      '–¢–µ–∫—É—â–∏–π: <span class="gt">'+G.prestige+'</span> ‚Üí <span style="color:#ffaa00">'+(G.prestige+1)+'</span> (+'+((G.prestige+1)*15)+'% –∑–æ–ª–æ—Ç–∞)</div>'+
      '<div style="display:flex;gap:6px">'+
        '<button class="btn btn-p" id="btn-confirm-prestige">‚ú® –í–æ–∑–≤—ã—Å–∏—Ç—å—Å—è!</button>'+
        '<button class="btn btn-sm" id="btn-close-m">–û—Ç–º–µ–Ω–∞</button></div>');
    return;
  }
  if(t.id==='btn-confirm-prestige'){doPrestige();return;}
  // Shop
  if(t.dataset.shop){buyShop(t.dataset.shop);return;}
  // Upgrades
  if(t.dataset.up){
    const costs={slots:()=>Math.floor(200*Math.pow(2.2,G.ups.slots)),rescue:()=>Math.floor(250*Math.pow(2,G.ups.rescue)),heal:()=>Math.floor(220*Math.pow(2,G.ups.heal))};
    const maxes={slots:4,rescue:3,heal:3};const id=t.dataset.up;
    if(!costs[id])return;if(G.ups[id]>=maxes[id]){showN('–ú–∞–∫—Å–∏–º—É–º!');return;}
    const cost=costs[id]();if(G.gold<cost){showN('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!');return;}
    G.gold-=cost;G.ups[id]++;log('‚öô '+id+' ‚Üí –£—Ä.'+G.ups[id],'info');updateRes();renderUpgrades();return;
  }
  // Workers
  const sendEl=t.dataset.send?t:cl('[data-send]');if(sendEl&&sendEl.dataset.send){sendWorker(parseInt(sendEl.dataset.send));return;}
  const rescEl=t.dataset.rescue?t:cl('[data-rescue]');if(rescEl&&rescEl.dataset.rescue){rescueW(parseInt(rescEl.dataset.rescue));return;}
  const weqEl=t.dataset.weq?t:cl('[data-weq]');if(weqEl&&weqEl.dataset.weq){openWorkerEq(parseInt(weqEl.dataset.weq));return;}
  const hireEl=cl('[data-hire]');if(hireEl){hireWorker(hireEl.dataset.hire);return;}
  // Acts
  if(t.dataset.act){startAct(t.dataset.act);return;}
  // Expedition modal
  if(t.dataset.xslot!==undefined){
    if(window._exp){window._exp.pickSlot=parseInt(t.dataset.xslot);window._exp.render();}return;
  }
  if(t.dataset.xslotClear!==undefined){
    if(window._exp){window._exp.slots[parseInt(t.dataset.xslotClear)]=null;window._exp.render();}return;
  }
  if(t.dataset.xpick){
    if(window._exp&&window._exp.pickSlot!==undefined){
      window._exp.slots[window._exp.pickSlot]=parseInt(t.dataset.xpick);
      delete window._exp.pickSlot;window._exp.render();
    }return;
  }
  const xwEl=t.dataset.xworker?t:cl('[data-xworker]');
  if(xwEl&&xwEl.dataset.xworker){if(window._exp){window._exp.wid=parseInt(xwEl.dataset.xworker);window._exp.render();}return;}
  if(t.id==='btn-xgo'){if(window._exp&&window._exp.wid)startExpedition(window._exp.wid);return;}
  // Equipment
  const pickEl=cl('[data-pick-w]');if(pickEl){openSlotPick(parseInt(pickEl.dataset.pickW),pickEl.dataset.pickSl,parseInt(pickEl.dataset.pickW)!==0);return;}
  const eqEl=cl('[data-equip-item]');if(eqEl){doEquip(parseInt(eqEl.dataset.equipOwner),eqEl.dataset.equipSlot,parseInt(eqEl.dataset.equipItem),eqEl.dataset.equipIsw==='1');return;}
  const uqEl=t.dataset.uneqSlot?t:cl('[data-uneq-slot]');if(uqEl&&uqEl.dataset.uneqSlot){doUnequip(parseInt(uqEl.dataset.uneqOwner),uqEl.dataset.uneqSlot,uqEl.dataset.uneqIsw==='1');return;}
  if(t.dataset.backEq!==undefined){if(t.dataset.backIsw==='1')openWorkerEq(parseInt(t.dataset.backEq));else openSelfEq();return;}
  // Inventory
  const claimEl=t.dataset.claimAch?t:cl('[data-claim-ach]');if(claimEl&&claimEl.dataset.claimAch){claimAch(claimEl.dataset.claimAch);return;}
  const iico=cl('[data-iid]');if(iico){openItemM(parseInt(iico.dataset.iid));return;}
  if(t.dataset.sellId){sellItem(parseInt(t.dataset.sellId));return;}
  if(t.dataset.discardId){discardItem(parseInt(t.dataset.discardId));return;}
  if(t.id==='moverlay'||t===document.getElementById('moverlay')){closeM();return;}
});
document.addEventListener('mousemove',function(e){
  const el=e.target.closest?e.target.closest('[data-tip]'):null;
  if(el)showTip(e,parseInt(el.dataset.tip));else hideTip();
});
document.addEventListener('scroll',()=>hideTip(),true);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  load();renderAll();
  window._tickId=setInterval(tick,200);
  window._saveId=setInterval(save,8000);
  log('üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–∞—Ä—Ç–æ—Ö–æ–¥–µ—Ü v0.022','info');
}
init();
</script>
</body>
</html>
